# 47 NIO æœåŠ¡å™¨ï¼ˆä¸‰ï¼‰ä¹‹ Telnet å±‚ #
dubbo-remoting-api æ¨¡å—ï¼Œ telnet åŒ…ï¼ŒTelnet å‘½ä»¤ã€‚

Dubbo æ”¯æŒé€šè¿‡ telnet å‘½ä»¤ï¼Œç”¨æ¥æœåŠ¡æ²»ç†ã€‚å…¶ä¸­ï¼Œclear exit help log status é€šç”¨æŒ‡ä»¤ï¼Œé€šè¿‡ telnet åŒ…å®ç°ã€‚è€Œå…¶å®ƒå‡ ä¸ªæŒ‡ä»¤ï¼Œéœ€è¦ä¸åŒåè®®( Protocol )è‡ªå·±å®ç°ã€‚ç›®å‰ï¼Œä»…æœ‰ Dubbo Protocol å®ç°äº†è‡ªå®šä¹‰æŒ‡ä»¤ã€‚

ä¸»è¦åˆ†æˆä¸‰ç§ä¸é€šçš„ç±»ã€‚

- TelnetCodec ï¼šè´Ÿè´£ç¼–è§£ç  Telnet å‘½ä»¤ä¸ç»“æœã€‚
- TelnetHandlerAdapter ï¼šè´Ÿè´£æ¥æ”¶æ¥è‡ª HeaderExchangeHandler çš„ telnet å‘½ä»¤ï¼Œåˆ†å‘ç»™å¯¹åº”çš„ TelnetHandler å®ç°ç±»ï¼Œè¿›è¡Œå¤„ç†ï¼Œè¿”å›å‘½ä»¤ç»“æœã€‚
- XXXTelnetHandler ï¼šå¤„ç†å¯¹åº”çš„ telnet å‘½ä»¤ï¼Œè¿”å›ç»“æœã€‚

æµç¨‹å¦‚ä¸‹å›¾ï¼š

![](/picture/dubbo-telnet-flow.png)

## 47.1 TelnetCodec ##

com.alibaba.dubbo.remoting.telnet.codec.TelnetCodec ï¼Œå®ç° TransportCodec ç±»ï¼ŒTelnet å‘½ä»¤ç¼–è§£ç å™¨ã€‚

**è§£ç **

//  todo dubboè¿ç»´äº†è§£

----

# 48 NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ #
dubbo-remoting-api æ¨¡å—ï¼Œ exchange åŒ…ï¼Œä¿¡æ¯äº¤æ¢å±‚ã€‚

exchange ä¿¡æ¯äº¤æ¢å±‚ï¼šå°è£…è¯·æ±‚å“åº”æ¨¡å¼ï¼ŒåŒæ­¥è½¬å¼‚æ­¥ï¼Œä»¥ Request, Response ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Exchanger, ExchangeChannel, ExchangeClient, ExchangeServerã€‚

åœ¨ä¸€æ¬¡ RPC è°ƒç”¨ï¼Œæ¯ä¸ªè¯·æ±‚( Request )ï¼Œæ˜¯å…³æ³¨å¯¹åº”çš„å“åº”( Response )ã€‚é‚£ä¹ˆ transport å±‚ æä¾›çš„ç½‘ç»œä¼ è¾“ åŠŸèƒ½ï¼Œæ˜¯æ— æ³•æ»¡è¶³ RPC çš„è¯‰æ±‚çš„ã€‚å› æ­¤ï¼Œexchange å±‚ï¼Œåœ¨å…¶ Message ä¹‹ä¸Šï¼Œæ„é€ äº†Request-Response çš„æ¨¡å‹ã€‚

å®ç°ä¸Šï¼Œä¹Ÿéå¸¸ç®€å•ï¼Œå°† Message åˆ†æˆ Request å’Œ Response ä¸¤ç§ç±»å‹ï¼Œå¹¶å¢åŠ ç¼–å·å±æ€§ï¼Œå°† Request å’Œ Response èƒ½å¤Ÿä¸€ä¸€æ˜ å°„ã€‚

å®é™…ä¸Šï¼ŒRPC è°ƒç”¨ï¼Œä¼šæœ‰æ›´å¤šç‰¹æ€§çš„éœ€æ±‚ï¼š1ï¼‰å¼‚æ­¥å¤„ç†è¿”å›ç»“æœï¼›2ï¼‰å†…ç½®äº‹ä»¶ï¼›3ï¼‰ç­‰ç­‰ã€‚å› æ­¤ï¼ŒRequest å’Œ Response ä¸Šä¼šæœ‰ç±»ä¼¼ç¼–å·çš„ç³»ç»Ÿå­—æ®µã€‚

ä¸€æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬åˆ†æˆä¸¤æ®µï¼š
- åè®®å¤´( Header ) ï¼š ç³»ç»Ÿå­—æ®µï¼Œä¾‹å¦‚ç¼–å·ç­‰ã€‚
- å†…å®¹( Body ) ï¼šå…·ä½“è¯·æ±‚çš„å‚æ•°å’Œå“åº”çš„ç»“æœç­‰ã€‚

dubboå¿ƒè·³æ£€æµ‹ï¼š
dubboå¿ƒè·³æ—¶é—´heartbeaté»˜è®¤æ˜¯60sï¼Œè¶…è¿‡heartbeatæ—¶é—´æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œå°±å‘é€å¿ƒè·³æ¶ˆæ¯(providerï¼Œconsumerä¸€æ ·),å¦‚æœè¿ç€3æ¬¡(heartbeatTimeoutä¸ºheartbeat*3)æ²¡æœ‰æ”¶åˆ°å¿ƒè·³å“åº”ï¼Œproviderä¼šå…³é—­channelï¼Œè€Œconsumerä¼šè¿›è¡Œé‡è¿;ä¸è®ºæ˜¯providerè¿˜æ˜¯consumerçš„å¿ƒè·³æ£€æµ‹éƒ½æ˜¯é€šè¿‡å¯åŠ¨å®šæ—¶ä»»åŠ¡çš„æ–¹å¼å®ç°ï¼›

## 48.1 ExchangeChannel ##

com.alibaba.dubbo.remoting.exchange.ExchangeChannel ï¼Œç»§æ‰¿ Channel æ¥å£ï¼Œä¿¡æ¯äº¤æ¢é€šé“æ¥å£

### 48.1.1 HeaderExchangeChannel ###

com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeChannel ï¼Œå®ç° ExchangeChannel æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢é€šé“å®ç°ç±»ã€‚

#### 48.1.1.1 æ„é€ æ–¹æ³• ####

````
private static final String CHANNEL_KEY = HeaderExchangeChannel.class.getName() + ".CHANNEL";

/** é€šé“ã€‚HeaderExchangeChannel æ˜¯ä¼ å…¥ channel å±æ€§çš„è£…é¥°å™¨ï¼Œæ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨ channel ã€‚ */
private final Channel channel;
/** æ˜¯å¦å…³é—­ */
private volatile boolean closed = false;

HeaderExchangeChannel(Channel channel) {
    if (channel == null) {
        throw new IllegalArgumentException("channel == null");
    }
    this.channel = channel;
}
````

getOrAddChannel(Channel) é™æ€æ–¹æ³•ï¼Œåˆ›å»º HeaderExchangeChannel å¯¹è±¡ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. ä¼ å…¥çš„ ch å±æ€§ï¼Œå®é™…å°±æ˜¯ HeaderExchangeChanel.channel å±æ€§ã€‚
2. é€šè¿‡ ch.attribute çš„ CHANNEL_KEY é”®å€¼ï¼Œä¿è¯æœ‰ä¸”ä»…æœ‰ä¸º ch å±æ€§ï¼Œåˆ›å»ºå”¯ä¸€çš„ HeaderExchangeChannel å¯¹è±¡ã€‚
3. è¦æ±‚å·²è¿æ¥ã€‚

removeChannelIfDisconnected(ch) é™æ€æ–¹æ³•ï¼Œç§»é™¤ HeaderExchangeChannel å¯¹è±¡ã€‚

#### 48.1.1.2 å‘é€è¯·æ±‚ ####

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

1. è‹¥å·²ç»å…³é—­ï¼Œä¸å†å…è®¸å‘èµ·æ–°çš„è¯·æ±‚ã€‚
2. ç¬¬ 6 è‡³ 10 è¡Œï¼šåˆ›å»º Request å¯¹è±¡ã€‚å…¶ä¸­ï¼ŒtwoWay = true éœ€è¦å“åº”ï¼›data = request å…·ä½“æ•°æ®ã€‚
3. åˆ›å»º DefaultFuture å¯¹è±¡ã€‚
4. è°ƒç”¨ Channel#send(req) æ–¹æ³•ï¼Œå‘é€è¯·æ±‚ã€‚
5. å‘ç”Ÿ RemotingException å¼‚å¸¸ï¼Œè°ƒç”¨ DefaultFuture#cancel() æ–¹æ³•ï¼Œå–æ¶ˆã€‚
6. è¿”å› DefaultFuture å¯¹è±¡ã€‚ä»ä»£ç çš„å½¢å¼ä¸Šæ¥è¯´ï¼Œæœ‰ç‚¹ç±»ä¼¼çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œè¿”å› Future å¯¹è±¡ã€‚

#### 48.1.1.3 ä¼˜é›…å…³é—­ ####

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. æ ‡è®° closed = true ï¼Œé¿å…å‘èµ·æ–°çš„è¯·æ±‚ã€‚
2. è°ƒç”¨ DefaultFuture#hasFuture(channel) æ–¹æ³•ï¼Œåˆ¤æ–­å·²å‘èµ·çš„å·²ç»æ˜¯å¦å·²ç»éƒ½å“åº”äº†ã€‚è‹¥å¦ï¼Œç­‰å¾…å®Œæˆæˆ–è¶…æ—¶ã€‚
3. å…³é—­é€šé“ã€‚

## 48.2 ExchangeClient ##
com.alibaba.dubbo.remoting.exchange.ExchangeClient ï¼Œå®ç° Client ï¼ŒExchangeChannel æ¥å£ï¼Œä¿¡æ¯äº¤æ¢å®¢æˆ·ç«¯æ¥å£ã€‚

### 48.2.1 HeaderExchangeClient ###
com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeClient ï¼Œå®ç° ExchangeClient æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢å®¢æˆ·ç«¯å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

````
/** å®šæ—¶å™¨çº¿ç¨‹æ±  */
private static final ScheduledThreadPoolExecutor scheduled = new ScheduledThreadPoolExecutor(2, new NamedThreadFactory("dubbo-remoting-client-heartbeat", true));
/** å®¢æˆ·ç«¯ */
private final Client client;
/** ä¿¡æ¯äº¤æ¢é€šé“ */
private final ExchangeChannel channel;
// heartbeat timer
/** å¿ƒè·³å®šæ—¶å™¨ */
private ScheduledFuture<?> heartbeatTimer;
/** æ˜¯å¦å¿ƒè·³ */
private int heartbeat;
// heartbeat timeout (ms), default value is 0 , won't execute a heartbeat.
/** å¿ƒè·³é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ */
private int heartbeatTimeout;
public HeaderExchangeClient(Client client, boolean needHeartbeat) {
    if (client == null) {
        throw new IllegalArgumentException("client == null");
    }
    this.client = client;
    // åˆ›å»º HeaderExchangeChannel å¯¹è±¡
    this.channel = new HeaderExchangeChannel(client);
    // è¯»å–å¿ƒè·³ç›¸å…³é…ç½®
    String dubbo = client.getUrl().getParameter(Constants.DUBBO_VERSION_KEY);
    this.heartbeat = client.getUrl().getParameter(Constants.HEARTBEAT_KEY, dubbo != null && dubbo.startsWith("1.0.") ? Constants.DEFAULT_HEARTBEAT : 0);
    this.heartbeatTimeout = client.getUrl().getParameter(Constants.HEARTBEAT_TIMEOUT_KEY, heartbeat * 3);
    if (heartbeatTimeout < heartbeat * 2) { // é¿å…é—´éš”å¤ªçŸ­
        throw new IllegalStateException("heartbeatTimeout < heartbeatInterval * 2");
    }
    // å‘èµ·å¿ƒè·³å®šæ—¶å™¨
    if (needHeartbeat) {
        startHeatbeatTimer();
    }
}
````

åŸºæœ¬æµç¨‹å¦‚ä¸‹;
1. ä½¿ç”¨ä¼ å…¥çš„ client å±æ€§ï¼Œåˆ›å»º HeaderExchangeChannel å¯¹è±¡ã€‚
2. è¯»å–å¿ƒè·³ç›¸å…³é…ç½®ã€‚é»˜è®¤ï¼Œå¼€å¯å¿ƒè·³åŠŸèƒ½ã€‚
	1. å¿ƒè·³é—´éš”ï¼Œå¯¹äºé•¿è¿æ¥ï¼Œå½“ç‰©ç†å±‚æ–­å¼€æ—¶ï¼Œæ¯”å¦‚æ‹”ç½‘çº¿ï¼ŒTCPçš„FINæ¶ˆæ¯æ¥ä¸åŠå‘é€ï¼Œå¯¹æ–¹æ”¶ä¸åˆ°æ–­å¼€äº‹ä»¶ï¼Œæ­¤æ—¶éœ€è¦å¿ƒè·³æ¥å¸®åŠ©æ£€æŸ¥è¿æ¥æ˜¯å¦å·²æ–­å¼€
3.  è°ƒç”¨ #startHeatbeatTimer() æ–¹æ³•ï¼Œå‘èµ·å¿ƒè·³å®šæ—¶å™¨ã€‚

## 48.3 ExchangeServer ##

com.alibaba.dubbo.remoting.exchange.ExchangeServer ï¼Œç»§æ‰¿ Server æ¥å£ï¼Œä¿¡æ¯äº¤æ¢æœåŠ¡å™¨æ¥å£

### 48.3.1 HeaderExchangeServer ###
com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeServer ï¼Œå®ç° ExchangeServer æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢æœåŠ¡å™¨å®ç°ç±»ã€‚

- ä»£ç å®ç°ä¸Šï¼Œå’Œ HeaderExchangeChannel + HeaderExchangeClient çš„ç»¼åˆã€‚

#### 48.3.1.1 æ„é€ æ–¹æ³• ####
ä»£ç å®ç°ä¸Šï¼Œå’Œ HeaderExchangeClient çš„ç±»ä¼¼ã€‚

````
/** å®šæ—¶å™¨çº¿ç¨‹æ±  */
private final ScheduledExecutorService scheduled = Executors.newScheduledThreadPool(1, new NamedThreadFactory("dubbo-remoting-server-heartbeat", true));
/** æœåŠ¡å™¨ */
private final Server server;
// heartbeat timer
/** å¿ƒè·³å®šæ—¶å™¨ */
private ScheduledFuture<?> heatbeatTimer;
/** æ˜¯å¦å¿ƒè·³ */
// heartbeat timeout (ms), default value is 0 , won't execute a heartbeat.
private int heartbeat;
/** å¿ƒè·³é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ */
private int heartbeatTimeout;
/** æ˜¯å¦å…³é—­ */
private AtomicBoolean closed = new AtomicBoolean(false);

public HeaderExchangeServer(Server server) {
    if (server == null) {
        throw new IllegalArgumentException("server == null");
    }
    // è¯»å–å¿ƒè·³ç›¸å…³é…ç½®
    this.server = server;
    this.heartbeat = server.getUrl().getParameter(Constants.HEARTBEAT_KEY, 0);
    this.heartbeatTimeout = server.getUrl().getParameter(Constants.HEARTBEAT_TIMEOUT_KEY, heartbeat * 3);
    if (heartbeatTimeout < heartbeat * 2) {
        throw new IllegalStateException("heartbeatTimeout < heartbeatInterval * 2");
    }
    // å‘èµ·å¿ƒè·³å®šæ—¶å™¨
    startHeatbeatTimer();
}
````

#### 48.3.1.2 ä¼˜é›…å…³é—­ ####
Server å…³é—­çš„è¿‡ç¨‹ï¼Œåˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼šæ­£åœ¨å…³é—­å’Œå·²ç»å…³é—­ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ #startClose() æ–¹æ³•ï¼Œæ ‡è®°æ­£åœ¨å…³é—­ã€‚
2. å‘é€ READONLY äº‹ä»¶ç»™æ‰€æœ‰ Client ï¼Œè¡¨ç¤º Server ä¸å†æ¥æ”¶æ–°çš„æ¶ˆæ¯ï¼Œé¿å…ä¸æ–­æœ‰æ–°çš„æ¶ˆæ¯æ¥æ”¶åˆ°ã€‚
	1. å³ä½¿ client å¤„äºè¿æ¥ä¸­ï¼Œä½†æ˜¯ Server å¤„äºæ­£åœ¨å…³é—­ä¸­ï¼Œä¹Ÿç®—ä¸å¯ç”¨ï¼Œä¸è¿›è¡Œå‘é€è¯·æ±‚( æ¶ˆæ¯ )ã€‚
3. sendChannelReadOnlyEvent() æ–¹æ³•ï¼Œå¹¿æ’­å®¢æˆ·ç«¯ï¼ŒREADONLY_EVENT äº‹ä»¶
4. è°ƒç”¨ #oClose() æ–¹æ³•ï¼Œå…³é—­å¿ƒè·³å®šæ—¶å™¨ã€‚
5. çœŸæ­£å…³é—­æœåŠ¡å™¨ã€‚

### 48.3.2 ExchangeServerDelegate ###
com.alibaba.dubbo.remoting.exchange.support.ExchangeServerDelegate ï¼Œå®ç° ExchangeServer æ¥å£ï¼Œä¿¡æ¯äº¤æ¢æœåŠ¡å™¨è£…é¥°è€…ã€‚åœ¨æ¯ä¸ªå®ç°çš„æ–¹æ³•é‡Œï¼Œç›´æ¥è°ƒç”¨è¢«è£…é¥°çš„ server å±æ€§çš„æ–¹æ³•ã€‚

## 48.4 è¯·æ±‚/å“åº”æ¨¡å‹ ##
### 48.4.1 Request ###
com.alibaba.dubbo.remoting.exchange.Request ï¼Œè¯·æ±‚

å†…ç½®ä¸¤ç§äº‹ä»¶ï¼š

- HEARTBEAT_EVENT ï¼šå¿ƒè·³ã€‚å› ä¸ºå¿ƒè·³æ¯”è¾ƒå¸¸ç”¨ï¼Œæ‰€ä»¥åœ¨äº‹ä»¶ä¸Šæ—¶å€™äº† null ã€‚
- READONLY_EVENT ï¼šåªè¯»ã€‚

å±æ€§ï¼š
- mId å±æ€§ï¼šç¼–å·ã€‚ä½¿ç”¨ INVOKE_ID å±æ€§ç”Ÿæˆï¼ŒJVM è¿›ç¨‹å†…å”¯ä¸€ã€‚
- mTwoWay å±æ€§ï¼Œæ ‡è®°è¯·æ±‚æ˜¯å¦å“åº”( Response )ï¼Œé»˜è®¤éœ€è¦ã€‚
- mBroken å±æ€§ï¼Œæ˜¯å¦å¼‚å¸¸çš„è¯·æ±‚ã€‚åœ¨æ¶ˆæ¯è§£æçš„æ—¶å€™ï¼Œä¼šå‡ºç°ã€‚
- mData å±æ€§ï¼Œè¯·æ±‚å…·ä½“æ•°æ®ã€‚

### 48.4.2 Response ###
com.alibaba.dubbo.remoting.exchange.Response ï¼Œå“åº”ã€‚

- mId å±æ€§ï¼Œå“åº”ç¼–å·ï¼Œå’Œè¯·æ±‚ç¼–å·ä¸€è‡´ã€‚
- mStatus å±æ€§ï¼ŒçŠ¶æ€ã€‚æœ‰å¤šç§çŠ¶æ€ï¼š[çŠ¶æ€ç ] (dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/Response.java)ã€‚
- mEvent å±æ€§ï¼Œæ˜¯å¦äº‹ä»¶ã€‚å’Œ Request å†…ç½®äº†ä¸€æ ·çš„äº‹ä»¶ï¼Œä½†æ˜¯ READONLY_EVENT å¹¶æœªä½¿ç”¨ã€‚å› ä¸ºç›®å‰ï¼Œåªè¯»äº‹ä»¶ï¼Œæ— éœ€å“åº”ã€‚
- mErrorMsg å±æ€§ï¼Œé”™è¯¯æ¶ˆæ¯ã€‚
- mResult å±æ€§ï¼Œç»“æœã€‚

### 48.4.3 ResponseFuture ###
com.alibaba.dubbo.remoting.exchange.ResponseFuture ï¼Œå“åº” Future æ¥å£ã€‚
å’Œ java.util.concurrent.Future å¾ˆç±»ä¼¼ã€‚

#### 48.4.3.1 DefaultFuture ####
com.alibaba.dubbo.remoting.exchange.support.DefaultFuture ï¼Œå®ç° ResponseFuture æ¥å£ï¼Œé»˜è®¤å“åº” Future å®ç°ç±»ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæ˜¯æ‰€æœ‰ DefaultFuture çš„ç®¡ç†å®¹å™¨ã€‚

**æ„é€ æ–¹æ³•**

````
/**
 * é€šé“é›†åˆ
 * keyï¼šè¯·æ±‚ç¼–å·
 */
private static final Map<Long, Channel> CHANNELS = new ConcurrentHashMap<Long, Channel>();
/**
 * Future é›†åˆ
 * keyï¼šè¯·æ±‚ç¼–å·
 */
private static final Map<Long, DefaultFuture> FUTURES = new ConcurrentHashMap<Long, DefaultFuture>();

/** è¯·æ±‚ç¼–å· */
// invoke id.
private final long id;
/** é€šé“ */
private final Channel channel;
/** è¯·æ±‚ */
private final Request request;
/** è¶…æ—¶ */
private final int timeout;
/** åˆ›å»ºå¼€å§‹æ—¶é—´ */
private final long start = System.currentTimeMillis();
/** å‘é€è¯·æ±‚æ—¶é—´ */
private volatile long sent;
/** å“åº” */
private volatile Response response;
/** å›è°ƒ */
private volatile ResponseCallback callback;

public DefaultFuture(Channel channel, Request request, int timeout) {
    this.channel = channel;
    this.request = request;
    this.id = request.getId();
    this.timeout = timeout > 0 ? timeout : channel.getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);
    // put into waiting map.
    FUTURES.put(id, this);
    CHANNELS.put(id, channel);
}
````

CHANNELS é™æ€å±æ€§ï¼Œé€šé“é›†åˆã€‚é€šè¿‡ #hasFuture(channel) æ–¹æ³•ï¼Œåˆ¤æ–­é€šé“æ˜¯å¦æœ‰æœªç»“æŸçš„è¯·æ±‚ã€‚
FUTURES é™æ€å±æ€§ï¼ŒFuture é›†åˆã€‚
sent å±æ€§ï¼Œå‘é€è¯·æ±‚æ—¶é—´ã€‚å› ä¸ºåœ¨ç›®å‰ Netty Mina ç­‰é€šä¿¡æ¡†æ¶ä¸­ï¼Œå‘é€è¯·æ±‚ä¸€èˆ¬æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤åœ¨ ChannelHandler#sent(channel, message) æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ DefaultFuture#sent(channel, request) é™æ€æ–¹æ³•ï¼Œ
callback å±æ€§ï¼Œå›è°ƒï¼Œé€‚ç”¨äºå¼‚æ­¥è¯·æ±‚ã€‚é€šè¿‡ #setCallback(callback) æ–¹æ³•è®¾ç½®ã€‚

**è·å¾—å€¼**
get(timeout)å‡½æ•°ï¼š
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ #isDone() æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å®Œæˆã€‚è‹¥æœªå®Œæˆï¼ŒåŸºäº Lock + Condition çš„æ–¹å¼ï¼Œå®ç°ç­‰å¾…ã€‚è€Œç­‰å¾…çš„å”¤é†’ï¼Œé€šè¿‡ ChannelHandler#received(channel, message) æ–¹æ³•ï¼Œæ¥æ”¶åˆ°è¯·æ±‚æ—¶æ‰§è¡Œ DefaultFuture#received(channel, response) æ–¹æ³•ã€‚
	1. è·å¾—å¼€å§‹æ—¶é—´ã€‚æ³¨æ„ï¼Œæ­¤å¤„ä½¿ç”¨çš„ä¸æ˜¯ start å±æ€§ã€‚åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œ#get(...) æ–¹æ³•ä¸­ï¼Œä½¿ç”¨çš„æ˜¯é‡æ–°è·å–å¼€å§‹æ—¶é—´ï¼›åå°æ‰«æè°ƒç”¨è¶…æ—¶ä»»åŠ¡ï¼Œä½¿ç”¨çš„æ˜¯ start å±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ#get(timeout) æ–¹æ³•çš„ timeout å‚æ•°ï¼ŒæŒ‡çš„æ˜¯ä»å½“å‰æ—¶åˆ»å¼€å§‹çš„ç­‰å¾…è¶…æ—¶æ—¶é—´ã€‚å½“ç„¶ï¼Œè¿™ä¸å½±å“æœ€ç»ˆçš„ç»“æœï¼Œæœ€ç»ˆ Response æ˜¯ä»€ä¹ˆï¼Œç”±æ˜¯ ChannelHandler#received(channel, message) è¿˜æ˜¯åå°æ‰«æè°ƒç”¨è¶…æ—¶ä»»åŠ¡ï¼Œè°å…ˆè°ƒç”¨ DefaultFuture#received(channel, response) æ–¹æ³•å†³å®šã€‚
	2. è·å¾—é”ã€‚
	3. ç­‰å¾…å®Œæˆæˆ–è¶…æ—¶ã€‚
	4. é‡Šæ”¾é”ã€‚
	5. è‹¥æœªå®Œæˆï¼ŒæŠ›å‡ºè¶…æ—¶å¼‚å¸¸ TimeoutException ã€‚
		1. TimeoutException.phase çš„é˜¶æ®µï¼Œç”± sent > 0 æ¥å†³å®šï¼Œå³ Client æ˜¯å¦å‘é€ç»™ Server ã€‚
		2. getTimeoutMessage(scan) æ–¹æ³•ï¼Œè·å¾—è¶…æ—¶å¼‚å¸¸æç¤ºä¿¡æ¯ã€‚
2. è°ƒç”¨ #returnFromResponse() æ–¹æ³•ï¼Œè¿”å›å“åº”( Response )

**å“åº”ç»“æœ**

````
public static void received(Channel channel, Response response) {
    try {
        // ç§»é™¤ FUTURES
        DefaultFuture future = FUTURES.remove(response.getId());
        // æ¥æ”¶ç»“æœ
        if (future != null) {
            future.doReceived(response);
        } else {
            logger.warn("The timeout response finally returned at " + (new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSS").format(new Date())) + ", response " + response + (channel == null ? "" : ", channel: " + channel.getLocalAddress() + " -> " + channel.getRemoteAddress()));
        }
    // ç§»é™¤ CHANNELS
    } finally {
        CHANNELS.remove(response.getId());
    }
}
````

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. ç§»é™¤ FUTURES 
2. è°ƒç”¨ DefaultFuture#doReceived(response) æ–¹æ³•ï¼Œå“åº”ç»“æœã€‚
	1. è·å¾—é”ã€‚
	2. è®¾ç½®å“åº” response ã€‚
	3. è°ƒç”¨ Condition#signal() æ–¹æ³•ï¼Œé€šçŸ¥ï¼Œå”¤é†’ DefaultFuture#get(..) æ–¹æ³•çš„ç­‰å¾…ã€‚
	4. é‡Šæ”¾é”ã€‚
	5. è°ƒç”¨ #invokeCallback(callback) æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚
3. è¶…æ—¶æƒ…å†µï¼Œæ‰“å°å‘Šè­¦æ—¥å¿—ã€‚
4. ç§»é™¤ CHANNELS ã€‚

**è®¾ç½®å›è°ƒ**
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è‹¥å·²å®Œæˆï¼Œè°ƒç”¨ #invokeCallback(callback) æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚
2. è·å¾—é”ã€‚
3. è‹¥æœªå®Œæˆï¼Œè®¾ç½®å›è°ƒ callback å±æ€§ï¼Œç­‰åœ¨ #doReceived(response) æ–¹æ³•ä¸­å†å›è°ƒã€‚
4. æ ‡è®°å·²å®Œæˆã€‚è°ƒç”¨ #invokeCallback(callback) æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚
5. é‡Šæ”¾é”ã€‚

**è°ƒç”¨å›è°ƒ**
å’Œ #returnFromResponse() æ–¹æ³•ï¼Œæƒ…å†µä¸€è‡´ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. æ­£å¸¸è¿”å›ï¼Œè°ƒç”¨ ResponseCallback#done(result) æ–¹æ³•ï¼Œå¤„ç†ç»“æœã€‚
2. è¶…æ—¶å¼‚å¸¸ï¼Œè°ƒç”¨ ResponseCallback#caught(e) æ–¹æ³•ï¼Œå¤„ç† TimeoutException å¼‚å¸¸ã€‚
3. å…¶ä»–å¼‚å¸¸ï¼Œè°ƒç”¨ ResponseCallback#caught(e)` æ–¹æ³•ï¼Œå¤„ç† RuntimeException å¼‚å¸¸ã€‚

**åå°æ‰«æè°ƒç”¨è¶…æ—¶ä»»åŠ¡**
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. å·²å®Œæˆï¼Œè·³è¿‡
2. è¶…æ—¶
3. åˆ›å»ºè¶…æ—¶ Response
4. å“åº”ç»“æœ

#### 48.4.3.2 SimpleFuture**** ####
com.alibaba.dubbo.remoting.exchange.support.SimpleFuture ï¼Œå®ç° ResponseFuture æ¥å£ï¼Œç®€å•çš„ Future å®ç°ã€‚

### 48.4.4 MultiMessage ###
com.alibaba.dubbo.remoting.exchange.support.MultiMessage ï¼Œå®ç° Iterable æ¥å£ï¼Œå¤šæ¶ˆæ¯çš„å°è£…ã€‚

## 48.5 Handler ##
### 48.5.1 HeartbeatHandler ###
com.alibaba.dubbo.remoting.exchange.support.header.HeartbeatHandler ï¼Œå®ç° AbstractChannelHandlerDelegate æŠ½è±¡ç±»ï¼Œå¿ƒè·³å¤„ç†å™¨ï¼Œå¤„ç†å¿ƒè·³äº‹ä»¶ã€‚

#### 48.5.1.1 HeartBeatTask ####
com.alibaba.dubbo.remoting.exchange.support.header.HeartBeatTask ï¼Œå®ç° Runnable æ¥å£ï¼Œå¿ƒè·³ä»»åŠ¡ã€‚

channelProvider å±æ€§ï¼Œç”¨äºæŸ¥è¯¢è·å¾—éœ€è¦å¿ƒè·³çš„é€šé“æ•°ç»„ã€‚

**æ‰§è¡Œä»»åŠ¡**
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

1. ã€ä»»åŠ¡ä¸€ã€‘æœ€åè¯»æˆ–å†™çš„æ—¶é—´ï¼Œä»»ä¸€è¶…è¿‡å¿ƒè·³é—´éš” heartbeat ï¼Œå‘é€å¿ƒè·³ã€‚
2. ã€ä»»åŠ¡äºŒã€‘æœ€åè¯»çš„æ—¶é—´ï¼Œè¶…è¿‡å¿ƒè·³è¶…æ—¶æ—¶é—´ heartbeatTimeout ï¼Œåˆ†æˆä¸¤ç§æƒ…å†µï¼š
3. å®¢æˆ·ç«¯ä¾§ï¼Œé‡è¿è¿æ¥æœåŠ¡ç«¯ã€‚
4. æœåŠ¡ç«¯ä¾§ï¼Œå…³é—­å®¢æˆ·ç«¯è¿æ¥ã€‚

### 48.5.2 HeaderExchangeHandler ###
com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeHandlerï¼Œå®ç° ChannelHandlerDelegate æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢å¤„ç†å™¨å®ç°ç±»ã€‚

**æ¥æ”¶æ¶ˆæ¯**
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è®¾ç½®æœ€åçš„è¯»æ—¶é—´ã€‚
2. åˆ›å»º ExchangeChannel å¯¹è±¡ã€‚
3. å¤„ç†è¯·æ±‚( Request)
	1. è°ƒç”¨ #handlerEvent(channel, request) æ–¹æ³•ï¼Œå¤„ç†äº‹ä»¶è¯·æ±‚ã€‚
	2. è°ƒç”¨ #handleRequest(channel, request) æ–¹æ³•ï¼Œå¤„ç†æ™®é€šè¯·æ±‚ï¼ˆéœ€è¦å“åº”ï¼‰ï¼Œå¹¶å°†å“åº”å†™å›è¯·æ±‚æ–¹ã€‚
	3. è°ƒç”¨ ChannelHandler#received(channel, message) æ–¹æ³•ï¼Œå¤„ç†æ™®é€šè¯·æ±‚ï¼ˆæ— éœ€å“åº”ï¼‰ã€‚
4. è°ƒç”¨ #handleResponse(channel, message) æ–¹æ³•ï¼Œå¤„ç†å“åº”ã€‚
5. å¤„ç† String çš„æƒ…å†µ
	1. å®¢æˆ·ç«¯ä¾§ï¼Œä¸æ”¯æŒ String çš„æƒ…å†µã€‚
	2. æœåŠ¡ç«¯ä¾§ï¼Œç›®å‰ä»…æœ‰ telnet å‘½ä»¤çš„æƒ…å†µï¼Œè°ƒç”¨ TelnetHandler#telnet(channel, message) æ–¹æ³•ï¼Œè·å¾— telnet å‘½ä»¤çš„ç»“æœï¼Œå¹¶å“åº”ç»™ telnet å®¢æˆ·ç«¯ã€‚
6. å‰©ä½™çš„æƒ…å†µï¼Œè°ƒç”¨ ChannelHandler#received(channel, message) æ–¹æ³•ï¼Œå¤„ç†ã€‚
7. ç§»é™¤ ExchangeChannel å¯¹è±¡ï¼Œè‹¥å·²æ–­å¼€ã€‚

**å‘ç”Ÿå¼‚å¸¸**
å½“å‘ç”Ÿ ExecutionException å¼‚å¸¸ï¼Œè¿”å›å¼‚å¸¸å“åº”( Response )ã€‚ç›®å‰ä¼šå‘ç”Ÿ ExecutionException çš„æƒ…å†µï¼Œå¹¶ä¸”ç¬¦åˆæäº¤

### 48.5.3 ExchangeHandler ###
com.alibaba.dubbo.remoting.exchange.ExchangeHandler ï¼Œç»§æ‰¿ ChannelHandler å’Œ TelnetHandler æ¥å£ï¼Œä¿¡æ¯äº¤æ¢å¤„ç†å™¨æ¥å£ã€‚
- æ³¨æ„ï¼Œè¿”å›çš„æ˜¯è¯·æ±‚ç»“æœã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šæ–‡çœ‹åˆ°çš„ï¼Œå°†è¯·æ±‚ç»“æœï¼Œè®¾ç½®åˆ° Response.mResult å±æ€§ä¸­ã€‚

#### 48.5.3.1 ExchangeHandlerAdapter ####

com.alibaba.dubbo.remoting.exchange.support.ExchangeHandlerAdapter ï¼Œå®ç° ExchangeHandler æ¥å£ï¼Œç»§æ‰¿ TelnetHandlerAdapter æŠ½è±¡ç±»ï¼Œä¿¡æ¯äº¤æ¢å¤„ç†å™¨é€‚é…å™¨æŠ½è±¡ç±»ã€‚

åœ¨ DubboProtocol ã€ThirftProtocol ä¸­ï¼Œéƒ½ä¼šåŸºäº ExchangeHandlerAdapter å®ç°è‡ªå·±çš„å¤„ç†å™¨ï¼Œå¤„ç†è¯·æ±‚ï¼Œè¿”å›ç»“æœã€‚

### 48.5.4 Replier ###
//  todo ç›®å‰ä»…ç”¨äºp2p

## 48.6 Exchanger ##
com.alibaba.dubbo.remoting.exchange.Exchanger ï¼Œæ•°æ®äº¤æ¢è€…æ¥å£ã€‚
Exchanger å’Œ Transporter ç±»ä¼¼ã€‚

- SPI(HeaderExchanger.NAME) æ³¨è§£ï¼ŒDubbo SPI æ‹“å±•ç‚¹ï¼Œé»˜è®¤ä¸º "header"ï¼Œå³ HeaderExchanger ã€‚
- Adaptive({Constants.EXCHANGER_KEY}) æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Server å®ç°ï¼Œä½¿ç”¨ URL.exchanger å±æ€§ã€‚
- Adaptive({Constants.EXCHANGER_KEY}) æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Client å®ç°ï¼Œä½¿ç”¨ URL.exchanger å±æ€§ã€‚

### 48.6.1 HeaderExchanger ###
com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchanger ï¼Œå®ç° Exchanger æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢è€…å®ç°ç±»ã€‚

### 48.6.2 Exchangers ###
Exchangers å’Œ Transporters ç±»ä¼¼ã€‚
com.alibaba.dubbo.remoting.Transporters ï¼Œæ•°æ®äº¤æ¢è€…é—¨é¢ç±»

## 48.7 ExchangeCodec ##
com.alibaba.dubbo.remoting.exchange.codec.ExchangeCodec ï¼Œç»§æ‰¿ TelnetCodec ç±»ï¼Œä¿¡æ¯äº¤æ¢ç¼–è§£ç å™¨ã€‚

![](/picture/dubbo-nio-exchanger-codec.png)


- åŸºäºæ¶ˆæ¯é•¿åº¦çš„æ–¹å¼ï¼Œåšæ¯æ¡æ¶ˆæ¯çš„ç²˜åŒ…æ‹†åŒ…å¤„ç†ã€‚
- Header éƒ¨åˆ†ï¼Œåè®®å¤´ï¼Œé€šè¿‡ Codec ç¼–è§£ç ã€‚Bits ä½å¦‚ä¸‹ï¼š
	- [0, 15]ï¼šMagic Number
	- [16, 20]ï¼šSerialization ç¼–å·ã€‚
	- [21]ï¼ševent æ˜¯å¦ä¸ºäº‹ä»¶ã€‚
	- [22]ï¼štwoWay æ˜¯å¦éœ€è¦å“åº”ã€‚
	- [23]ï¼šæ˜¯è¯·æ±‚è¿˜æ˜¯å“åº”ã€‚
	- [24 - 31]ï¼šstatus çŠ¶æ€ã€‚
	- [32 - 95]ï¼šid ç¼–å·ï¼ŒLong å‹ã€‚
	- [96 - 127]ï¼šBody çš„é•¿åº¦ã€‚é€šè¿‡è¯¥é•¿åº¦ï¼Œè¯»å– Body ã€‚
- Body éƒ¨åˆ†ï¼Œåè®®ä½“ï¼Œé€šè¿‡ Serialization åºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚

**å±æ€§**

````
// header length.
protected static final int HEADER_LENGTH = 16;
// magic header.
protected static final short MAGIC = (short) 0xdabb;
protected static final byte MAGIC_HIGH = Bytes.short2bytes(MAGIC)[0];
protected static final byte MAGIC_LOW = Bytes.short2bytes(MAGIC)[1];
// message flag.
protected static final byte FLAG_REQUEST = (byte) 0x80; // 128
protected static final byte FLAG_TWOWAY = (byte) 0x40; // 64
protected static final byte FLAG_EVENT = (byte) 0x20; // 32
protected static final int SERIALIZATION_MASK = 0x1f; // 31
````
HEADER_LENGTH é™æ€å±æ€§ï¼ŒHeader æ€»é•¿åº¦ï¼Œ16 Bytes = 128 Bits ã€‚

**ç¼–ç **
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ #encodeRequest(channel, buffer, request) æ–¹æ³•ï¼Œç¼–ç è¯·æ±‚ã€‚
2. è°ƒç”¨ #encodeResponse(channel, buffer, response) æ–¹æ³•ï¼Œç¼–ç å“åº”ã€‚
3. è°ƒç”¨ TelnetCodec#encode(channel, buffer, msg) æ–¹æ³•ï¼Œç¼–ç  Telnet å‘½ä»¤çš„ç»“æœã€‚

encodeRequest(channel, buffer, request) æ–¹æ³•åŸºæœ¬æµç¨‹ï¼š
1. Header éƒ¨åˆ†ï¼Œå…ˆå†™å…¥ header æ•°ç»„ï¼Œå†å†™å…¥ Buffer ä¸­ã€‚
2. Body éƒ¨åˆ†ï¼Œä½¿ç”¨ Serialization åºåˆ—åŒ– Request.data ï¼Œå†™å…¥åˆ° Buffer ä¸­ã€‚
3. è°ƒç”¨ #checkPayload(channel, len) æ–¹æ³•ï¼Œæ ¡éªŒ Body å†…å®¹çš„é•¿åº¦

- ä¸ºä»€ä¹ˆ Buffer å…ˆå†™å…¥äº† Body ï¼Œå†å†™å…¥ Header å‘¢ï¼Ÿå› ä¸º Header ä¸­ï¼Œé‡Œé¢ [96 - 127] çš„ Body é•¿åº¦ï¼Œéœ€è¦åºåˆ—åŒ–åæ‰å¾—åˆ°ã€‚

**è§£ç **

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è¯»å– header æ•°ç»„ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ Math.min(readable, HEADER_LENGTH) ï¼Œä¼˜å…ˆè€ƒè™‘è§£æ Dubbo åè®®ã€‚
2. è°ƒç”¨ #decode(channel, buffer, readable, header) æ–¹æ³•ï¼Œè§£ç ã€‚
3. åŸºäºæ¶ˆæ¯é•¿åº¦çš„æ–¹å¼ï¼Œæ‹†åŒ…ã€‚
4. è°ƒç”¨ #decodeBody(channel, is, header) æ–¹æ³•ï¼Œè§£æ Header + Body ï¼Œæ ¹æ®æƒ…å†µï¼Œè¿”å› Request æˆ– Reponse ã€‚ğŸ™‚ é€»è¾‘ä¸Šï¼Œæ˜¯ #encodeRequest(...) å’Œ #encodeResponse(...) æ–¹æ³•çš„åå‘ï¼Œ
5. skip æœªè¯»å®Œçš„æµ

----

# 49 NIO æœåŠ¡å™¨ï¼ˆäº”ï¼‰ä¹‹ Buffer å±‚ #

dubbo-remoting-api æ¨¡å—ï¼Œ buffer åŒ…ï¼ŒBuffer å±‚ã€‚
Buffer åœ¨ NIO æ¡†æ¶ä¸­ï¼Œæ‰®æ¼”éå¸¸é‡è¦çš„è§’è‰²ï¼ŒåŸºæœ¬æ¯ä¸ªåº“éƒ½æä¾›äº†è‡ªå·±çš„ Buffer å®ç°ï¼Œä¾‹å¦‚ï¼š
- Java NIO çš„ java.nio.ByteBuffer
- Mina çš„ org.apache.mina.core.buffer.IoBuffer
- Netty4 çš„ io.netty.buffer.ByteBuf

åœ¨ dubbo-remoting-api çš„ buffer åŒ…ä¸­ï¼Œä¸€æ–¹é¢å®šä¹‰äº† ChannelBuffer å’Œ ChannelBufferFactory çš„æ¥å£ï¼ŒåŒæ—¶æä¾›äº†å¤šç§é»˜è®¤çš„å®ç°ã€‚

## 49.1 ChannelBuffer ##
com.alibaba.dubbo.remoting.buffer.ChannelBuffer ï¼Œå®ç° Comparable æ¥å£ï¼Œé€šé“ Buffer æ¥å£ã€‚

ChannelBuffer åœ¨æ¥å£æ–¹æ³•çš„å®šä¹‰ä¸Šï¼Œä¸»è¦å‚è€ƒäº† Netty çš„ ByteBuf è¿›è¡Œè®¾è®¡ï¼Œæ‰€ä»¥æ¥å£å’Œæ³¨é‡ŠåŸºæœ¬ä¸€è‡´

ç‹¬æœ‰çš„æ¥å£æ–¹æ³• #factory() æ–¹æ³•ï¼Œç”¨äºé€»è¾‘ä¸­ï¼Œéœ€è¦åˆ›å»º ChannelBuffer çš„æƒ…å†µã€‚

### 49.1.1 AbstractChannelBuffer ###
com.alibaba.dubbo.remoting.buffer.AbstractChannelBuffer ï¼Œå®ç° ChannelBuffer æ¥å£ï¼Œé€šé“ Buffer æŠ½è±¡ç±»ã€‚

**æ„é€ æ–¹æ³•**
````
/** è¯»å–ä½ç½® */
private int readerIndex;
/** å†™å…¥ä½ç½® */
private int writerIndex;
/** æ ‡è®°çš„è¯»å–ä½ç½® */
private int markedReaderIndex;
/** æ ‡è®°çš„å†™å…¥ä½ç½® */
private int markedWriterIndex;
````

**å®ç°æ–¹æ³•**
åœ¨ AbstractChannelBuffer å®ç°çš„æ–¹æ³•ï¼Œéƒ½æ˜¯é‡è½½çš„æ–¹æ³•ï¼ŒçœŸæ­£å®è´¨çš„æ–¹æ³•ï¼Œéœ€è¦å­ç±»æ¥å®ç°ã€‚


### 49.1.2 ByteBufferBackedChannelBuffer ###
com.alibaba.dubbo.remoting.buffer.ByteBufferBackedChannelBuffer ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäº java.nio.ByteBuffer çš„ Buffer å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
````
/**
 * buffer
 * java.nio.ByteBuffer
 */
private final ByteBuffer buffer;
/** å®¹é‡ */
private final int capacity;

public ByteBufferBackedChannelBuffer(ByteBuffer buffer) {
    if (buffer == null) {
        throw new NullPointerException("buffer");
    }
    // buffer
    this.buffer = buffer.slice();
    // å®¹é‡
    capacity = buffer.remaining();
    // è®¾ç½® `writerIndex`
    writerIndex(capacity);
}

public ByteBufferBackedChannelBuffer(ByteBufferBackedChannelBuffer buffer) {
    // buffer
    this.buffer = buffer.buffer;
    // å®¹é‡
    capacity = buffer.capacity;
    // è®¾ç½® `writerIndex` `readerIndex`
    setIndex(buffer.readerIndex(), buffer.writerIndex());
}
````
**å·¥å‚**
å¯¹åº”çš„å·¥å‚æ˜¯ DirectChannelBufferFactory æˆ– HeapChannelBufferFactory ã€‚

### 49.1.3 HeapChannelBuffer ###
com.alibaba.dubbo.remoting.buffer.HeapChannelBuffer ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäºå­—èŠ‚æ•°ç»„çš„ Buffer å®ç°ç±»ã€‚

**å·¥å‚**
å¯¹åº”çš„å·¥å‚æ˜¯ HeapChannelBufferFactory ã€‚

### 49.1.4 DynamicChannelBuffer ###
com.alibaba.dubbo.remoting.buffer.DynamicChannelBuffer ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäºåŠ¨æ€çš„ Buffer å®ç°ç±»ã€‚æˆ–è€…è¯´ï¼ŒåŸºäºä¼ å…¥çš„ ChannelBufferFactory çš„ Buffer å®ç°ç±»ã€‚

## 49.2 ChannelBuffers ##
com.alibaba.dubbo.remoting.buffer.ChannelBuffers ï¼ŒBuffer å·¥å…·ç±»ï¼Œæä¾›åˆ›å»ºã€æ¯”è¾ƒ ChannelBuffer ç­‰å…¬ç”¨æ–¹æ³•ã€‚

## 49.3 ChannelBufferFactory ##
com.alibaba.dubbo.remoting.buffer.ChannelBufferFactory ï¼Œé€šé“ Buffer å·¥å‚æ¥å£ã€‚

### 49.3.1 DirectChannelBufferFactory ###
com.alibaba.dubbo.remoting.buffer.DirectChannelBufferFactory ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º DirectChannelBuffer çš„å·¥å‚ã€‚

### HeapChannelBufferFactory ###
com.alibaba.dubbo.remoting.buffer.HeapChannelBufferFactory ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º HeapChannelBufferFactory çš„å·¥å‚ã€‚

## 49.4 IO ##
å®é™… IO æ“ä½œï¼Œæ˜¯åŸºäº InputStream å’Œ OutputStream 

### 49.4.1 ChannelBufferInputStream ###
com.alibaba.dubbo.remoting.buffer.ChannelBufferInputStream ï¼Œå®ç° InputStream æ¥å£

### 49.4.2 ChannelBufferOutputStream ###
com.alibaba.dubbo.remoting.buffer.ChannelBufferOutputStream ï¼Œå®ç° OutputStream æ¥å£

----

# 50 NIO æœåŠ¡å™¨ï¼ˆå…­ï¼‰ä¹‹ Netty4 å®ç° #
NIOæœåŠ¡å™¨netty4æŠ½è±¡å®ç°ã€‚

## 50.1 NettyTransporter ##
com.alibaba.dubbo.remoting.transport.netty4.NettyTransporter ï¼Œå®ç° Transporter æ¥å£ï¼ŒåŸºäº Netty4 çš„ç½‘ç»œä¼ è¾“å®ç°ç±»ã€‚

````
public class NettyTransporter implements Transporter {
    /** æ‹“å±•å */
    public static final String NAME = "netty4";
    public Server bind(URL url, ChannelHandler listener) throws RemotingException {
        return new NettyServer(url, listener);
    }
    public Client connect(URL url, ChannelHandler listener) throws RemotingException {
        return new NettyClient(url, listener);
    }
}
````

- NAME é™æ€å±æ€§ï¼Œæ‹“å±•åã€‚
- NettyTransporter åŸºäº Dubbo SPI æœºåˆ¶åŠ è½½ã€‚
- åˆ›å»º NettyServer å’Œ NettyClient å¯¹è±¡ã€‚

## 50.2 NettyChannel ##
io.netty.channel.ChannelFuture.NettyChannel ï¼Œå®ç° AbstractChannel æŠ½è±¡ç±»ï¼Œå°è£… Netty Channel çš„é€šé“å®ç°ç±»ã€‚

````
/**
 * é€šé“é›†åˆ
 * channelMap é™æ€å±æ€§ï¼Œé€šé“é›†åˆã€‚åœ¨å®é™… Netty Handler é‡Œï¼ˆä¾‹å¦‚ä¸‹é¢æˆ‘ä»¬ä¼šçœ‹åˆ°çš„ NettyServerHandler å’Œ NettyClientHandlerï¼‰ï¼Œæ¯ä¸ªæ–¹æ³•å‚æ•°é‡Œï¼Œä¼ é€’çš„æ˜¯ io.netty.channel.Channel å¯¹è±¡ã€‚é€šè¿‡ NettyChannel.channelMap ä¸­ï¼Œè·å¾—å¯¹åº”çš„ NettyChannel å¯¹è±¡ã€‚
 */
private static final ConcurrentMap<io.netty.channel.Channel, NettyChannel> channelMap = new ConcurrentHashMap<Channel, NettyChannel>();

/**
 * é€šé“
 * channel å±æ€§ï¼Œé€šé“ã€‚NettyChannel æ˜¯ä¼ å…¥ channel å±æ€§çš„è£…é¥°å™¨ï¼Œæ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨ channel ã€‚
 */
private final io.netty.channel.Channel channel;
/**
 * å±æ€§é›†åˆ
 * attributes å±æ€§ï¼Œå±æ€§é›†åˆã€‚æ³¨æ„ï¼ŒsetAttribute(...) ç­‰æ–¹æ³•ï¼Œä½¿ç”¨çš„æ˜¯è¯¥å±æ€§ï¼Œè€Œä¸æ˜¯ io.netty.channel.Channel çš„ã€‚
 */
private final Map<String, Object> attributes = new ConcurrentHashMap<String, Object>();

private NettyChannel(io.netty.channel.Channel channel, URL url, ChannelHandler handler) {
    super(url, handler);
    if (channel == null) {
        throw new IllegalArgumentException("netty channel == null;");
    }
    this.channel = channel;
}
````
å†…éƒ¨å‡½æ•°ï¼š
getOrAddChannel(ch, url, handler) é™æ€æ–¹æ³•ï¼Œåˆ›å»º NettyChannel å¯¹è±¡ã€‚
removeChannelIfDisconnected(ch) é™æ€æ–¹æ³•ï¼Œç§»é™¤ NettyChannel å¯¹è±¡ã€‚

**å‘é€æ¶ˆæ¯**
send(message, sent)

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ #send(message, sent) æ–¹æ³•ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€ã€‚
2. success ï¼Œæ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚è‹¥ä¸éœ€è¦ç­‰å¾…å‘é€æˆåŠŸ( sent = false ) ï¼Œé»˜è®¤æˆåŠŸã€‚
3. è°ƒç”¨çœŸæ­£çš„ io.netty.channel.Channel#writeAndFlush(message) æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯ã€‚
4. è‹¥éœ€è¦ç­‰å¾…å‘é€æˆåŠŸ( sent = true )ï¼Œç­‰å¾…ç›´åˆ°æˆåŠŸæˆ–è¶…æ—¶ã€‚
5. è‹¥å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
6. è‹¥å‘é€å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚

**å…³é—­é€šé“**
close()

## 50.3 Server ##
### 50.3.1 NettyServer ###
com.alibaba.dubbo.remoting.transport.netty4.NettyServer ï¼Œå®ç° Server æ¥å£ï¼Œç»§æ‰¿ AbstractServer æŠ½è±¡ç±»ï¼ŒNetty æœåŠ¡å™¨å®ç°ç±»ã€‚

åŒ…æ‹¬å¯åŠ¨serverå’Œå…³é—­serverçš„æ–¹æ³•ã€‚

### 50.3.2 NettyServerHandler ###
com.alibaba.dubbo.remoting.transport.netty4.NettyServerHandler ï¼Œå®ç° io.netty.channel.ChannelDuplexHandler ç±»ï¼ŒNettyServer çš„å¤„ç†å™¨ã€‚

è·å–contextå¹¶æŠŠcongtextäº¤ç»™handlerå¤„ç†ã€‚

## 50.4 Client ##
### 50.4.1 NettyClient ###
com.alibaba.dubbo.remoting.transport.netty4.NettyClient ï¼Œç»§æ‰¿ AbstractNettyClient æŠ½è±¡ç±»ï¼ŒNetty å®¢æˆ·ç«¯å®ç°ç±»ã€‚

åŒ…æ‹¬å¯åŠ¨clientå’Œæ–­å¼€è¿æ¥ä»¥åŠå…³é—­è¿æ¥ã€‚

### 50.4.2 NettyClientHandler ###
com.alibaba.dubbo.remoting.transport.netty4.NettyClientHandler ï¼Œå®ç° io.netty.channel.ChannelDuplexHandler ç±»ï¼ŒNettyClient çš„å¤„ç†å™¨ã€‚

å®ç°æ–¹å¼å’ŒserverHandlerå·®ä¸å¤šï¼Œéƒ½æ˜¯äº¤ç»™handlerå¤„ç†ã€‚

## 50.5 NettyBackedChannelBuffer ##
com.alibaba.dubbo.remoting.transport.netty4.NettyBackedChannelBuffer ï¼Œå®ç° ChannelBuffer æ¥å£ï¼ŒåŸºäº Netty ByteBuf çš„ ChannelBuffer å®ç°ç±»ã€‚

nettyçš„ByteBufæ¥å£çš„åŒ…è£…ã€‚æ¯ä¸ªå®ç°æ–¹æ³•éƒ½å¯¹åº”ByteBufæ–¹æ³•ã€‚

## 50.6 NettyCodecAdapter ##
com.alibaba.dubbo.remoting.transport.netty4.NettyCodecAdapter ï¼ŒNetty ç¼–è§£ç é€‚é…å™¨ï¼Œå°† Dubbo ç¼–è§£ç å™¨ é€‚é…æˆ Netty4 çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚

**æ„é€ æ–¹æ³•**
````
/** Netty ç¼–ç å™¨ */
private final ChannelHandler encoder = new InternalEncoder();
/** Netty è§£ç å™¨ */
private final ChannelHandler decoder = new InternalDecoder();
/** Dubbo ç¼–è§£ç å™¨ */
private final Codec2 codec;
/** Dubbo URL */
private final URL url;
/** Dubbo ChannelHandler */
private final com.alibaba.dubbo.remoting.ChannelHandler handler;
public NettyCodecAdapter(Codec2 codec, URL url, com.alibaba.dubbo.remoting.ChannelHandler handler) {
    this.codec = codec;
    this.url = url;
    this.handler = handler;
}
````

### 50.6.1 InternalEncoder ###
io.netty.handler.codec.MessageToByteEncoder ï¼ŒNetty4 ç¼–ç å™¨æŠ½è±¡ç±»ã€‚

### 50.6.2 InternalDecoder ###
io.netty.handler.codec.ByteToMessageDecoder ï¼ŒNetty4 è§£ç å™¨æŠ½è±¡ç±»ã€‚

## 50.7 æ—¥å¿—å·¥å‚ ##
è‡ª 2.2.1 å¼€å§‹ï¼Œdubbo å¼€å§‹å†…ç½® log4jã€slf4jã€jclã€jdk è¿™äº›æ—¥å¿—æ¡†æ¶çš„é€‚é…ã€‚

åŸºæœ¬å®ç°ã€‚
è°ƒç”¨ NettyHelper#setNettyLoggerFactory() æ–¹æ³•ï¼Œè®¾ç½®æ—¥å¿—å·¥å‚ï¼ŒåŸºäº Dubbo Logger ç»„ä»¶ã€‚

----

# 51 NIO æœåŠ¡å™¨ï¼ˆä¸ƒï¼‰ä¹‹ Netty3 å®ç° #
//  todo ç­‰å¾…å®Œå–„


---- 

# 52 HTTP æœåŠ¡å™¨ #
åœ¨ dubbo-remoting-http æ¨¡å—ä¸­å®ç°ï¼Œä½¿ç”¨åœ¨ http://ã€ rest://ã€hessian://ã€webservice://åè®®ã€‚

dubbo-remoting-http åªæä¾› Server éƒ¨åˆ†

ç±»ç»“æ„ï¼š
- API å±‚ï¼š
	- æœ€å¤–å±‚ï¼šAPI å®šä¹‰ã€‚
	- support åŒ…ï¼š å…¬ç”¨å®ç°ã€‚
- å®ç°å±‚ï¼š
	- jetty åŒ…ï¼šåŸºäºå†…åµŒçš„ Jetty å®ç°ï¼Œç‰ˆæœ¬ä¸º 6.x ã€‚
	- tomcat åŒ…ï¼šåŸºäºå†…åµŒçš„ Tomcat å®ç°ï¼Œç‰ˆæœ¬ä¸º 8.x ã€‚
	- servlet åŒ…ï¼šåŸºäº Servlet Bridge Server å®ç°ã€‚ç®€å•çš„è¯´ï¼Œä½¿ç”¨ war åŒ…ï¼Œéƒ¨ç½²åœ¨å¤–éƒ¨çš„ Tomcat ã€Jetty ç­‰ Servlet å®¹å™¨ã€‚

- HttpBinder ï¼Œè´Ÿè´£åˆ›å»ºå¯¹åº”çš„ HttpServer å¯¹è±¡ã€‚
- ä¸åŒçš„ Protocol ï¼Œå®ç°å„è‡ªçš„ HttpHandler ç±»ã€‚å¹¶ä¸”ï¼Œæš´éœ²æœåŠ¡æ—¶ï¼Œå¯åŠ¨ HttpServer çš„åŒæ—¶ï¼Œåˆ›å»ºå¯¹åº”çš„ HttpHandler å¯¹è±¡ï¼Œä»¥ port ä¸ºé”®ï¼Œæ³¨å†Œåˆ° DispatcherServlet ä¸Šã€‚
- DispatcherServlet ï¼Œæ ¸å¿ƒï¼Œè°ƒåº¦è¯·æ±‚ï¼Œåˆ°å¯¹åº”çš„ HttpHandler ä¸­ã€‚

æ•´ä½“æµç¨‹å›¾ï¼š

![](/picture/dubbo-http-flow.png)

## 52.1 API ##
### 52.1.1 HttpServer ###
com.alibaba.dubbo.remoting.http.HttpServer ï¼Œå®ç° Resetable æ¥å£ï¼ŒHTTP æœåŠ¡å™¨æ¥å£ã€‚'

### 52.1.2 AbstractHttpServer ###
com.alibaba.dubbo.remoting.http.AbstractHttpServer ï¼Œå®ç° HttpServer æ¥å£ï¼ŒHTTP æœåŠ¡å™¨æŠ½è±¡ç±»ã€‚

### 52.1.3 HttpHandler ###
com.alibaba.dubbo.remoting.http.HttpHandler ï¼ŒHTTP å¤„ç†å™¨æ¥å£

### 52.1.4 HttpBinder ###
com.alibaba.dubbo.remoting.http.HttpBinder ï¼ŒHTTP ç»‘å®šå™¨æ¥å£ã€‚

````
@SPI("jetty")
public interface HttpBinder {
    /**
     * bind the server.
     */
    @Adaptive({Constants.SERVER_KEY})
    HttpServer bind(URL url, HttpHandler handler);
}
````

- @SPI("jetty") æ³¨è§£ï¼ŒDubbo SPI æ‹“å±•ç‚¹ï¼Œé»˜è®¤ä¸º "jetty" ï¼Œå³æœªé…ç½®æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Jetty Server ã€‚
- @Adaptive({Constants.SERVER_KEY}) æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Server å®ç°ï¼Œä½¿ç”¨ URL.server å±æ€§ã€‚

### 52.1.5 DispatcherServlet ###
com.alibaba.dubbo.remoting.http.serlvet.DispatcherServlet ï¼Œå®ç° javax.servlet.http.HttpServlet æ¥å£ï¼ŒæœåŠ¡è¯·æ±‚è°ƒåº¦ Servletã€‚

### 52.1.6 ServletManager ###
com.alibaba.dubbo.remoting.http.serlvet.ServletManager ï¼ŒServlet ç®¡ç†å™¨ï¼Œè´Ÿè´£ç®¡ç† ServletContext

- EXTERNAL_SERVER_PORT é™æ€å±æ€§ï¼Œå¤–éƒ¨æœåŠ¡å™¨ç«¯å£ï¼Œç”¨äº servlet çš„æœåŠ¡å™¨ç«¯å£ã€‚
- contextMap é™æ€å±æ€§ï¼ŒServletContext é›†åˆã€‚
	- addServletContext(port, ServletContext) æ–¹æ³•ï¼Œæ·»åŠ ã€‚
	- removeServletContext(port) æ–¹æ³•ï¼Œç§»é™¤ã€‚
	- getServletContext(port) æ–¹æ³•ï¼ŒæŸ¥è¯¢ã€‚

## 52.2 Tomcat å®ç° ##

### 52.2.1 TomcatHttpServer ###
com.alibaba.dubbo.remoting.http.tomcat.TomcatHttpServer ï¼Œå®ç° AbstractHttpServer æŠ½è±¡ç±»ï¼ŒåŸºäº Tomcat çš„ HTTP æœåŠ¡å™¨å®ç°ç±»ã€‚

#### 52.2.1.1 æ„é€ æ–¹æ³• ####

````
/** å†…åµŒçš„ Tomcat å¯¹è±¡ */
private final Tomcat tomcat;
/** URL å¯¹è±¡ */
private final URL url;
public TomcatHttpServer(URL url, final HttpHandler handler) {
    super(url, handler);
    this.url = url;
    // æ³¨å†Œ HttpHandler åˆ° DispatcherServlet ä¸­
    DispatcherServlet.addHttpHandler(url.getPort(), handler);
    // åˆ›å»ºå†…åµŒçš„ Tomcat å¯¹è±¡
    String baseDir = new File(System.getProperty("java.io.tmpdir")).getAbsolutePath();
    tomcat = new Tomcat();
    tomcat.setBaseDir(baseDir);
    tomcat.setPort(url.getPort());
    tomcat.getConnector().setProperty("maxThreads", String.valueOf(url.getParameter(Constants.THREADS_KEY, Constants.DEFAULT_THREADS))); // æœ€å¤§çº¿ç¨‹æ•°
    tomcat.getConnector().setProperty("maxConnections", String.valueOf(url.getParameter(Constants.ACCEPTS_KEY, -1))); // æœ€å¤§è¿æ¥æ± 
    tomcat.getConnector().setProperty("URIEncoding", "UTF-8"); // ç¼–ç ä¸º UTF-8
    tomcat.getConnector().setProperty("connectionTimeout", "60000"); // è¿æ¥è¶…æ—¶ï¼Œ60 ç§’
    tomcat.getConnector().setProperty("maxKeepAliveRequests", "-1");
    tomcat.getConnector().setProtocol("org.apache.coyote.http11.Http11NioProtocol");
    // æ·»åŠ  DispatcherServlet åˆ° Tomcat ä¸­
    Context context = tomcat.addContext("/", baseDir);
    Tomcat.addServlet(context, "dispatcher", new DispatcherServlet());
    context.addServletMapping("/*", "dispatcher");
    // æ·»åŠ  ServletContext å¯¹è±¡ï¼Œåˆ° ServletManager ä¸­
    ServletManager.getInstance().addServletContext(url.getPort(), context.getServletContext());
    // å¯åŠ¨ Tomcat
    try {
        tomcat.start();
    } catch (LifecycleException e) {
        throw new IllegalStateException("Failed to start tomcat server at " + url.getAddress(), e);
    }
}
````

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ DispatcherServlet#addHttpHandler(port, handler) æ–¹æ³•ï¼Œæ³¨å†Œ HttpHandler åˆ° DispatcherServlet ä¸­ã€‚
1. åˆ›å»ºå†…åµŒçš„ Tomcat å¯¹è±¡ã€‚
1. åˆ›å»ºå¹¶æ·»åŠ  DispatcherServlet å¯¹è±¡ï¼Œåˆ° Tomcat ä¸­ã€‚
1. è°ƒç”¨ ServletManager#addServletContext(port, ServletContext) æ–¹æ³•ï¼Œæ·»åŠ  DispatcherServlet å¯¹è±¡ï¼Œåˆ° ServletManager ä¸­ã€‚
1. è°ƒç”¨ Tomcat#start() æ–¹æ³•ï¼Œå¯åŠ¨ Tomcat ã€‚

#### 52.2.1.2 å…³é—­ ####
````
@Override
public void close() {
    // æ ‡è®°å…³é—­
    super.close();

    // ç§»é™¤ ServletContext å¯¹è±¡
    ServletManager.getInstance().removeServletContext(url.getPort());

    // å…³é—­ Tomcat
    try {
        tomcat.stop();
    } catch (Exception e) {
        logger.warn(e.getMessage(), e);
    }
}
````

## 52.3 Jetty å®ç° ##
jetty å’Œ tomcat åŒ…çš„å®ç°ï¼Œå·®ä¸å¤šï¼Œä¸»è¦å·®å¼‚åœ¨ Tomcat å’Œ Jetty çš„ API ä¸åŒã€‚

## 52.4 Servlet Bridge å®ç° ##
### 52.4.1 ServletHttpServer ###
com.alibaba.dubbo.remoting.http.servlet.ServletHttpServer ï¼Œå®ç° AbstractHttpServer æŠ½è±¡ç±»ï¼Œ åŸºäº Servlet çš„æœåŠ¡å™¨å®ç°ç±»ã€‚

- æ³¨æ„ï¼Œåœ¨ <dubbo:protocol /> é…ç½®çš„ç«¯å£ï¼Œå’Œå¤–éƒ¨çš„ Servlet å®¹å™¨çš„ç«¯å£ï¼Œä¿æŒä¸€è‡´ã€‚
- éœ€è¦é…ç½® DispatcherServlet åˆ° web.xml ä¸­ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œè®©å¤–éƒ¨çš„ Servlet å®¹å™¨ï¼Œå¯ä»¥è¿›è¡Œè½¬å‘ã€‚

### 52.4.2 ServletHttpBinder ###


### 52.4.3 BootstrapListener ###
com.alibaba.dubbo.remoting.http.servlet.BootstrapListener ï¼Œå®ç° ServletContextListener æ¥å£ï¼Œ å¯åŠ¨ç›‘å¬å™¨ã€‚

éœ€è¦é…ç½® BootstrapListener åˆ° web.xml ä¸­ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œè®©å¤–éƒ¨çš„ ServletContext å¯¹è±¡ï¼Œæ·»åŠ åˆ° ServletManager ä¸­ã€‚

------

# 53 åºåˆ—åŒ–ï¼ˆä¸€ï¼‰ä¹‹æ€»ä½“å®ç° #
å°†å¯¹è±¡è½¬æˆå­—èŠ‚æµï¼Œç”¨äºç½‘ç»œä¼ è¾“ï¼Œä»¥åŠå°†å­—èŠ‚æµè½¬ä¸ºå¯¹è±¡ï¼Œç”¨äºåœ¨æ”¶åˆ°å­—èŠ‚æµæ•°æ®åè¿˜åŸæˆå¯¹è±¡ã€‚

åºåˆ—åŒ–åœ¨ dubbo-common é¡¹ç›®çš„ serialize æ¨¡å—å®ç°ã€‚

## 53.1 API å®šä¹‰ ##
### 53.1.1 Serialization ###
com.alibaba.dubbo.common.serialize.Serialization ï¼Œåºåˆ—åŒ–æ¥å£ã€‚

- @SPI("hessian2") æ³¨è§£ï¼ŒDubbo SPI æ‹“å±•ç‚¹ï¼Œé»˜è®¤ä¸º "hessian2" ï¼Œå³æœªé…ç½®æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Hessian è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ– ã€‚
- getContentTypeId(),#getContentType() æ–¹æ³•ï¼Œè·å¾—å†…å®¹ç±»å‹ç¼–å·å’Œåå­—ã€‚

### 53.1.2 DataInput ###
com.alibaba.dubbo.common.serialize.DataInput ï¼Œæ•°æ®è¾“å…¥æ¥å£ã€‚

ä» InputStream ä¸­ï¼Œè¯»å–åŸºæœ¬ç±»å‹çš„æ•°æ®ã€‚

#### 53.1.2.1 ObjectInput ####
com.alibaba.dubbo.common.serialize.ObjectInput ï¼Œå®ç° DataInput æ¥å£ï¼Œå¯¹è±¡è¾“å…¥æ¥å£ã€‚

åœ¨ DataInput çš„åŸºç¡€ä¸Šï¼Œå¢åŠ è¯»å–å¯¹è±¡çš„æ•°æ®ã€‚

### 53.1.3 DataOutput ###
DataOutput å’Œ DataInput ç›¸åã€‚

com.alibaba.dubbo.common.serialize.DataOutput ï¼Œæ•°æ®è¾“å‡ºæ¥å£ã€‚

å‘ InputStream ä¸­ï¼Œå†™å…¥åŸºæœ¬ç±»å‹çš„æ•°æ®ã€‚

#### 53.1.3.1 ObjectOutput ####
com.alibaba.dubbo.common.serialize.ObjectOutput ï¼Œå®ç° DataOutput æ¥å£ï¼Œå¯¹è±¡è¾“å‡ºæ¥å£ã€‚

åœ¨ DataOutput çš„åŸºç¡€ä¸Šï¼Œå¢åŠ å†™å…¥å¯¹è±¡çš„æ•°æ®ã€‚

### 53.1.4 Cleanable ###
com.alibaba.dubbo.common.serialize.Cleanable ï¼Œæ¸…ç†æ¥å£ã€‚
éƒ¨åˆ† Serialize å®ç°ç±»ï¼Œå®Œæˆåºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ï¼Œéœ€è¦åšæ¸…ç†ã€‚é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œæ‰§è¡Œæ¸…ç†çš„é€»è¾‘ã€‚

### 53.1.5 Optimizer ç›¸å…³ ###
#### 53.1.5.1 SerializationOptimizer ####
com.alibaba.dubbo.common.serialize.support.SerializationOptimizer ï¼Œåºåˆ—åŒ–ä¼˜åŒ–å™¨æ¥å£ã€‚

#### 53.1.5.2 SerializableClassRegistry ####
com.alibaba.dubbo.common.serialize.support.SerializableClassRegistry ï¼Œåºåˆ—åŒ–ä¼˜åŒ–ç±»çš„æ³¨å†Œè¡¨ã€‚

- registerClass(clazz) é™æ€æ–¹æ³•ï¼Œæ³¨å†Œã€‚åœ¨ SerializationOptimizer#getSerializableClasses() æ–¹æ³•ï¼Œè·å¾—çš„ç±»çš„é›†åˆï¼Œä¼šæ³¨å†Œåˆ° SerializableClassRegistry ä¸­ã€‚
- getRegisteredClasses() é™æ€æ–¹æ³•ï¼Œè·å¾—ã€‚åœ¨ Kryo ã€FST ä¸­ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè·å¾—éœ€è¦ä½¿ç”¨ä¼˜åŒ–çš„ç±»çš„é›†åˆã€‚

#### 53.1.5.3 åˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨ ####
åœ¨ DubboProtocol#optimizeSerialization() æ–¹æ³•ä¸­ï¼Œåˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è·å¾— `optimizer` é…ç½®é¡¹
2. åŠ è½½ SerializationOptimizer å®ç°ç±»
3. åˆ›å»º SerializationOptimizer å¯¹è±¡
4. æ³¨å†Œåˆ° SerializableClassRegistry ä¸­
5. æ·»åŠ åˆ° optimizers ä¸­

## 53.2 FST å®ç° ##
### 53.2.1 FstFactory ###
com.alibaba.dubbo.common.serialize.support.fst.FstFactory ï¼ŒFST å·¥å‚ã€‚
- factory é™æ€å±æ€§ï¼Œå•ä¾‹ã€‚
- conf å±æ€§ï¼ŒFST é…ç½®å¯¹è±¡ã€‚åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå°† SerializableClassRegistry æ³¨å†Œè¡¨éœ€è¦ä½¿ç”¨ä¼˜åŒ–çš„ç±»ï¼Œæ³¨å†Œåˆ° FSTConfiguration ä¸­ã€‚SerializableClassRegistry#registerClass(Class ... c) æ–¹æ³•
- getObjectOutput() æ–¹æ³•ï¼Œè·å¾— org.nustaq.serialization.FSTObjectOutput å¯¹è±¡ï¼Œè¢« FstObjectOutput è°ƒç”¨ã€‚
- getObjectInput() æ–¹æ³•ï¼Œè·å¾— org.nustaq.serialization.FSTObjectInput å¯¹è±¡ï¼Œè¢« FstObjectInput è°ƒç”¨ã€‚

### 53.2.2 FstSerialization ###
com.alibaba.dubbo.common.serialize.support.fst.FstSerialization ï¼Œå®ç° Serialization æ¥å£ï¼ŒFST åºåˆ—åŒ–å®ç°ç±»ã€‚

- "x-application/fst" ï¼Œç±»ä¼¼ HTTP åè®® çš„ Content-Types çš„ Header ã€‚

### 53.2.3 FstObjectInput ###
com.alibaba.dubbo.common.serialize.support.fst.FstObjectInput ï¼Œå®ç° ObjectInput æ¥å£ï¼ŒFST å¯¹è±¡è¾“å…¥å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

````
/**
 * input å±æ€§ï¼Œè°ƒç”¨ FstFactory#getObjectInput(inputStream) æ–¹æ³•ï¼Œè·å¾—ã€‚
 */ 
private FSTObjectInput input;
public FstObjectInput(InputStream inputStream) {
    input = FstFactory.getDefaultFactory().getObjectInput(inputStream);
}
````

**å®ç°æ–¹æ³•**
æ¯ä¸ªå®ç°æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ FSTObjectInput å¯¹åº”çš„æ–¹æ³•ã€‚

### 53.2.4 FstObjectOutput ###
com.alibaba.dubbo.common.serialize.support.fst.FstObjectOutput ï¼Œå®ç° ObjectOutput æ¥å£ï¼ŒFST å¯¹è±¡è¾“å‡ºå®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
````
/**
 * è°ƒç”¨ FstFactory#getObjectInput(outputStream) æ–¹æ³•ï¼Œè·å¾—ã€‚
 */ 
private FSTObjectOutput output;

public FstObjectOutput(OutputStream outputStream) {
    output = FstFactory.getDefaultFactory().getObjectOutput(outputStream);
}
````

**å®ç°æ–¹æ³•**
æ¯ä¸ªå®ç°æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ FSTObjectInput å¯¹åº”çš„æ–¹æ³•ã€‚

## 53.3 JSON å®ç° ##

åŸºäº FastJSON å®ç°ã€‚

## 53.4 Hessian2 å®ç° ##
å’Œå…¶ä»– Web æœåŠ¡çš„å®ç°æ¡†æ¶ä¸åŒçš„æ˜¯ï¼ŒHessian æ˜¯ä¸€ä¸ªä½¿ç”¨äºŒè¿›åˆ¶ Web æœåŠ¡åè®®çš„æ¡†æ¶ï¼Œå®ƒçš„å¥½å¤„åœ¨äºå…é™¤äº†ä¸€å¤§å †é™„åŠ çš„APIåŒ…ï¼Œä¾‹å¦‚ XML çš„å¤„ç†ä¹‹ç±»çš„ jar åŒ…ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Web æœåŠ¡å®ç°æ¡†æ¶çš„åŸå› ï¼Œè¿™ä¸ªåŸå› è¿˜åœ¨äºæ‰‹æœºä¸Šçš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ Hessian æä¾›çš„ API å¾ˆæ–¹ä¾¿çš„è®¿é—® Hessian çš„ Web æœåŠ¡ã€‚

## 53.5 NativeJava å®ç° ##

nativejava ï¼ŒåŸºäº Java åŸç”Ÿ( è‡ªå¸¦ )çš„ Java åºåˆ—åŒ–å®ç°ï¼Œå³ä½¿ç”¨ java.io.ObjectInputStream å’Œ java.io.ObjectOutputStream è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

----

# 54 åºåˆ—åŒ–ï¼ˆäºŒï¼‰ä¹‹ Dubbo å®ç° #
Dubbo è‡ªå·±å®ç°çš„åºåˆ—åŒ–æ‹“å±•ã€‚è¦å®ç°åºåˆ—åŒ–çš„é«˜æ€§èƒ½ï¼Œéœ€è¦è€ƒè™‘ä¸¤æ–¹é¢ï¼š
- åºåˆ—åŒ–å’Œååºåˆ—åŒ–é€Ÿåº¦å¿«
- ä»ä¼ è¾“è§’åº¦ï¼Œæ•°æ®å‹ç¼©æ•ˆæœå¥½ï¼Œå³åºåˆ—åŒ–åçš„æ•°æ®é‡ä½“ç§¯å°

## 54.1 GenericDataFlags ##
Dubbo ï¼Œæ˜¯ä¸€ç§æœ‰åºã€ç´§å‡‘çš„åºåˆ—åŒ–æ–¹å¼ã€‚å¦‚ä¸‹æ˜¯åºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°æ®æµçš„ç¤ºæ„å›¾ï¼š

![](/picture/dubbo-serialize-data.png)

ä¸åŒäº JSON / XML ç­‰åºåˆ—åŒ–æ–¹å¼ï¼Œæ— éœ€åºåˆ—åŒ–æ¯ä¸ªå±æ€§åã€‚é€šè¿‡ Builder å¯¹è±¡ï¼Œåˆ›å»ºæ¯ä¸ªç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å…·ä½“ä»£ç ã€‚
- è¿™æ ·ï¼Œæˆ‘ä»¬å°±é¿å…äº†å±æ€§åçš„åºåˆ—åŒ–ï¼Œæå‡äº†é€Ÿåº¦ï¼Œå‡å°‘äº†æ•°æ®çš„ä½“ç§¯ã€‚
- å½“ç„¶ï¼Œåè¿‡æ¥è¯´ï¼Œå¦‚æœå¯¹è±¡å‘ç”Ÿäº†å˜åŒ–( å¢åŠ æˆ–åˆ é™¤å±æ€§ )ï¼Œå¯èƒ½ä¼šå‡ºç° Client å’Œ Server åºåˆ—åŒ–çš„ä¸å…¼å®¹ï¼Œå› ä¸ºå±æ€§çš„é¡ºåºå‘ç”Ÿäº†å˜åŒ–ã€‚
- 
å±æ€§å€¼å’Œå±æ€§å€¼ä¹‹é—´æ— é—´éš”ï¼Œé€šè¿‡å±æ€§å€¼çš„æ ‡å¿—ä½ Flag ä¿è¯

com.alibaba.dubbo.common.serialize.support.dubbo.GenericDataFlags é€šç”¨æ•°æ®æ ‡è®°æšä¸¾è§„æ•´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
![](/picture/dubbo-GenericDataFlags.png)

- åœ¨æ¯ä¸ªå±æ€§å€¼( å³ field )çš„é¦–ä¸ª Byte ä½ï¼Œç§°ä¸ºæ ‡å¿—ä½ Flag ã€‚ç›®å‰æˆ‘ä»¬åˆ†æˆä¸¤å¤§ç±»( å›¾ä¸­ï¼Œç»¿è‰²éƒ¨åˆ† )ï¼š
	- Varint ï¼Œå˜é•¿æ•°å­—ï¼Œå ç”¨ Byte å€¼çš„ [0, 128) åŒºé—´ã€‚
	- Object ï¼Œå¯¹è±¡ï¼Œå ç”¨ Byte å€¼çš„ [-128, 0) åŒºé—´ã€‚
- æ ‡å¿—ä½ Flag æ ¹æ®ç”¨é€”ï¼Œå¯ä»¥åˆ†æˆä¸¤ç§ç±»å‹ï¼ˆæ³¨æ„ï¼Œå€¼æ˜¯ä¸é‡å çš„ï¼‰ï¼š
	- Tag ï¼Œæ ‡ç­¾( å›¾ä¸­ï¼Œæ©™è‰²éƒ¨åˆ† )ã€‚
		- ä»¥ VarInt ä¸¾ä¾‹å­ï¼Œæ•°å­—åˆ†æˆ BYTEã€SHORTã€INTã€LONG å››ç§æ•°æ®ç±»å‹ã€‚ é€šè¿‡æ ‡è®°ä½ï¼Œè¡¨ç¤ºæ•°å­—å ç”¨å¤šå°‘ Byte ï¼Œä»è€Œå®ç°å˜é•¿ï¼ŒèŠ‚çœ Byte çš„å ç”¨ã€‚ä¾‹å¦‚ï¼Œå±æ€§å€¼ç±»å‹ä¸º Long ï¼Œä½†æ˜¯å€¼æ˜¯ 100L ï¼Œé‚£ä¹ˆåªéœ€è¦è¦ 1 Byte( æ ‡è®°ä½ä¸º VARINT8 ) + 1 Byte( 100L ) = 2 Byte ã€‚
		- å½“ç„¶ï¼Œè¿™ç§æ–¹å¼ä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå¯¹äºå¤§æ•´æ•°ï¼Œä¼šå¤šå ç”¨ä¸€ä¸ªæ ‡è®°ä½ï¼Œä¾‹å¦‚ Integer.MAX_VALUE ã€‚ä»ç»Ÿè®¡ä¸Šæ¥è¯´ï¼Œä¸šåŠ¡ç³»ç»Ÿæ›´å¤šçš„æ˜¯å°æ•´æ•°ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªç¼ºç‚¹ä¹Ÿæ˜¯èƒ½å¤Ÿæ¥å—çš„ã€‚
	- CONSTANTS ï¼Œ æšä¸¾( å›¾ä¸­ï¼Œé»„è‰²éƒ¨åˆ† )ï¼Œç”¨äºå¸¸ç”¨å±æ€§å€¼ã€‚
		- ä»¥ Varint ä¸¾ä¾‹å­ï¼Œåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œ[ -15, 31 ] æ˜¯éå¸¸å¸¸ç”¨ã€‚é€šè¿‡æšä¸¾ï¼Œè¿›ä¸€æ­¥å‡å°‘æ•°æ®æåŠï¼Œæå‡åºåˆ—åŒ–é€Ÿåº¦ã€‚æ‰€ä»¥ Varint çš„äºŒè¿›åˆ¶æ•°æ®æµç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![](/picture/dubbo-Varint-byte.png)

## 54.2 Data ##
### 54.2.1 GenericDataOutput ###
com.alibaba.dubbo.common.serialize.support.dubbo.GenericDataOutput ï¼Œå®ç° DataOutputï¼ŒGenericDataFlags æ¥å£ï¼ŒDubbo æ•°æ®è¾“å‡ºå®ç°ç±»ã€‚
#### 54.2.1.1 æ„é€ æ–¹æ³• ####

````
/**
 * é»˜è®¤ {@link #mCharBuf} å¤§å°
 */
private static final int CHAR_BUF_SIZE = 256;
/**
 * åºåˆ—åŒ–å­—ç¬¦ä¸²çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº {@link #writeUTF(String)} ä¸­ã€‚
 */
private final char[] mCharBuf = new char[CHAR_BUF_SIZE];

/**
 * åºåˆ—åŒ– Varint çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº {@link #writeVarint32(int)} å’Œ {@link #writeVarint64(long)} ä¸­ã€‚
 */
private final byte[] mTemp = new byte[9];

/**
 * åºåˆ—åŒ–ç»“æœçš„ Buffer æ•°ç»„
 */
private final byte[] mBuffer;
/**
 * {@link #mBuffer} å®¹é‡å¤§å°
 */
private final int mLimit;
/**
 * {@link #mBuffer} å½“å‰å†™å…¥ä½ç½®
 */
private int mPosition = 0;

/**
 * ç»“æœè¾“å‡º
 */
private final OutputStream mOutput;
````

----


# 55 åºåˆ—åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ Kryo å®ç° #

# 56 æœåŠ¡å®¹å™¨ #

- æœåŠ¡å®¹å™¨æ˜¯ä¸€ä¸ª standalone çš„å¯åŠ¨ç¨‹åºï¼Œå› ä¸ºåå°æœåŠ¡ä¸éœ€è¦ Tomcat æˆ– JBoss ç­‰ Web å®¹å™¨çš„åŠŸèƒ½ï¼Œå¦‚æœç¡¬è¦ç”¨ Web å®¹å™¨å»åŠ è½½æœåŠ¡æä¾›æ–¹ï¼Œå¢åŠ å¤æ‚æ€§ï¼Œä¹Ÿæµªè´¹èµ„æºã€‚
- æœåŠ¡å®¹å™¨åªæ˜¯ä¸€ä¸ªç®€å•çš„ Main æ–¹æ³•ï¼Œå¹¶åŠ è½½ä¸€ä¸ªç®€å•çš„ Spring å®¹å™¨ï¼Œç”¨äºæš´éœ²æœåŠ¡ã€‚
- æœåŠ¡å®¹å™¨çš„åŠ è½½å†…å®¹å¯ä»¥æ‰©å±•ï¼Œå†…ç½®äº† spring, jetty, log4j ç­‰åŠ è½½ï¼Œå¯é€šè¿‡å®¹å™¨æ‰©å±•ç‚¹è¿›è¡Œæ‰©å±•ã€‚é…ç½®é…åœ¨ java å‘½ä»¤çš„ -D å‚æ•°æˆ–è€… dubbo.properties ä¸­ã€‚

## 56.1 Container ##
com.alibaba.dubbo.container.Container ï¼ŒæœåŠ¡å®¹å™¨æ¥å£ã€‚

- @SPI("spring") æ³¨è§£ï¼ŒDubbo SPI æ‹“å±•ç‚¹ï¼Œé»˜è®¤ä¸º "spring" ã€‚
- å®šä¹‰äº†å®¹å™¨çš„å¯åŠ¨å’Œåœæ­¢ä¸¤ä¸ªæ–¹æ³•ã€‚

### 56.1.1 SpringContainer ###
com.alibaba.dubbo.container.spring.SpringContainer ï¼Œå®ç° Container æ¥å£ï¼ŒSpring å®¹å™¨å®ç°ç±»ã€‚

````
public class SpringContainer implements Container {
    private static final Logger logger = LoggerFactory.getLogger(SpringContainer.class);
    /**
     * Spring é…ç½®å±æ€§ KEY
     */
    public static final String SPRING_CONFIG = "dubbo.spring.config";
    /**
     * é»˜è®¤é…ç½®æ–‡ä»¶åœ°å€
     */
    public static final String DEFAULT_SPRING_CONFIG = "classpath*:META-INF/spring/*.xml";
    /**
     * Spring Context
     * é™æ€å±æ€§ï¼Œå…¨å±€å”¯ä¸€
     */
    static ClassPathXmlApplicationContext context;
    public static ClassPathXmlApplicationContext getContext() {
        return context;
    }
    @Override
    public void start() {
        // è·å¾— Spring é…ç½®æ–‡ä»¶çš„åœ°å€
        String configPath = ConfigUtils.getProperty(SPRING_CONFIG);
        if (configPath == null || configPath.length() == 0) {
            configPath = DEFAULT_SPRING_CONFIG;
        }
        // åˆ›å»º Spring Context å¯¹è±¡
        context = new ClassPathXmlApplicationContext(configPath.split("[,\\s]+"));
        // å¯åŠ¨ Spring Context ï¼Œä¼šè§¦å‘ ContextStartedEvent äº‹ä»¶
        context.start();
    }
    @Override
    public void stop() {
        try {
            if (context != null) {
                // åœæ­¢ Spring Context ï¼Œä¼šè§¦å‘ ContextStoppedEvent äº‹ä»¶ã€‚
                context.stop();
                // å…³é—­ Spring Context ï¼Œä¼šè§¦å‘ ContextClosedEvent äº‹ä»¶ã€‚
                context.close();
                context = null;
            }
        } catch (Throwable e) {
            logger.error(e.getMessage(), e);
        }
    }
}
````

- start() æ–¹æ³•ï¼Œå¯åŠ¨ Spring ã€‚
1. è°ƒç”¨ ConfigUtils#getProperty(key) æ–¹æ³•ï¼Œè·å¾— Spring é…ç½®æ–‡ä»¶çš„åœ°å€ã€‚ä¼˜å…ˆçº§ä¸ºï¼š
	1. ã€é«˜ã€‘JVM å¯åŠ¨å‚æ•°ï¼š-Ddubbo.spring.config=è‡ªå®šä¹‰ XML è·¯å¾„ ã€‚
	2. ã€ä½ã€‘Dubbo Properties é…ç½®æ–‡ä»¶ï¼šdubbo.spring.config=è‡ªå®šä¹‰ XML è·¯å¾„ ã€‚
2. æœªé…ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„ DEFAULT_SPRING_CONFIG ã€‚
3. åˆ›å»º Spring Context å¯¹è±¡ã€‚
4. è°ƒç”¨ ClassPathXmlApplicationContext#start() æ–¹æ³•ï¼Œå¯åŠ¨ Spring Context ã€‚é€šè¿‡ Spring å¯åŠ¨ï¼ŒåŠ è½½æˆ‘ä»¬çš„ Dubbo é…ç½®ï¼Œä»è€Œå¯åŠ¨ Dubbo æœåŠ¡ã€‚
- stop() æ–¹æ³•ï¼Œå…³é—­ Spring ã€‚
1. è°ƒç”¨ ClassPathXmlApplicationContext#stop() æ–¹æ³•ï¼Œåœæ­¢ Spring Context ã€‚
2. è°ƒç”¨ ClassPathXmlApplicationContext#close() æ–¹æ³•ï¼Œå…³é—­ Spring Context ã€‚

----

# 57 é›†ç¾¤å®¹é”™ï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ API #
## 57.1 Cluster ##
com.alibaba.dubbo.rpc.cluster.Cluster ï¼Œé›†ç¾¤æ¥å£ã€‚

- @SPI(FailoverCluster.NAME) æ³¨è§£ï¼ŒDubbo SPI æ‹“å±•ç‚¹ï¼Œé»˜è®¤ä¸º "failover" ï¼Œå³å¤±è´¥é‡è¯•ï¼Œä¹Ÿå°±æ˜¯ä¼šè´¯ç©¿æœ¬æ–‡çš„ FailoverCluster ç±»ã€‚
- @Adaptive æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Cluster å®ç°ï¼Œä½¿ç”¨ URL.cluster å±æ€§ã€‚
- join(Directory<T>) æ¥å£æ–¹æ³•ï¼ŒåŸºäº Directory ï¼Œåˆ›å»º Invoker å¯¹è±¡ï¼Œå®ç°ç»Ÿä¸€ã€é€æ˜çš„ Invoker è°ƒç”¨è¿‡ç¨‹ã€‚

### 57.1.1 join æ–¹æ³• ###
åœ¨ RegistryProtocol çš„ #doRefer(Cluster, Registry, type, url) æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ Cluster#join(directory) æ–¹æ³•ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚

## 57.2 FailoverCluster ##
com.alibaba.dubbo.rpc.cluster.support.FailoverCluster ï¼Œå®ç° Cluster æ¥å£ï¼Œå¤±è´¥è‡ªåŠ¨åˆ‡æ¢ï¼Œå½“å‡ºç°å¤±è´¥ï¼Œé‡è¯•å…¶å®ƒæœåŠ¡å™¨ã€‚é€šå¸¸ç”¨äºè¯»æ“ä½œï¼Œä½†é‡è¯•ä¼šå¸¦æ¥æ›´é•¿å»¶è¿Ÿã€‚å¯é€šè¿‡ retries="2" æ¥è®¾ç½®é‡è¯•æ¬¡æ•°(ä¸å«ç¬¬ä¸€æ¬¡)ã€‚
å¯¹åº” Invoker ä¸º FailoverClusterInvoker ã€‚

## 57.3 AbstractClusterInvoker ##
com.alibaba.dubbo.rpc.cluster.support.AbstractClusterInvoker ï¼Œå®ç° Invoker æ¥å£ï¼ŒCluster Invoker æŠ½è±¡ç±»ï¼š

- å®ç°ä¾‹å¦‚é€‰æ‹©ä¸€ä¸ªç¬¦åˆ Invoker å¯¹è±¡ç­‰ç­‰å…¬ç”¨æ–¹æ³•
- å®šä¹‰ #doInvoke(Invocation, List<Invoker<T>>, LoadBalance) æŠ½è±¡æ–¹æ³•ï¼Œå®ç°å­ Cluster çš„ Invoker å®ç°ç±»çš„æœåŠ¡è°ƒç”¨çš„å·®å¼‚é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹ï¼š

````
protected abstract Result doInvoke(Invocation invocation, List<Invoker<T>> invokers, LoadBalance loadbalance) throws RpcException;
````
### 57.3.1 æ„é€ æ–¹æ³• ###

````
/**
 * Directory å¯¹è±¡ã€‚é€šè¿‡å®ƒï¼Œå¯ä»¥è·å¾—æ‰€æœ‰æœåŠ¡æä¾›è€…çš„ Invoker å¯¹è±¡ã€‚
 */
protected final Directory<T> directory;
/**
 * é›†ç¾¤æ—¶æ˜¯å¦æ’é™¤éå¯ç”¨( available )çš„ Invoker ï¼Œé»˜è®¤ä¸º true.é€šè¿‡ "cluster.availablecheck" é…ç½®é¡¹è®¾ç½®ã€‚
 */
protected final boolean availablecheck;
/**
 * æ˜¯å¦å·²ç»é”€æ¯,è‹¥å·²ç»é”€æ¯ï¼Œåˆ™ä¸å…è®¸åœ¨è°ƒç”¨ã€‚
 */
private AtomicBoolean destroyed = new AtomicBoolean(false);
/**
 * ç²˜æ»è¿æ¥ Invoker
 *
 * https://dubbo.gitbooks.io/dubbo-user-book/demos/stickiness.html
 * ç²˜æ»è¿æ¥ç”¨äºæœ‰çŠ¶æ€æœåŠ¡ï¼Œå°½å¯èƒ½è®©å®¢æˆ·ç«¯æ€»æ˜¯å‘åŒä¸€æä¾›è€…å‘èµ·è°ƒç”¨ï¼Œé™¤éè¯¥æä¾›è€…æŒ‚äº†ï¼Œå†è¿å¦ä¸€å°ã€‚
 * ç²˜æ»è¿æ¥å°†è‡ªåŠ¨å¼€å¯å»¶è¿Ÿè¿æ¥ï¼Œä»¥å‡å°‘é•¿è¿æ¥æ•°ã€‚
 */
private volatile Invoker<T> stickyInvoker = null;

public AbstractClusterInvoker(Directory<T> directory) {
    this(directory, directory.getUrl());
}

public AbstractClusterInvoker(Directory<T> directory, URL url) {
    // åˆå§‹åŒ– directory
    if (directory == null) {
        throw new IllegalArgumentException("service directory == null");
    }
    this.directory = directory;
    // sticky: invoker.isAvailable() should always be checked before using when availablecheck is true.
    // åˆå§‹åŒ– availablecheck
    this.availablecheck = url.getParameter(Constants.CLUSTER_AVAILABLE_CHECK_KEY, Constants.DEFAULT_CLUSTER_AVAILABLE_CHECK);
}
````

### 57.3.2 list ###
list(Invocation) æ–¹æ³•ï¼Œè·å¾—æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker é›†åˆ

### 57.3.3 select ###
select(LoadBalance, Invocation, invokers, selected) æ–¹æ³•ï¼Œä»å€™é€‰çš„ Invoker é›†åˆï¼Œé€‰æ‹©ä¸€ä¸ªæœ€ç»ˆè°ƒç”¨çš„ Invoker å¯¹è±¡ã€‚

è¯¥æ–¹æ³•ä¸»è¦å¤„ç†ç²˜æ»è¿æ¥çš„ç‰¹æ€§ï¼Œå…·ä½“ä½¿ç”¨ Loadbalance é€‰æ‹© Invoker å¯¹è±¡çš„é€»è¾‘ï¼Œåœ¨ #doselect(loadbalance, invocation, invokers, selected) æ–¹æ³•ä¸­ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è·å¾—ç²˜æ»è¿æ¥ stickyInvoker å¯¹è±¡ã€‚
	1. è·å¾—æ–¹æ³•çº§çš„ sticky é…ç½®é¡¹ã€‚
	2. è‹¥ stickyInvoker ä¸å­˜åœ¨äº invokers ä¸­ï¼Œè¯´æ˜ä¸åœ¨å€™é€‰ä¸­ï¼Œéœ€è¦ç½®ç©ºï¼Œé‡æ–°é€‰æ‹©ã€‚
	3. è·å¾—ç²˜æ»è¿æ¥ stickyInvoker å¯¹è±¡ã€‚å¦‚è¦æ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š
		1. 1ï¼‰å¼€å¯ç²˜æ»è¿æ¥çš„ç‰¹æ€§ï¼›2ï¼‰stickyInvoker ä¸å­˜åœ¨äº selected ä¸­ã€‚
		2. è‹¥å¼€å¯æ’é™¤éå¯ç”¨çš„ Invoker çš„ç‰¹æ€§ï¼Œåˆ™æ ¡éªŒ stickyInvoker æ˜¯å¦å¯ç”¨ã€‚
	4. è°ƒç”¨ #doselect(loadbalance, invocation, invokers, selected) æ–¹æ³•ï¼Œæ‰§è¡Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚
	5. è‹¥å¼€å¯ç²˜æ»è¿æ¥çš„ç‰¹æ€§ï¼Œè®°å½•æœ€ç»ˆé€‰æ‹©çš„ Invoker å¯¹è±¡ï¼Œåˆ° stickyInvoker ä¸­ã€‚

#### 57.3.3.1 doselect ####
doselect(loadbalance, invocation, invokers, selected) æ–¹æ³•ï¼Œä»å€™é€‰çš„ Invoker é›†åˆï¼Œé€‰æ‹©ä¸€ä¸ªæœ€ç»ˆè°ƒç”¨çš„ Invoker å¯¹è±¡ã€‚

æœ‰äº”ç§é€‰æ‹©æœ€ç»ˆè°ƒç”¨çš„ Invoker å¯¹è±¡çš„æ–¹å¼ã€‚
- ã€ç¬¬ä¸€ç§ã€‘å¦‚æœåªæœ‰ä¸€ä¸ªå€™é€‰çš„ Invoker å¯¹è±¡ï¼Œç›´æ¥é€‰æ‹©è¿”å›ã€‚
- ã€ç¬¬äºŒç§ã€‘å¦‚æœåªæœ‰ä¸¤ä¸ªå€™é€‰çš„ Invoker é›†åˆï¼Œé€€åŒ–ä¸ºè½®è¯¢ã€‚
- ã€ç¬¬ä¸‰ç§ã€‘è°ƒç”¨ Loadbalance#select(invokers, url, invocation) æ–¹æ³•ï¼Œä½¿ç”¨ Loadbalance ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚	
	- è¿™ç§æ–¹å¼çš„è¿”å›ï¼Œé€‰æ‹©çš„ Invoker å¯¹è±¡ï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š1ï¼‰ä¸å­˜åœ¨äº selected ä¸­ã€‚2ï¼‰Invoker æ˜¯å¯ç”¨çš„ï¼Œè‹¥å¼€å¯æ’é™¤éå¯ç”¨çš„ Invoker çš„ç‰¹æ€§ã€‚
- ã€ç¬¬å››ç§ã€‘è°ƒç”¨ #reselect(loadbalance, invocation, invokers, selected, availablecheck) æ–¹æ³•ï¼Œé‡æ–°é€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚å› ä¸ºæ­¤æ—¶ invokers ä¸­ï¼Œæ— æ³•æ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ Invoker å¯¹è±¡ã€‚
- ã€ç¬¬äº”ç§ã€‘é¡ºåºä»å€™é€‰çš„ invokers é›†åˆä¸­ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ï¼Œä¸è€ƒè™‘æ˜¯å¦å¯ç”¨ï¼Œåˆæˆ–è€…å·²ç»é€‰æ‹©è¿‡ï¼Œç±»ä¼¼ã€ç¬¬ä¸€ç§ã€‘ã€ç¬¬äºŒç§ã€‘çš„æ–¹å¼ã€‚

#### 57.3.3.2 reselect ####
reselect(loadbalance, invocation, invokers, selected, availablecheck) æ–¹æ³•ï¼Œé‡æ–°é€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚

1. é¢„å…ˆåˆ›å»ºä¸€ä¸ªé‡é€‰ Invoker é›†åˆ
	- ä¸€å…±æœ‰ä¸¤ç±»ä¸‰ç§çš„é€‰æ‹©æ–¹å¼ï¼š
		- è·å¾—éé€‰æ‹©è¿‡( invokers )ï¼Œ å¹¶ä¸”å¿…é¡»å¯ç”¨çš„ Invoker é›†åˆã€‚
		- è·å¾—éé€‰æ‹©è¿‡( invokers )ï¼Œ å¹¶ä¸”ä¸è€ƒè™‘å¯ç”¨çš„ Invoker é›†åˆã€‚
		- é€‰æ‹©è¿‡( selected )ï¼Œå¹¶ä¸”å¿…é¡»å¯ç”¨çš„ Invoker é›†åˆã€‚
2. è°ƒç”¨ Loadbalance#select(invokers, url, invocation) æ–¹æ³•ï¼Œä½¿ç”¨ Loadbalance ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚

### 57.3.4 invoke ###
invoke(invocation) æ–¹æ³•ï¼Œè°ƒç”¨æœåŠ¡æä¾›è€…çš„é€»è¾‘ã€‚

åŸºæœ¬é€»è¾‘å¦‚ä¸‹ï¼š
1. è°ƒç”¨ #checkWhetherDestroyed() æ–¹æ³•ï¼Œæ ¡éªŒæ˜¯å¦å·²ç»é”€æ¯ã€‚
	1. è°ƒç”¨ #list(invocation) æ–¹æ³•ï¼ŒåŸºäº Directory ï¼Œè·å¾—æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker é›†åˆã€‚
	2. è·å¾— Loadbalance å¯¹è±¡ã€‚
3. è°ƒç”¨ RpcUtils#attachInvocationIdIfAsync(url, invocation) æ–¹æ³•ï¼Œè®¾ç½®è°ƒç”¨ç¼–å·ï¼Œè‹¥æ˜¯å¼‚æ­¥è°ƒç”¨ã€‚
4. è°ƒç”¨ #doInvoke(invocation, invokers, loadbalance) æŠ½è±¡æ–¹æ³•ï¼Œæ‰§è¡Œè°ƒç”¨ã€‚

## 57.4 FailoverClusterInvoker ##
com.alibaba.dubbo.rpc.cluster.support.FailoverClusterInvoker ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailoverCluster Invoker å®ç°ç±»ã€‚
å¤±è´¥è‡ªåŠ¨åˆ‡æ¢ï¼Œå½“å‡ºç°å¤±è´¥ï¼Œé‡è¯•å…¶å®ƒæœåŠ¡å™¨ã€‚é€šå¸¸ç”¨äºè¯»æ“ä½œï¼Œä½†é‡è¯•ä¼šå¸¦æ¥æ›´é•¿å»¶è¿Ÿã€‚å¯é€šè¿‡ retries="2" æ¥è®¾ç½®é‡è¯•æ¬¡æ•°(ä¸å«ç¬¬ä¸€æ¬¡)ã€‚

æ—¶åºå›¾ï¼š

![](/picture/dubbo-failover-flow.png)

å®é™…é€»è¾‘å¾ˆç®€å•ï¼šå¾ªç¯ï¼ŒæŸ¥æ‰¾ä¸€ä¸ª Invoker å¯¹è±¡ï¼Œè¿›è¡Œè°ƒç”¨ï¼Œç›´åˆ°æˆåŠŸã€‚

doInvoke(Invocation, List<Invoker<T>>, LoadBalance) æ–¹æ³•

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. å€™é€‰çš„ Invoker é›†åˆã€‚
2. è°ƒç”¨çˆ¶ #checkInvokers(copyinvokers, invocation) æ–¹æ³•ï¼Œæ ¡éªŒå€™é€‰çš„ Invoker é›†åˆéç©ºã€‚å¦‚æœä¸ºç©ºï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
3. è·å¾—æœ€å¤§å¯è°ƒç”¨æ¬¡æ•°ï¼šæœ€å¤§å¯é‡è¯•æ¬¡æ•° +1 ã€‚é»˜è®¤æœ€å¤§å¯é‡è¯•æ¬¡æ•°Constants.DEFAULT_RETRIES = 2 ã€‚
4. le å˜é‡ï¼Œä¿å­˜æœ€åä¸€æ¬¡è°ƒç”¨çš„å¼‚å¸¸ã€‚
5. invoked å˜é‡ï¼Œä¿å­˜å·²ç»è°ƒç”¨çš„ Invoker é›†åˆã€‚
6. providers å˜é‡ï¼Œä¿å­˜å·²ç»è°ƒç”¨çš„ç½‘ç»œåœ°å€é›†åˆã€‚
7. failover æœºåˆ¶æ ¸å¿ƒå®ç°ï¼šå¦‚æœå‡ºç°è°ƒç”¨å¤±è´¥ï¼Œé‚£ä¹ˆé‡è¯•å…¶ä»–æœåŠ¡å™¨ã€‚
	1. é‡è¯•æ—¶( i > 0 )ï¼Œ è¿›è¡Œé‡æ–°é€‰æ‹©ï¼Œé¿å…é‡è¯•æ—¶ï¼Œå€™é€‰ Invoker é›†åˆï¼Œå·²å‘ç”Ÿå˜åŒ–ã€‚
	2. è°ƒç”¨çˆ¶ #select(loadbalance, invocation, copyinvokers, invoked) æ–¹æ³•ï¼Œæ ¹æ® Loadbalance è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œä» copyinvokers ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªè¢«è°ƒç”¨çš„ Invoker å¯¹è±¡ã€‚
	3. ä¿å­˜æ¯æ¬¡è°ƒç”¨çš„ Invoker å¯¹è±¡ï¼Œåˆ° invoked ä¸­ã€‚
	4. ä¿å­˜å·²ç»è°ƒç”¨çš„ Invoker é›†åˆï¼Œåˆ° Context ä¸­ã€‚
	5. è°ƒç”¨ Invoker#invoke(invocation) æ–¹æ³•ï¼Œå‘èµ· RPC è°ƒç”¨ã€‚
	6. è‹¥ le éç©ºï¼Œè¯´æ˜æ­¤æ—¶æ˜¯é‡è¯•è°ƒç”¨æˆåŠŸï¼Œå°†æœ€åä¸€æ¬¡è°ƒç”¨çš„å¼‚å¸¸ä¿¡æ¯ä»¥ warn çº§åˆ«æ—¥å¿—è¾“å‡ºï¼Œæ–¹ä¾¿æœªæ¥è¿½æº¯ã€‚
	7. å¦‚æœæ˜¯ä¸šåŠ¡æ€§è´¨çš„å¼‚å¸¸ï¼Œä¸å†é‡è¯•ï¼Œç›´æ¥æŠ›å‡ºã€‚
	8. ä¿å­˜å¼‚å¸¸åˆ° le ã€‚
	9. é RpcException å¼‚å¸¸ï¼Œå°è£…æˆ RpcException å¼‚å¸¸ã€‚
	10. ä¿å­˜æ¯æ¬¡è°ƒç”¨çš„ç½‘ç»œåœ°å€ï¼Œåˆ° providers ä¸­ã€‚
8. è¶…è¿‡æœ€å¤§è°ƒç”¨æ¬¡æ•°ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚è¯¥å¼‚å¸¸ä¸­ï¼Œå¸¦æœ‰æœ€åä¸€æ¬¡è°ƒç”¨å¼‚å¸¸çš„ä¿¡æ¯ã€‚

----

# 58 é›†ç¾¤å®¹é”™ï¼ˆäºŒï¼‰ä¹‹ Cluster å®ç° #

## 58.1 AvailableCluster ##
com.alibaba.dubbo.rpc.cluster.support.AvailableCluster ï¼Œå®ç° Cluster æ¥å£ï¼Œè°ƒç”¨é¦–ä¸ªå¯ç”¨æœåŠ¡å™¨ï¼Œç›®å‰ç”¨äºå¤šæ³¨å†Œä¸­å¿ƒå¼•ç”¨ã€‚

å¯¹åº” Invoker å®ç°ç±»ä¸º AvailableClusterInvoker ã€‚

### 58.1.1AvailableClusterInvoker ###
com.alibaba.dubbo.rpc.cluster.support.AvailableClusterInvoker ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒAvailableCluster Invoker å®ç°ç±»ã€‚

## 58.2 BroadcastCluster ##
com.alibaba.dubbo.rpc.cluster.support.BroadcastCluster ï¼Œå®ç° Cluster æ¥å£ï¼Œå¹¿æ’­è°ƒç”¨æ‰€æœ‰æä¾›è€…ï¼Œé€ä¸ªè°ƒç”¨ï¼Œä»»æ„ä¸€å°æŠ¥é”™åˆ™æŠ¥é”™ã€‚é€šå¸¸ç”¨äºé€šçŸ¥æ‰€æœ‰æä¾›è€…æ›´æ–°ç¼“å­˜æˆ–æ—¥å¿—ç­‰æœ¬åœ°èµ„æºä¿¡æ¯ã€‚

å¯¹åº” Invoker å®ç°ç±»ä¸º BroadcastClusterInvoker ã€‚

### 58.2.1 BroadcastClusterInvoker ###
com.alibaba.dubbo.rpc.cluster.support.BroadcastClusterInvoker ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒBroadcastCluster Invoker å®ç°ç±»ã€‚

## 58.3 FailbackCluster ##
com.alibaba.dubbo.rpc.cluster.support.FailbackCluster ï¼Œå®ç° Cluster æ¥å£ï¼Œå¤±è´¥è‡ªåŠ¨æ¢å¤ï¼Œåå°è®°å½•å¤±è´¥è¯·æ±‚ï¼Œå®šæ—¶é‡å‘ã€‚é€šå¸¸ç”¨äºæ¶ˆæ¯é€šçŸ¥æ“ä½œã€‚

å¯¹åº” Invoker å®ç°ç±»ä¸º FailbackClusterInvoker ã€‚

### 58.4.1 FailbackClusterInvoker ###
com.alibaba.dubbo.rpc.cluster.support.FailbackClusterInvoker ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailbackCluster Invoker å®ç°ç±»ã€‚

#### 58.4.1.1 æ„é€ æ–¹æ³• ####
````
/** é‡è¯•é¢‘ç‡ */
private static final long RETRY_FAILED_PERIOD = 5 * 1000;

/** ScheduledExecutorService å¯¹è±¡ */
private final ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(2, new NamedThreadFactory("failback-cluster-timer", true));
/** å¤±è´¥ä»»åŠ¡é›†åˆ */
private final ConcurrentMap<Invocation, AbstractClusterInvoker<?>> failed = new ConcurrentHashMap<Invocation, AbstractClusterInvoker<?>>();
/** é‡è¯•ä»»åŠ¡ Future */
private volatile ScheduledFuture<?> retryFuture;

public FailbackClusterInvoker(Directory<T> directory) {
    super(directory);
}
````
#### 58.4.1.2 doInvoke ####

è‹¥ RPC è°ƒç”¨å¤±è´¥ï¼Œåˆ™è°ƒç”¨ #addFailed(invocation, this) æ–¹æ³•ï¼Œæ·»åŠ åˆ° failed ä¸­ï¼Œåå°å®šæ—¶é‡è¯•ã€‚

#### 58.4.1.3 addFailed ####
åˆ›å»ºçš„å®šæ—¶ä»»åŠ¡ï¼Œä¼šè°ƒç”¨ #retryFailed() æ–¹æ³•ï¼Œé‡è¯•ä»»åŠ¡ï¼Œå‘èµ· RCP è°ƒç”¨ã€‚

#### 58.4.1.4 retryFailed ####
å¾ªç¯é‡è¯•ä»»åŠ¡ï¼Œé€ä¸ªå‘èµ· RPC è°ƒç”¨ã€‚è‹¥è°ƒç”¨æˆåŠŸï¼Œç§»é™¤è¯¥å¤±è´¥ä»»åŠ¡å‡º failed é›†åˆã€‚

## 58.5 FailfastCluster ##
com.alibaba.dubbo.rpc.cluster.support.FailfastCluster ï¼Œå®ç° Cluster æ¥å£ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œåªå‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œå¤±è´¥ç«‹å³æŠ¥é”™ã€‚é€šå¸¸ç”¨äºéå¹‚ç­‰æ€§çš„å†™æ“ä½œï¼Œæ¯”å¦‚æ–°å¢è®°å½•ã€‚

å¯¹åº” Invoker å®ç°ç±»ä¸º FailfastClusterInvoker ã€‚

### 58.5.1 FailfastInvoker ###
com.alibaba.dubbo.rpc.cluster.support.FailbackClusterInvoker ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailfast Invoker å®ç°ç±»ã€‚

å’Œ FailbackClusterInvoker å·®å¼‚ç‚¹ï¼Œåœ¨äºå¯¹å¼‚å¸¸çš„å¤„ç†ã€‚



## 58.6 FailsafeCluster ##
com.alibaba.dubbo.rpc.cluster.support.FailsafeCluster ï¼Œå®ç° Cluster æ¥å£ï¼Œå¤±è´¥å®‰å…¨ï¼Œå‡ºç°å¼‚å¸¸æ—¶ï¼Œç›´æ¥å¿½ç•¥ã€‚é€šå¸¸ç”¨äºå†™å…¥å®¡è®¡æ—¥å¿—ç­‰æ“ä½œã€‚

å¯¹åº” Invoker å®ç°ç±»ä¸º FailsafeClusterInvoker ã€‚

### 58.6.2 FailsafeClusterInvoker ###
com.alibaba.dubbo.rpc.cluster.support.FailsafeClusterInvoker ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailsafe Invoker å®ç°ç±»ã€‚

å’Œ FailfastInvoker å·®å¼‚ç‚¹ï¼Œåœ¨äºå¯¹å¼‚å¸¸çš„å¤„ç†ã€‚

## 58.6 ForkingCluster ##
com.alibaba.dubbo.rpc.cluster.support.ForkingCluster ï¼Œå®ç° Cluster æ¥å£ï¼Œå¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡å™¨ï¼Œåªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ã€‚é€šå¸¸ç”¨äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„è¯»æ“ä½œï¼Œä½†éœ€è¦æµªè´¹æ›´å¤šæœåŠ¡èµ„æºã€‚å¯é€šè¿‡ forks="2" æ¥è®¾ç½®æœ€å¤§å¹¶è¡Œæ•°ã€‚

### 58.6.1 ForkingClusterInvoker ###
com.alibaba.dubbo.rpc.cluster.support.ForkingClusterInvoker ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒForkingCluster Invoker å®ç°ç±»ã€‚

----

# 59 é›†ç¾¤å®¹é”™ï¼ˆä¸‰ï¼‰ä¹‹ Directory å®ç° #
Directory ï¼Œä¸­æ–‡ç›´è¯‘ä¸ºç›®å½•ï¼Œä»£è¡¨äº†å¤šä¸ª Invoker ï¼Œå¯ä»¥æŠŠå®ƒçœ‹æˆ List<Invoker> ã€‚ä½†ä¸ List ä¸åŒçš„æ˜¯ï¼Œå®ƒçš„å€¼å¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ¯”å¦‚æ³¨å†Œä¸­å¿ƒæ¨é€å˜æ›´ã€‚

- StaticDirectory ï¼Œé™æ€ Directory å®ç°ç±»ï¼Œä»å‘½åä¸Šçœ‹å‡ºå®ƒæ˜¯é™æ€çš„ List<Invoker> ã€‚
- RegistryDirectory ï¼ŒåŸºäºæ³¨å†Œä¸­å¿ƒçš„åŠ¨æ€ Directory å®ç°ç±»ï¼Œä»å‘½åä¸Šçœ‹å‡ºå®ƒæ˜¯åŠ¨æ€çš„ï¼Œä¼šæ ¹æ®æ³¨å†Œä¸­å¿ƒçš„æ¨é€å˜æ›´ List<Invoker> ã€‚

## 59.1 Directory ##
com.alibaba.dubbo.rpc.cluster.Directory ï¼Œç»§æ‰¿ Node æ¥å£ï¼ŒDirectory æ¥å£

å®šä¹‰äº†ä¸¤ä¸ªæ¥å£æ–¹æ³•ï¼Œåˆ†åˆ«è¿”å›æœåŠ¡çš„ç±»å‹å’Œ Invoker é›†åˆã€‚
ä¸€ä¸ª Directory åªå¯¹åº”ä¸€ä¸ªæœåŠ¡ç±»å‹ã€‚
## 59.2 AbstractDirectory ##

com.alibaba.dubbo.rpc.cluster.directory.AbstractDirectory ï¼Œå®ç° Directory æ¥å£ï¼ŒDirectory æŠ½è±¡å®ç°ç±»ï¼Œå®ç°äº†å…¬ç”¨çš„è·¯ç”±è§„åˆ™( Router )çš„é€»è¾‘ã€‚

### 59.2.1 æ„é€ æ–¹æ³• ###
````
/** æ˜¯å¦å·²ç»é”€æ¯ */
private volatile boolean destroyed = false;
/** æ³¨å†Œä¸­å¿ƒ URL */
private final URL url;
/**
 * æ¶ˆè´¹è€… URL
 *
 * è‹¥æœªæ˜¾ç¤ºè°ƒç”¨ {@link #AbstractDirectory(URL, URL, List)} æ„é€ æ–¹æ³•ï¼ŒconsumerUrl ç­‰äº {@link #url}
 */
private volatile URL consumerUrl;
/** Router æ•°ç»„ */
private volatile List<Router> routers;

public AbstractDirectory(URL url) {
    this(url, null);
}

public AbstractDirectory(URL url, List<Router> routers) {
    this(url, url, routers);
}

public AbstractDirectory(URL url, URL consumerUrl, List<Router> routers) {
    if (url == null) {
        throw new IllegalArgumentException("url == null");
    }
    this.url = url;
    this.consumerUrl = consumerUrl;
    // è®¾ç½® Router æ•°ç»„
    setRouters(routers);
}
````

è°ƒç”¨ #setRouters(routers) æ–¹æ³•ï¼Œåˆå§‹åŒ–å¹¶è®¾ç½® Router æ•°ç»„ã€‚
### 59.2.2 setRouters ###
setRouters(routers) æ–¹æ³•ï¼Œåˆå§‹åŒ–å¹¶è®¾ç½® Router æ•°ç»„ã€‚

### 59.2.3 list ###
list(Invocation) å®ç°æ–¹æ³•ï¼Œè·å¾—æ‰€æœ‰æœåŠ¡ Invoker é›†åˆã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è·å¾—æ‰€æœ‰ Invoker é›†åˆ
2. æ ¹æ®è·¯ç”±è§„åˆ™ï¼Œç­›é€‰ Invoker é›†åˆ

## 59.3 RegistryDirectory ##
com.alibaba.dubbo.registry.integration.RegistryDirectory ï¼Œå®ç° NotifyListener æ¥å£ï¼Œå®ç° AbstractDirectory æŠ½è±¡ç±»ï¼ŒåŸºäºæ³¨å†Œä¸­å¿ƒçš„ Directory å®ç°ç±»ã€‚

- RegistryDirectory åœ¨ dubbo-registry æ¨¡å—ï¼Œintegration åŒ…ä¸‹ï¼Œæ˜¯ Dubbo æ³¨å†Œä¸­å¿ƒæ¨¡å—é›†æˆ Directory çš„å®ç°ç±»ã€‚
- RegistryDirectory ä½œä¸ºä¸€ä¸ª NotifyListener ï¼Œè®¢é˜…æ³¨å†Œä¸­å¿ƒ( Registry ) çš„æ•°æ®ï¼Œå®ç°å¯¹å˜æ›´çš„ç›‘å¬ã€‚

### 59.3.1 æ„é€ æ–¹æ³• ###

````
// ========== Dubbo SPI Adaptive å¯¹è±¡ BEGIN ==========

/**
 * Cluster$Adaptive å¯¹è±¡
 */
private static final Cluster cluster = ExtensionLoader.getExtensionLoader(Cluster.class).getAdaptiveExtension();
/**
 * RouterFactory$Adaptive å¯¹è±¡
 */
private static final RouterFactory routerFactory = ExtensionLoader.getExtensionLoader(RouterFactory.class).getAdaptiveExtension();
/**
 * ConfiguratorFactory$Adaptive å¯¹è±¡
 */
private static final ConfiguratorFactory configuratorFactory = ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class).getAdaptiveExtension();

// ========== æœåŠ¡æ¶ˆè´¹è€…ç›¸å…³ BEGIN ==========

/**
 * æœåŠ¡ç±»å‹ï¼Œä¾‹å¦‚ï¼šcom.alibaba.dubbo.demo.DemoService
 */
private final Class<T> serviceType; // Initialization at construction time, assertion not null
/**
 * Consumer URL çš„é…ç½®é¡¹ Map
 */
private final Map<String, String> queryMap; // Initialization at construction time, assertion not null
/**
 * æœåŠ¡æ–¹æ³•æ•°ç»„
 */
private final String[] serviceMethods;
/**
 * æ˜¯å¦å¼•ç”¨å¤šåˆ†ç»„
 *
 * æœåŠ¡åˆ†ç»„ï¼šhttps://dubbo.gitbooks.io/dubbo-user-book/demos/service-group.html
 */
private final boolean multiGroup;

// ========== æ³¨å†Œä¸­å¿ƒç›¸å…³ BEGIN ==========

/**
 * æ³¨å†Œä¸­å¿ƒçš„ Protocol å¯¹è±¡
 */
private Protocol protocol; // Initialization at the time of injection, the assertion is not null
/**
 * æ³¨å†Œä¸­å¿ƒ
 */
private Registry registry; // Initialization at the time of injection, the assertion is not null
/**
 * æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡ç±»ï¼Œç›®å‰æ˜¯ com.alibaba.dubbo.registry.RegistryService
 *
 * é€šè¿‡ {@link #url} çš„ {@link URL#getServiceKey()} è·å¾—
 */
private final String serviceKey; // Initialization at construction time, assertion not null
/**
 * æ˜¯å¦ç¦æ­¢è®¿é—®ã€‚
 *
 * æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´ï¼š
 *
 * 1. æ²¡æœ‰æœåŠ¡æä¾›è€…
 * 2. æœåŠ¡æä¾›è€…è¢«ç¦ç”¨
 */
private volatile boolean forbidden = false;

// ========== é…ç½®è§„åˆ™ç›¸å…³ BEGIN ==========

/**
 * åŸå§‹çš„ç›®å½• URL
 *
 * ä¾‹å¦‚ï¼šzookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&callbacks=1000&check=false&client=netty4&cluster=failback&dubbo=2.0.0&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello,callbackParam,save,update,say03,delete,say04,demo,say01,bye,say02,saves&payload=1000&pid=63400&qos.port=33333&register.ip=192.168.16.23&sayHello.async=true&side=consumer&timeout=10000&timestamp=1527056491064
 */
private final URL directoryUrl; // Initialization at construction time, assertion not null, and always assign non null value
/**
 * è¦†å†™çš„ç›®å½• URL ï¼Œç»“åˆé…ç½®è§„åˆ™
 */
private volatile URL overrideDirectoryUrl; // Initialization at construction time, assertion not null, and always assign non null value
/**
 * é…ç½®è§„åˆ™æ•°ç»„
 *
 * override rules
 * Priority: override>-D>consumer>provider
 * Rule one: for a certain provider <ip:port,timeout=100>
 * Rule two: for all providers <* ,timeout=5000>
 */
private volatile List<Configurator> configurators; // The initial value is null and the midway may be assigned to null, please use the local variable reference

// ========== æœåŠ¡æä¾›è€…ç›¸å…³ BEGIN ==========

/**
 * [url]ä¸[æœåŠ¡æä¾›è€… Invoker é›†åˆ]çš„æ˜ å°„ç¼“å­˜
 */
// Map<url, Invoker> cache service url to invoker mapping.
private volatile Map<String, Invoker<T>> urlInvokerMap; // The initial value is null and the midway may be assigned to null, please use the local variable reference
/**
 * [æ–¹æ³•å]ä¸[æœåŠ¡æä¾›è€… Invoker é›†åˆ]çš„æ˜ å°„ç¼“å­˜
 */
// Map<methodName, Invoker> cache service method to invokers mapping.
private volatile Map<String, List<Invoker<T>>> methodInvokerMap; // The initial value is null and the midway may be assigned to null, please use the local variable reference
/**
 * [æœåŠ¡æä¾›è€… Invoker é›†åˆ]ç¼“å­˜
 */
// Set<invokerUrls> cache invokeUrls to invokers mapping.
private volatile Set<URL> cachedInvokerUrls; // The initial value is null and the midway may be assigned to null, please use the local variable reference

public RegistryDirectory(Class<T> serviceType, URL url) {
    super(url);
    if (serviceType == null) {
        throw new IllegalArgumentException("service type is null.");
    }
    if (url.getServiceKey() == null || url.getServiceKey().length() == 0) {
        throw new IllegalArgumentException("registry serviceKey is null.");
    }
    this.serviceType = serviceType;
    this.serviceKey = url.getServiceKey();
    // è·å¾— queryMap
    this.queryMap = StringUtils.parseQueryString(url.getParameterAndDecoded(Constants.REFER_KEY));
    // è·å¾— overrideDirectoryUrl å’Œ directoryUrl
    this.overrideDirectoryUrl = this.directoryUrl = url.setPath(url.getServiceInterface()).clearParameters().addParameters(queryMap).removeParameter(Constants.MONITOR_KEY);
    // åˆå§‹åŒ– multiGroup
    String group = directoryUrl.getParameter(Constants.GROUP_KEY, "");
    this.multiGroup = group != null && ("*".equals(group) || group.contains(","));
    // åˆå§‹åŒ– serviceMethods
    String methods = queryMap.get(Constants.METHODS_KEY);
    this.serviceMethods = methods == null ? null : Constants.COMMA_SPLIT_PATTERN.split(methods);
}
````

### 59.3.2 subscribe ###
subscribe(URL) æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒå‘èµ·è®¢é˜…ã€‚

### 59.3.3 notify ###
åœ¨æ³¨å†Œä¸­å¿ƒ( Registry )å‘ç°æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥å¯¹åº”çš„ NotifyListener ä»¬ã€‚

notify(List<URL> urls) å®ç°æ–¹æ³•
1. æ ¹æ® URL çš„åˆ†ç±»æˆ–åè®®ï¼Œåˆ†æˆç»„ä¸‰ä¸ªé›†åˆï¼š1ï¼‰æœåŠ¡æä¾›è€… + 2ï¼‰è·¯ç”±è§„åˆ™ + 3ï¼‰é…ç½®è§„åˆ™ã€‚
2. éç©ºï¼Œè°ƒç”¨ #toConfigurators(configuratorUrls) æ–¹æ³•ï¼Œå¤„ç†é…ç½®è§„åˆ™ URL é›†åˆã€‚
3. éç©ºï¼Œè°ƒç”¨ #toRouters(routerUrls) æ–¹æ³•ï¼Œå¤„ç†è·¯ç”±è§„åˆ™ URL é›†åˆã€‚
	1. è‹¥è½¬æ¢åˆ° routers éç©ºï¼Œè°ƒç”¨çˆ¶ #setRouters(routers) æ–¹æ³•ï¼Œè®¾ç½®è·¯ç”±è§„åˆ™ã€‚
2. åˆå¹¶é…ç½®è§„åˆ™ï¼Œåˆ° directoryUrl ä¸­ï¼Œå½¢æˆ overrideDirectoryUrl å˜é‡ã€‚
3. è°ƒç”¨ #refreshInvoker(invokerUrls) æ–¹æ³•ï¼Œå¤„ç†æœåŠ¡æä¾›è€… URL é›†åˆã€‚

### 59.3.4 å†…éƒ¨ç±» ###
#### 59.3.4.1 InvokerDelegate ####
InvokerDelegate ï¼Œå®ç° com.alibaba.dubbo.rpc.protocol.InvokerWrapper ç±»ï¼ŒInvoker ä»£ç†ç±»ï¼Œä¸»è¦ç”¨äºå­˜å‚¨æ³¨å†Œä¸­å¿ƒä¸‹å‘çš„ url åœ°å€( providerUrl )ï¼Œç”¨äºé‡æ–°é‡æ–° refer æ—¶èƒ½å¤Ÿæ ¹æ® providerURL queryMap overrideMap é‡æ–°ç»„è£…ã€‚

#### 59.3.4.2 InvokerComparator ####
InvokerComparator ï¼Œå®ç° Comparator æ¥å£ï¼ŒInvoker æ’åºå™¨å®ç°ç±»ï¼Œæ ¹æ® URL å‡åº ã€‚

#### 59.3.4.3 refreshInvoker ####
refreshInvoker(List<URL> invokerUrls) æ–¹æ³•ï¼Œå®˜æ–¹æ³¨é‡Šå…¶å¦‚ä¸‹
æ ¹æ® invokerURL åˆ—è¡¨è½¬æ¢ä¸º invoker åˆ—è¡¨ã€‚è½¬æ¢è§„åˆ™å¦‚ä¸‹ï¼š

- å¦‚æœ url å·²ç»è¢«è½¬æ¢ä¸º invoker ï¼Œåˆ™ä¸åœ¨é‡æ–°å¼•ç”¨ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œæ³¨æ„å¦‚æœ url ä¸­ä»»ä½•ä¸€ä¸ªå‚æ•°å˜æ›´ä¹Ÿä¼šé‡æ–°å¼•ç”¨
- å¦‚æœä¼ å…¥çš„ invoker åˆ—è¡¨ä¸ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæœ€æ–°çš„ invoker åˆ—è¡¨
- å¦‚æœä¼ å…¥çš„ invokerUrl åˆ—è¡¨æ˜¯ç©ºï¼Œåˆ™è¡¨ç¤ºåªæ˜¯ä¸‹å‘çš„ override è§„åˆ™æˆ– route è§„åˆ™ï¼Œéœ€è¦é‡æ–°äº¤å‰å¯¹æ¯”ï¼Œå†³å®šæ˜¯å¦éœ€è¦é‡æ–°å¼•ç”¨ã€‚

åŸºæœ¬é€»è¾‘å¦‚ä¸‹ï¼š

**ç¬¬ä¸€éƒ¨åˆ†**
1. å½“ invokerUrls é›†åˆå¤§å°ä¸º 1 ï¼Œå¹¶ä¸”åè®®ä¸º empty:// ï¼Œè¯´æ˜æ‰€æœ‰æœåŠ¡æä¾›è€…éƒ½å·²ç»ä¸‹çº¿ã€‚è‹¥æ³¨å†Œä¸­å¿ƒä¸º Zookeeper ï¼Œå¯å‚è§ ZookeeperRegistry#toUrlsWithEmpty(URL consumer, String path, List<String> providers) æ–¹æ³•ã€‚
2. è®¾ç½®ç¦æ­¢è®¿é—®ï¼Œå› ä¸ºæ²¡æœ‰æœåŠ¡æä¾›è€…äº†ã€‚
3. methodInvokerMap ç½®ç©ºã€‚
4. è°ƒç”¨ #destroyAllInvokers() æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker é›†åˆã€‚

**ç¬¬äºŒéƒ¨åˆ†**
1. è®¾ç½®å…è®¸è®¿é—®ï¼Œå› ä¸ºæœ‰æœåŠ¡æä¾›è€…äº†ã€‚
2. ä¼ å…¥çš„ invokerUrls ä¸ºç©ºï¼Œè¯´æ˜æ˜¯è·¯ç”±è§„åˆ™æˆ–é…ç½®è§„åˆ™å‘ç”Ÿæ”¹å˜ï¼Œæ­¤æ—¶ invokerUrls æ˜¯ç©ºçš„ï¼Œç›´æ¥ä½¿ç”¨ cachedInvokerUrls ã€‚å¯¹åº”å®˜æ–¹æ³¨é‡Šã€ç¬¬ 3 ç‚¹ã€‘ï¼ˆéƒ¨åˆ†ï¼Œä¸åŒ…æ‹¬â€œéœ€è¦é‡æ–°äº¤å‰å¯¹æ¯”ï¼Œå†³å®šæ˜¯å¦éœ€è¦é‡æ–°å¼•ç”¨â€ï¼‰ã€‚
3. ä¼ å…¥çš„ invokerUrls éç©ºï¼Œæ›´æ–° cachedInvokerUrls ã€‚è€ƒè™‘åˆ°å¹¶å‘çš„é—®é¢˜ï¼Œæ›´æ–°çš„æ–¹å¼ä¸ºåˆ›å»ºæ–°çš„ HashSet ã€‚å¯¹åº”å®˜æ–¹æ³¨é‡Šã€ç¬¬ 2 ç‚¹ã€‘ã€‚
4. å¿½ç•¥ï¼Œè‹¥æ—  invokerUrls ã€‚å‡ºç°æƒ…å†µä¸ºï¼Œåˆå§‹æ˜¯æŒ‰ç…§ configurators => routers => providers ï¼Œæ‰€ä»¥å‰ä¸¤ä¸ªä¼šå‡ºç°è¿™ä¸ªæƒ…å†µã€‚
5. è°ƒç”¨ #toInvokers(List<URL> urls) æ–¹æ³•ï¼Œå°†ä¼ å…¥çš„ invokerUrls ï¼Œè½¬æ¢æˆæ–°çš„ urlInvokerMap ã€‚
6. è°ƒç”¨ #toMethodInvokers(newUrlInvokerMap) æ–¹æ³•ï¼Œå°† urlInvokerMap è½¬æˆä¸æ–¹æ³•çš„æ˜ å°„å…³ç³»ï¼Œå³æ–°çš„ methodInvokerMap ã€‚
7. å¦‚æœè®¡ç®—é”™è¯¯ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯é˜²å¾¡æ€§ç¼–ç¨‹ã€‚
8. è‹¥æœåŠ¡å¼•ç”¨å¤š group ï¼Œåˆ™è°ƒç”¨ #toMergeMethodInvokerMap(newMethodInvokerMap) æ–¹æ³•ï¼ŒæŒ‰ç…§ method + group èšåˆ Invoker é›†åˆã€‚
9. èµ‹å€¼ urlInvokerMap å±æ€§ã€‚
10. è°ƒç”¨ #destroyUnusedInvokers(oldUrlInvokerMap, newUrlInvokerMap) æ–¹æ³•ï¼Œé”€æ¯ä¸å†ä½¿ç”¨çš„ Invoker é›†åˆã€‚

##### 59.3.4.3.1 toInvokers #####
å°†ä¼ å…¥çš„urlsè½¬æ¢æˆurlInvokerMap

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. newUrlInvokerMap å˜é‡ï¼Œæ–°çš„ urlInvokerMap å­—æ®µï¼Œåé¢ä¼šèµ‹å€¼ç»™å®ƒã€‚
2. è‹¥ urls ä¸ºç©ºï¼Œç›´æ¥è¿”å›ï¼Œé˜²å¾¡æ€§ç¼–ç¨‹ã€‚
3. å·²åˆå§‹åŒ–çš„æœåŠ¡å™¨æä¾› URL é›†åˆï¼Œå³æœåŠ¡æä¾›è€… URL å·²ç»å¤„ç†ã€‚
4. è·å¾—å¼•ç”¨æœåŠ¡çš„åè®®ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šè®¾ç½® <dubbo:reference protocol=""/> é…ç½®é¡¹ã€‚
5. å¾ªç¯ urls é›†åˆï¼Œè½¬æˆ Invoker é›†åˆã€‚
6. åè®®å¤„ç†
	1. å¦‚æœ reference ç«¯é…ç½®äº† protocol ï¼Œåˆ™åªé€‰æ‹©åŒ¹é…çš„ protocol ã€‚
	2. å¿½ç•¥ï¼Œè‹¥ä¸º empty:// åè®®ã€‚
	3. å¿½ç•¥ï¼Œè‹¥åº”ç”¨ç¨‹åºä¸æ”¯æŒè¯¥åè®®ã€‚
4. è°ƒç”¨ #mergeUrl(providerUrl) æ–¹æ³•ï¼Œåˆå¹¶ URL å‚æ•°ã€‚
5. å¿½ç•¥ï¼Œé€šè¿‡ keys åˆ¤æ–­å·²ç»åˆå§‹åŒ–ã€‚
	1. è‹¥æœªåˆå§‹åŒ–ï¼Œæ·»åŠ åˆ° keys ä¸­ã€‚
2. â€œåˆ›å»ºâ€æœåŠ¡ Invoker å¯¹è±¡ã€‚
	1. è·å¾— url å¯¹åº”åœ¨ localUrlInvokerMap ç¼“å­˜çš„ Invoker å¯¹è±¡ã€‚
	2. ä¸åœ¨ç¼“å­˜ä¸­ï¼Œéœ€è¦é‡æ–° refer å¼•ç”¨ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚
		1. é€šè¿‡é…ç½®é¡¹ enable å’Œ disable åˆ¤æ–­ï¼ŒæœåŠ¡æ˜¯å¦å¼€å¯ã€‚
		2. è‹¥å¼€å¯ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚
			1. è°ƒç”¨ Protocol$Adaptive#refer(serviceType, url) æ–¹æ³•ï¼Œå¼•ç”¨æœåŠ¡ï¼Œåˆ›å»ºæœåŠ¡æä¾›è€… Invoker å¯¹è±¡ã€‚
			2. åˆ›å»º InvokerDelegate å¯¹è±¡ã€‚
	3. åœ¨ç¼“å­˜ä¸­ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ Invoker å¯¹è±¡ï¼Œæ·»åŠ åˆ° newUrlInvokerMap ä¸­ã€‚
4. æ¸…ç©º keys ã€‚
5. è¿”å›ç»“æœ newUrlInvokerMap ã€‚

###### 59.3.4.3.1 mergeUrl ######
mergeUrl(providerUrl) æ–¹æ³•ï¼Œåˆå¹¶ URL å‚æ•°ï¼Œä¼˜å…ˆçº§ä¸ºé…ç½®è§„åˆ™ > æœåŠ¡æ¶ˆè´¹è€…é…ç½® > æœåŠ¡æä¾›è€…é…ç½®ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ ClusterUtils#mergeUrl(providerUrl, queryMap) æ–¹æ³•ï¼Œåˆå¹¶æœåŠ¡æ¶ˆè´¹è€…é…ç½®åˆ° providerUrl 
2. è®¾ç½® providerUrl ä¸æ£€æŸ¥è¿æ¥æ˜¯å¦æˆåŠŸï¼Œæ€»æ˜¯åˆ›å»º Invoker 
3. ä»…åˆå¹¶æä¾›è€…å‚æ•°ã€‚

###### 59.3.4.3.2 toMethodInvokers ######
toMethodInvokers(Map<String, Invoker<T>> invokersMap) æ–¹æ³•ï¼Œå°† invokersMap è½¬æˆä¸æ–¹æ³•çš„æ˜ å°„å…³ç³»ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. newMethodInvokerMap å˜é‡ï¼Œæ–°çš„ methodInvokerMap å­—æ®µï¼Œåé¢ä¼šèµ‹å€¼ç»™å®ƒã€‚
1. åˆ›å»º Invoker é›†åˆã€‚å®é™…å°±æ˜¯ invokersMap çš„å€¼çš„é›†åˆã€‚
1. æŒ‰ç…§æ–¹æ³•åä¸ºç»´åº¦( KEY ) ï¼Œèšåˆå¯¹åº”çš„ Invoker é›†åˆåˆ° newMethodInvokerMap ä¸­ã€‚
1. è·¯ç”±å…¨ invokersList ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆã€‚
1. æ·»åŠ  newInvokersList åˆ° newMethodInvokerMap ä¸­ï¼Œè¡¨ç¤ºè¯¥æœåŠ¡æä¾›è€…çš„å…¨é‡ Invoker é›†åˆã€‚
1. å¾ªç¯ï¼ŒåŸºäºæ¯ä¸ªæ–¹æ³•è·¯ç”±ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆã€‚
1. å¾ªç¯æ’åºæ¯ä¸ªæ–¹æ³•çš„ Invoker é›†åˆï¼Œå¹¶è®¾ç½®ä¸ºä¸å¯å˜ã€‚

##### 59.3.4.4 toMergeMethodInvokerMap #####
toMergeMethodInvokerMap(Map<String, List<Invoker<T>>> methodMap) ï¼ŒæŒ‰ç…§ method + group èšåˆ Invoker é›†åˆã€‚

result å±æ€§ï¼Œæ–°çš„ methodInvokerMap å­—æ®µï¼Œåé¢ä¼šèµ‹å€¼ç»™å®ƒã€‚

åŸºæœ¬æµç¨‹ï¼š
1. å¾ªç¯ï¼ŒæŒ‰ç…§ method + group èšåˆ Invoker é›†åˆã€‚	
	1. æŒ‰ç…§ Group èšåˆ Invoker é›†åˆçš„ç»“æœã€‚å…¶ä¸­ï¼ŒKEYï¼šgroup ï¼ŒVALUEï¼šInvoker é›†åˆã€‚
	2. å¾ªç¯ Invoker é›†åˆï¼ŒæŒ‰ç…§ group èšåˆ Invoker é›†åˆã€‚
	3. è‹¥æ•°é‡ä¸º 1 ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªã€‚
	4. è‹¥æ•°é‡ä¸º 0 ï¼Œä½¿ç”¨åŸæœ‰å€¼ invokers ã€‚
	5. è‹¥æ•°é‡å¤§äº 1 ï¼Œå¾ªç¯æ¯ä¸ª Group çš„ Invoker é›†åˆï¼Œè°ƒç”¨ Cluster$Adaptive#join(Directory) æ–¹æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ Cluster Invoker å¯¹è±¡ã€‚

##### 59.3.4.4.1 destroyUnusedInvokers #####
destroyUnusedInvokers(oldUrlInvokerMap, newUrlInvokerMap) æ–¹æ³•ï¼Œé”€æ¯ä¸å†ä½¿ç”¨çš„ Invoker é›†åˆã€‚

##### 59.3.4.4.2 destroyAllInvokers #####
destroyAllInvokers() æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker 

### 59.3.5 doList ###
doList(Invocation) å®ç°æ–¹æ³•ï¼Œè·å¾—å¯¹åº”çš„ Invoker é›†åˆã€‚

é€šè¿‡å››ç§æ–¹å¼ï¼Œä» methodInvokerMap ä¸­ï¼Œè·å¾—å¯¹åº”çš„ Invoker é›†åˆã€‚
- ç¬¬ä¸€ç§ï¼Œå¯æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°æšä¸¾è·¯ç”±ã€‚è¿™æ˜¯ä¸ªéå¸¸å°ä¼—çš„åœºæ™¯ï¼Œ
	- é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œè°ƒç”¨åˆ°çš„æœåŠ¡æä¾›è€…çš„ DemoServiceImpl#hello01(name) æ–¹æ³•ã€‚
	- å¦‚æœä½¿ç”¨è¯¥ç‰¹æ€§ï¼Œæ³¨æ„é¿å…å‡ºç°æ— å…³çš„å‡ ä¸ªæ–¹æ³•ï¼Œä¾‹å¦‚ #hello(name) å’Œ #hello01(name) æ˜¯æ¯«æ— å…³ç³»çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè€Œæˆ‘çœŸçš„æƒ³è°ƒç”¨ #hello(name) æ–¹æ³•ï¼Œç»“æœè°ƒç”¨åˆ°äº† #hello01(name) æ–¹æ³•ã€‚
- ç¬¬äºŒç§ï¼Œæ ¹æ®æ–¹æ³•åè·å¾— Invoker é›†åˆã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéƒ½èƒ½åŒ¹é…åˆ°ã€‚
- ç¬¬ä¸‰ç§ï¼Œä½¿ç”¨å…¨é‡ Invoker é›†åˆã€‚ä¾‹å¦‚ï¼Œ#$echo(name) å›å£°æ–¹æ³•ã€‚
- ç¬¬å››ç§ï¼Œä½¿ç”¨ methodInvokerMap ç¬¬ä¸€ä¸ª Invoker é›†åˆã€‚é˜²å¾¡æ€§ç¼–ç¨‹ã€‚

## 59.4 StaticDirectory ##
com.alibaba.dubbo.rpc.cluster.directory.StaticDirectory ï¼Œå®ç° AbstractDirectory æŠ½è±¡ç±»ï¼Œé™æ€ Directory å®ç°ç±»ã€‚é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°†ä¼ å…¥çš„ invokers é›†åˆï¼Œå°è£…æˆé™æ€çš„ Directory å¯¹è±¡ã€‚

ReferenceConfig#createProxy(Map<String, String> map) ä½¿ç”¨äº†æ­¤æ–¹æ³•ã€‚

å½“ registryURL éç©ºæ—¶ï¼Œæ„å‘³ç€æœ‰æ³¨å†Œä¸­å¿ƒï¼Œä½¿ç”¨ cluster=available é›†ç¾¤æ–¹å¼ï¼Œå¹¶è°ƒç”¨ Cluster$Adaptive#join(StaticDirectory) æ–¹æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ Cluster Invoker å¯¹è±¡ã€‚è¿™æ„å‘³ç€ï¼ŒæœåŠ¡è°ƒç”¨æ—¶ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯ cluster=available ï¼Œä»…è°ƒç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„ Invoker å¯¹è±¡ã€‚

## 59.5 ClusterUtils ##
com.alibaba.dubbo.rpc.cluster.support.ClusterUtils ï¼ŒCluster å·¥å…·ç±»ã€‚

å°† localMap å’Œ remoteUrl.parameters åˆå¹¶æˆ map ã€‚
å°†åˆå¹¶çš„ map çš„ç»“æœï¼Œè¦†ç›–è®¾ç½®åˆ° remoteUrl ä¸­ã€‚

----

# 60 é›†ç¾¤å®¹é”™ï¼ˆå››ï¼‰ä¹‹ LoadBalance å®ç° #
å†…ç½®äº†å››ç§è´Ÿè½½å‡è¡¡çš„é€‰æ‹©ç®—æ³•ã€‚

## 60.1 LoadBalance ##

com.alibaba.dubbo.rpc.cluster.LoadBalance ï¼Œ LoadBalance æ¥å£ã€‚

- @SPI(RandomLoadBalance.NAME) æ³¨è§£ï¼ŒDubbo SPI æ‹“å±•ç‚¹ï¼Œé»˜è®¤ä¸º "random" ï¼Œå³éšæœºã€‚
- @Adaptive æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Cluster å®ç°ï¼Œä½¿ç”¨ URL.loadbalance å±æ€§ã€‚
- selectList<Invoker<T>>, URL, Invocation) æ¥å£æ–¹æ³•ï¼Œä» Invoker é›†åˆä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªã€‚

## 60.2 AbstractLoadBalance ##
com.alibaba.dubbo.rpc.cluster.loadbalance.AbstractLoadBalance ï¼Œå®ç° LoadBalance æ¥å£ï¼ŒLoadBalance æŠ½è±¡ç±»ï¼Œæä¾›äº†æƒé‡è®¡ç®—çš„åŠŸèƒ½ã€‚

### 60.2.1 select ###
select(List<Invoker<T>>, URL, Invocation) å®ç°æ–¹æ³•ï¼Œé»˜è®¤åªæœ‰ä¸€ä¸ª Invoker æ—¶ï¼Œç›´æ¥é€‰æ‹©è¿”å›ã€‚

- å­ç±»å®ç° #doSelect(List<Invoker<T>>, URL, Invocation) æŠ½è±¡æ–¹æ³•ï¼Œæä¾›è‡ªå®šä¹‰çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ã€‚

### 60.2.2 getWeight ###
è·å¾— weight é…ç½®

````
protected int getWeight(Invoker<?> invoker, Invocation invocation) {
    // è·å¾— weight é…ç½®ï¼Œå³æœåŠ¡æƒé‡ã€‚é»˜è®¤ä¸º 100
    int weight = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.WEIGHT_KEY, Constants.DEFAULT_WEIGHT);
    if (weight > 0) {
        long timestamp = invoker.getUrl().getParameter(Constants.REMOTE_TIMESTAMP_KEY, 0L);
        if (timestamp > 0L) {
            // è·å¾—å¯åŠ¨æ€»æ—¶é•¿
            int uptime = (int) (System.currentTimeMillis() - timestamp);
            // è·å¾—é¢„çƒ­éœ€è¦æ€»æ—¶é•¿ã€‚é»˜è®¤ä¸º 10 * 60 * 1000 = 10 åˆ†é’Ÿ
            int warmup = invoker.getUrl().getParameter(Constants.WARMUP_KEY, Constants.DEFAULT_WARMUP);
            // å¤„äºé¢„çƒ­ä¸­ï¼Œè®¡ç®—å½“å‰çš„æƒé‡
            if (uptime > 0 && uptime < warmup) {
                weight = calculateWarmupWeight(uptime, warmup, weight);
            }
        }
    }
    return weight;
}
````

è€ƒè™‘åˆ° JVM è‡ªèº«ä¼šæœ‰é¢„çƒ­çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥æœåŠ¡æä¾›è€…ä¸€å¯åŠ¨å°±ç›´æ¥æ‰¿æ‹… 100% çš„æµé‡ï¼Œå¯èƒ½ä¼šå‡ºç°å¾ˆåƒåŠ›çš„æƒ…å†µã€‚å› æ­¤æƒé‡çš„è®¡ç®—ï¼Œé»˜è®¤è‡ªå¸¦äº†é¢„çƒ­çš„è¿‡ç¨‹ã€‚

calculateWarmupWeight(int uptime, int warmup, int weight) å‡½æ•°ï¼š
è®¡ç®—æƒé‡çš„ä»£ç è¿™ä¹ˆå†™çœ‹èµ·æ¥æ¯”è¾ƒâ€œç»•â€ï¼Œæˆ‘ä»¬æ¥ä¿®æ”¹æˆ (uptime / warmup) * weight ï¼Œæ˜¯å¦å°±å¥½ç†è§£å¤šäº†ï¼Œç›¸å½“äºè¿›åº¦ç™¾åˆ†æ¯” * æƒé‡ã€‚

### 60.3 RandomLoadBalance ###

com.alibaba.dubbo.rpc.cluster.loadbalance.RandomLoadBalance ï¼Œå®ç° AbstractLoadBalance æŠ½è±¡ç±»ï¼Œéšæœºï¼ŒæŒ‰æƒé‡è®¾ç½®éšæœºæ¦‚ç‡ã€‚

ç‰¹ç‚¹ï¼šåœ¨ä¸€ä¸ªæˆªé¢ä¸Šç¢°æ’çš„æ¦‚ç‡é«˜ï¼Œä½†è°ƒç”¨é‡è¶Šå¤§åˆ†å¸ƒè¶Šå‡åŒ€ï¼Œè€Œä¸”æŒ‰æ¦‚ç‡ä½¿ç”¨æƒé‡åä¹Ÿæ¯”è¾ƒå‡åŒ€ï¼Œæœ‰åˆ©äºåŠ¨æ€è°ƒæ•´æä¾›è€…æƒé‡ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è®¡ç®—æ€»æƒé‡ï¼Œå¹¶åˆ¤æ–­æ‰€æœ‰ Invoker æ˜¯å¦ç›¸åŒæƒé‡ã€‚
2. æƒé‡ä¸ç›¸ç­‰ï¼Œéšæœºæƒé‡åï¼Œåˆ¤æ–­åœ¨å“ªä¸ª Invoker çš„æƒé‡åŒºé—´ä¸­ã€‚
3. æƒé‡ç›¸ç­‰ï¼Œç›´æ¥éšæœºé€‰æ‹© Invoker å³å¯ã€‚

### 60.4 RoundRobinLoadBalance ###
com.alibaba.dubbo.rpc.cluster.loadbalance.RoundRobinLoadBalance ï¼Œå®ç° AbstractLoadBalance æŠ½è±¡ç±»ï¼Œè½®å¾ªï¼ŒæŒ‰å…¬çº¦åçš„æƒé‡è®¾ç½®è½®å¾ªæ¯”ç‡ã€‚

å­˜åœ¨æ…¢çš„æä¾›è€…ç´¯ç§¯è¯·æ±‚çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼šç¬¬äºŒå°æœºå™¨å¾ˆæ…¢ï¼Œä½†æ²¡æŒ‚ï¼Œå½“è¯·æ±‚è°ƒåˆ°ç¬¬äºŒå°æ—¶å°±å¡åœ¨é‚£ï¼Œä¹…è€Œä¹…ä¹‹ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å¡åœ¨è°ƒåˆ°ç¬¬äºŒå°ä¸Šã€‚

### 60.5 LeastActiveLoadBalance ###
com.alibaba.dubbo.rpc.cluster.loadbalance.LeastActiveLoadBalance ï¼Œå®ç° AbstractLoadBalance æŠ½è±¡ç±»ï¼Œæœ€å°‘æ´»è·ƒè°ƒç”¨æ•°ï¼Œç›¸åŒæ´»è·ƒæ•°çš„éšæœºï¼Œæ´»è·ƒæ•°æŒ‡è°ƒç”¨å‰åè®¡æ•°å·®ã€‚

ä½¿æ…¢çš„æä¾›è€…æ”¶åˆ°æ›´å°‘è¯·æ±‚ï¼Œå› ä¸ºè¶Šæ…¢çš„æä¾›è€…çš„è°ƒç”¨å‰åè®¡æ•°å·®ä¼šè¶Šå¤§ã€‚

ç›¸æ¯”æ¥è¯´ï¼ŒLeastActiveLoadBalance æ˜¯ RandomLoadBalance çš„åŠ å¼ºç‰ˆï¼ŒåŸºäºæœ€å°‘æ´»è·ƒè°ƒç”¨æ•°ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è®¡ç®—è·å¾—ç›¸åŒæœ€å°æ´»è·ƒæ•°çš„æ•°ç»„( leastIndexes )å’Œä¸ªæ•°( leastCount )ã€‚æ³¨æ„ï¼ŒleastIndexes æ˜¯é‡ç”¨çš„ï¼Œæ‰€ä»¥éœ€è¦ leastCount ä½œä¸ºä¸‹æ ‡ã€‚
2. å¦‚æœåªæœ‰ä¸€ä¸ªæœ€å°åˆ™ç›´æ¥è¿”å›ã€‚
3. æƒé‡ä¸ç›¸ç­‰ï¼Œéšæœºæƒé‡åï¼Œåˆ¤æ–­åœ¨å“ªä¸ª Invoker çš„æƒé‡åŒºé—´ä¸­ã€‚
4. æƒé‡ç›¸ç­‰ï¼Œç›´æ¥éšæœºé€‰æ‹© Invoker å³å¯ã€‚

### 60.6 ConsistentHashLoadBalance ###
com.alibaba.dubbo.rpc.cluster.loadbalance.ConsistentHashLoadBalance ï¼Œå®ç° AbstractLoadBalance æŠ½è±¡ç±»ï¼Œä¸€è‡´æ€§ Hashï¼Œç›¸åŒå‚æ•°çš„è¯·æ±‚æ€»æ˜¯å‘åˆ°åŒä¸€æä¾›è€…ã€‚

å½“æŸä¸€å°æä¾›è€…æŒ‚æ—¶ï¼ŒåŸæœ¬å‘å¾€è¯¥æä¾›è€…çš„è¯·æ±‚ï¼ŒåŸºäºè™šæ‹ŸèŠ‚ç‚¹ï¼Œå¹³æ‘Šåˆ°å…¶å®ƒæä¾›è€…ï¼Œä¸ä¼šå¼•èµ·å‰§çƒˆå˜åŠ¨ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹:
1. è°ƒç”¨ System#identityHashCode(Object) æ–¹æ³•ï¼ŒåŸºäº invokers é›†åˆï¼Œæ ¹æ®å¯¹è±¡å†…å­˜åœ°å€æ¥è®¡ç®—å®šä¹‰å“ˆå¸Œå€¼ã€‚
2. è·å¾— ConsistentHashSelector å¯¹è±¡ã€‚è‹¥ä¸ºç©ºï¼Œæˆ–è€…å®šä¹‰å“ˆå¸Œå€¼å˜æ›´ï¼ˆè¯´æ˜ invokers é›†åˆå‘ç”Ÿå˜åŒ–ï¼‰ï¼Œè¿›è¡Œåˆ›å»ºæ–°çš„ ConsistentHashSelector å¯¹è±¡ã€‚
3. è°ƒç”¨ ConsistentHashSelector#select(invocation) æ–¹æ³•ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚

### 60.6.1 ConsistentHashSelector ###
ConsistentHashSelector ï¼Œæ˜¯ ConsistentHashLoadBalance çš„å†…éƒ¨ç±»ï¼Œä¸€è‡´æ€§å“ˆå¸Œé€‰æ‹©å™¨ï¼ŒåŸºäº Ketama ç®—æ³•ã€‚

#### 60.6.1.1 æ„é€ æ–¹æ³• ####

````
/**
 * è™šæ‹ŸèŠ‚ç‚¹ä¸ Invoker çš„æ˜ å°„å…³ç³»
 * 
 */
private final TreeMap<Long, Invoker<T>> virtualInvokers;
/**
 * æ¯ä¸ª Invoker å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹æ•°ï¼Œé»˜è®¤ä¸º 160 ã€‚å¯é€šè¿‡ <dubbo:parameter key="hash.nodes" value="320" /> è‡ªå®šä¹‰
 */
private final int replicaNumber;
/**
 * å®šä¹‰å“ˆå¸Œå€¼
 */
private final int identityHashCode;
/** 
 * å–å€¼å‚æ•°ä½ç½®æ•°ç»„
 * é€‰æ‹© Invoker æ—¶ï¼Œè®¡ç®— Hash å€¼çš„å‚æ•°ä½ç½®æ•°ç»„ï¼Œé»˜è®¤ä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€‚
 * å¯é€šè¿‡ <dubbo:parameter key="hash.arguments" value="0,1" /> è‡ªå®šä¹‰
 */
private final int[] argumentIndex;

ConsistentHashSelector(List<Invoker<T>> invokers, String methodName, int identityHashCode) {
    this.virtualInvokers = new TreeMap<Long, Invoker<T>>();
    // è®¾ç½® identityHashCode
    this.identityHashCode = identityHashCode;
    URL url = invokers.get(0).getUrl();
    // åˆå§‹åŒ– replicaNumber
    this.replicaNumber = url.getMethodParameter(methodName, "hash.nodes", 160);
    // åˆå§‹åŒ– argumentIndex
    String[] index = Constants.COMMA_SPLIT_PATTERN.split(url.getMethodParameter(methodName, "hash.arguments", "0"));
    argumentIndex = new int[index.length];
    for (int i = 0; i < index.length; i++) {
        argumentIndex[i] = Integer.parseInt(index[i]);
    }
    // åˆå§‹åŒ– virtualInvokers
    for (Invoker<T> invoker : invokers) {
        String address = invoker.getUrl().getAddress();
        // æ¯å››ä¸ªè™šæ‹Ÿç»“ç‚¹ä¸ºä¸€ç»„ï¼Œä¸ºä»€ä¹ˆè¿™æ ·ï¼Ÿä¸‹é¢ä¼šè¯´åˆ°
        for (int i = 0; i < replicaNumber / 4; i++) {
            // è¿™ç»„è™šæ‹Ÿç»“ç‚¹å¾—åˆ°æƒŸä¸€åç§°
            byte[] digest = md5(address + i);
            // Md5æ˜¯ä¸€ä¸ª16å­—èŠ‚é•¿åº¦çš„æ•°ç»„ï¼Œå°†16å­—èŠ‚çš„æ•°ç»„æ¯å››ä¸ªå­—èŠ‚ä¸€ç»„ï¼Œåˆ†åˆ«å¯¹åº”ä¸€ä¸ªè™šæ‹Ÿç»“ç‚¹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢æŠŠè™šæ‹Ÿç»“ç‚¹å››ä¸ªåˆ’åˆ†ä¸€ç»„çš„åŸå› 
            for (int h = 0; h < 4; h++) {
                // å¯¹äºæ¯å››ä¸ªå­—èŠ‚ï¼Œç»„æˆä¸€ä¸ªlongå€¼æ•°å€¼ï¼Œåšä¸ºè¿™ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„åœ¨ç¯ä¸­çš„æƒŸä¸€key
                long m = hash(digest, h);
                virtualInvokers.put(m, invoker);
            }
        }
    }
}
````

åŸºæœ¬æµç¨‹ï¼š
1. å¾ªç¯æ¯ä¸ª Invoker å¯¹è±¡ã€‚
2. å¾ªç¯ replicaNumber / 4 æ¬¡ï¼Œæ¯å››ä¸ªè™šæ‹ŸèŠ‚ç‚¹ä¸ºä¸€ç»„
3. æ‹¼æ¥ address + i ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹åçš„å”¯ä¸€åç§°ã€‚è°ƒç”¨ #md5(value) æ–¹æ³•ï¼Œè®¡ç®— MD5 ã€‚
	1. MD5 æ˜¯ä¸€ä¸ª 16 å­—èŠ‚é•¿åº¦çš„æ•°ç»„ï¼Œå°† 16 å­—èŠ‚çš„æ•°ç»„æ¯å››ä¸ªå­—èŠ‚ä¸€ç»„ï¼Œåˆ†åˆ«å¯¹åº”ä¸€ä¸ªè™šæ‹Ÿç»“ç‚¹ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šé¢æŠŠè™šæ‹Ÿç»“ç‚¹å››ä¸ªåˆ’åˆ†ä¸€ç»„çš„åŸå› 
4. é¡ºåºå¾ªç¯æ¯å››ä¸ªå­—èŠ‚ã€‚
5. è°ƒç”¨ #hash(byte[] digest, int number) æ–¹æ³•ï¼Œå¯¹äºæ¯å››ä¸ªå­—èŠ‚ï¼Œç»„æˆä¸€ä¸ª Long å€¼æ•°å€¼ï¼Œåšä¸ºè¿™ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„åœ¨ç¯ä¸­çš„æƒŸä¸€ KEY ã€‚
6. æ·»åŠ  Invoker åˆ° virtualInvokers ä¸­ã€‚

#### 60.6.1.2 select ####

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ #toKey(Object[] args) æ–¹æ³•ï¼ŒåŸºäºæ–¹æ³•å‚æ•°ï¼Œè·å¾— KEY ã€‚
2. è°ƒç”¨ #md5(key) æ–¹æ³•ï¼Œè®¡ç®— MD5 å€¼ã€‚
3. è°ƒç”¨ #hash(digest, hash) æ–¹æ³•ï¼Œè®¡ç®— KEY å€¼ã€‚
4. è°ƒç”¨ #selectForKey(hash) æ–¹æ³•ï¼Œé€‰ä¸€ä¸ª Invoker å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

----

# 61 é›†ç¾¤å®¹é”™ï¼ˆäº”ï¼‰ä¹‹ Merger å®ç° #
åˆ†ç»„èšåˆ

## 61.1 Merger ##
com.alibaba.dubbo.rpc.cluster.Merger ï¼ŒMerger æ¥å£ï¼Œæä¾›æ¥å£æ–¹æ³•ï¼Œå°†å¯¹è±¡æ•°ç»„åˆå¹¶æˆä¸€ä¸ªå¯¹è±¡ã€‚

- @SPI æ³¨è§£ï¼ŒDubbo SPI æ‹“å±•ç‚¹ï¼Œæ— é»˜è®¤å€¼ã€‚

### 61.1.1 Merger å®ç°ç±» ###
Merger å†…ç½®åäºŒä¸ªå®ç°ç±»ï¼Œä»ä»£ç ä¸Šçœ‹åŸºæœ¬ç±»ä¼¼

#### 61.1.1.1 MapMerger ####
com.alibaba.dubbo.rpc.cluster.merger.MapMerger ï¼Œå®ç° Merger æ¥å£ï¼ŒMap Merger å®ç°ç±»

#### 61.1.1.2 ShortArrayMerger ####
com.alibaba.dubbo.rpc.cluster.merger.ShortArrayMerger ï¼Œå®ç° Merger æ¥å£ï¼ŒShort æ•°ç»„ Merger å®ç°ç±»ã€‚

### 61.1.2 MergerFactory ###
com.alibaba.dubbo.rpc.cluster.merger.MergerFactory ï¼ŒMerger å·¥å‚ç±»ï¼Œæä¾› #getMerger(Class<T> returnType) æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šç±»å¯¹åº”çš„ Merger å¯¹è±¡ã€‚

## 61.2 MergeableCluster ##
com.alibaba.dubbo.rpc.cluster.support.MergeableCluster ï¼Œå®ç° Cluster æ¥å£ï¼Œåˆ†ç»„èšåˆ Cluster å®ç°ç±»ã€‚
å¯¹åº” Invoker å®ç°ç±»ä¸º MergeableClusterInvoker ã€‚

Merger çš„ä½¿ç”¨ï¼Œéœ€è¦è®¾ç½® Cluster çš„å®ç°ç±»ä¸º MergeableCluster ã€‚ä½†æ˜¯å‘¢ï¼Œå®ƒçš„é…ç½®æ–¹å¼ï¼Œå’Œå…¶ä»– Cluster å®ç°ç±»ä¸åŒã€‚

### 61.2.1 MergeableClusterInvoker ###
com.alibaba.dubbo.rpc.cluster.support.MergeableClusterInvoker ï¼Œå®ç° Invoker æ¥å£ï¼ŒMergeableCluster Invoker å®ç°ç±»ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ Directory#list(invocation) æ–¹æ³•ï¼Œè·å¾—æœåŠ¡ Invoker é›†åˆã€‚
2. è°ƒç”¨ URL#getMethodParameter(methodName, "merger") æ–¹æ³•ï¼Œè·å¾— Merger æ‹“å±•åï¼Œæ–¹æ³•çº§ã€‚
3. è‹¥æœªé…ç½® Merger æ‹“å±•åï¼Œä¼˜å…ˆè°ƒç”¨é¦–ä¸ªå¯ç”¨çš„ Invoker å¯¹è±¡ï¼Œå…¶æ¬¡è°ƒç”¨é¦–ä¸ª Invoker å¯¹è±¡ã€‚
4. é€šè¿‡åå°„ï¼Œè·å¾—è°ƒç”¨æ–¹æ³•çš„è¿”å›ç±»å‹ã€‚
5. æäº¤çº¿ç¨‹æ± ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå‘èµ· RPC è°ƒç”¨ï¼Œå¹¶æ·»åŠ  Future åˆ° results ä¸­ã€‚
6. é˜»å¡ç­‰å¾…æ‰§è¡Œç»“æœï¼Œå¹¶æ·»åŠ åˆ° resultList ä¸­ã€‚æ³¨æ„ï¼Œåˆ†æˆæ­£å¸¸ Resultã€å¼‚å¸¸ Resultï¼ˆå¿½ç•¥ï¼‰ã€Exception ä¸‰ç§æƒ…å†µã€‚
	1. ç»“æœå¤§å°ä¸ºç©ºï¼Œè¿”å›ç©ºçš„ RpcResult ã€‚
	2. ç»“æœå¤§å°ä¸º 1 ï¼Œè¿”å›é¦–ä¸ª RpcResult ã€‚
	3. è¿”å›ç±»å‹ä¸º void ï¼Œè¿”å›ç©ºçš„ RpcResult ã€‚
	4. 
========== ã€ç¬¬ 1 ç§ã€‘åŸºäº Method åˆå¹¶==========
1. è‹¥ merger ä¸º "." å¼€å¤´ï¼ŒæŒ‡å®šåˆå¹¶æ–¹æ³•ï¼Œå°†è°ƒç”¨è¿”å›ç»“æœçš„æŒ‡å®šæ–¹æ³•è¿›è¡Œåˆå¹¶ï¼Œåˆå¹¶æ–¹æ³•çš„å‚æ•°ç±»å‹å¿…é¡»æ˜¯è¿”å›ç»“æœç±»å‹æœ¬èº«ã€‚
2. è°ƒç”¨ Class#getMethod(String name, Class<?>... parameterTypes) æ–¹æ³•ï¼Œè·å¾—åˆå¹¶æ–¹æ³• Method ã€‚è¿™ä¸ªæ–¹æ³•ï¼Œæ„å‘³ç€â€œåˆå¹¶æ–¹æ³•çš„å‚æ•°ç±»å‹å¿…é¡»æ˜¯è¿”å›ç»“æœç±»å‹æœ¬èº«â€ï¼ï¼ï¼ï¼Œæœç´¢ "åœ¨æ¡ä»¶åˆ†æ”¯if ( merger.startsWith(".") ) {}" ã€‚
3. æœ‰ Method ï¼Œå¾ªç¯è°ƒç”¨ Method#invoke(Object obj, Object... args) æ–¹æ³•ï¼Œè¿›è¡Œåˆå¹¶ã€‚
4. æ—  Method ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚

========== ã€ç¬¬ 2 ç§ã€‘åŸºäº Merger åˆå¹¶ ==========
- ã€ç¬¬ 2.1 ç§ã€‘å½“ merger ä¸º "default" æˆ– "true" æ—¶ï¼Œè°ƒç”¨ MergerFactory#getMerger(Class<T> returnType) æ–¹æ³•ï¼Œæ ¹æ®è¿”å›å€¼ç±»å‹è‡ªåŠ¨åŒ¹é… Merger ã€‚
- ã€ç¬¬ 2.2 ç§ã€‘è°ƒç”¨ ExtensionLoader#getExtension(merger) æ–¹æ³•å•Šï¼Œè·å¾—æŒ‡å®š Merger ã€‚
	- æœ‰ Merger ï¼Œå¾ªç¯è°ƒç”¨ Merger#merge(T... items) æ–¹æ³•ï¼Œè¿›è¡Œåˆå¹¶ã€‚
	- æ—  Method ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚

------

# 62 é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç° #

å®ç° Dubbo çš„é…ç½®è§„åˆ™åŠŸèƒ½ã€‚

## 62.1 ConfiguratorFactory ##
com.alibaba.dubbo.rpc.cluster.ConfiguratorFactory ï¼ŒConfigurator å·¥å‚æ¥å£ï¼Œ

- @SPI æ³¨è§£ï¼ŒDubbo SPI æ‹“å±•ç‚¹ï¼Œæ— é»˜è®¤å€¼ã€‚
- @Adaptive("protocol") æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Configurator å®ç°ï¼Œä½¿ç”¨ URL.protocol å±æ€§ã€‚
- getConfigurator(URL url) æ¥å£æ–¹æ³•ï¼Œè·å¾— Configurator å¯¹è±¡ã€‚

### 62.1.1 OverrideConfiguratorFactory ###
com.alibaba.dubbo.rpc.cluster.configurator.override.OverrideConfiguratorFactory ï¼Œå®ç° ConfiguratorFactory æ¥å£ï¼ŒOverrideConfigurator å·¥å‚

### 62.1.2 AbsentConfiguratorFactory ###

com.alibaba.dubbo.rpc.cluster.configurator.absent.AbsentConfiguratorFactory ï¼Œå®ç° ConfiguratorFactory æ¥å£ï¼ŒAbsentConfigurator å·¥å‚ã€‚

## 62.2 Configurator ##
com.alibaba.dubbo.rpc.cluster.Configurator ï¼Œå®ç° Comparable æ¥å£ï¼Œé…ç½®è§„åˆ™æ¥å£ã€‚

- ä¸€ä¸ª Configurator å¯¹è±¡ï¼Œå¯¹åº”ä¸€æ¡é…ç½®è§„åˆ™ã€‚
- Configurator æœ‰ä¼˜å…ˆçº§çš„è¦æ±‚ï¼Œæ‰€ä»¥å®ç° Comparable æ¥å£ã€‚
- getUrl() æ¥å£æ–¹æ³•ï¼Œè·å¾—é…ç½® URL ï¼Œé‡Œé¢å¸¦æœ‰é…ç½®è§„åˆ™ã€‚
- configure(Url url) æ¥å£æ–¹æ³•ï¼Œè®¾ç½®é…ç½®è§„åˆ™åˆ°æŒ‡å®š URL ä¸­ã€‚

### 62.2.1 AbstractConfigurator ###
com.alibaba.dubbo.rpc.cluster.configurator.AbstractConfigurator ï¼Œå®ç° Configurator æ¥å£ï¼Œå®ç°å…¬ç”¨çš„é…ç½®è§„åˆ™çš„åŒ¹é…ã€æ’åºçš„é€»è¾‘ã€‚

#### 62.2.1.1 getUrl ####
è·å–é…ç½®çš„url

//  todo å‰©ä½™è¡¥å……

# 63 é›†ç¾¤å®¹é”™ï¼ˆä¸ƒï¼‰ä¹‹ Router å®ç° #
å®ç° Dubbo çš„è·¯ç”±è§„åˆ™åŠŸèƒ½ã€‚

//  todo ç­‰å¾…è¡¥å……

# 64 é›†ç¾¤å®¹é”™ï¼ˆå…«ï¼‰ä¹‹ Mock å®ç° #

# 65 ä¼˜é›…åœæœº #

# 66 æ—¥å¿—é€‚é… #
-----