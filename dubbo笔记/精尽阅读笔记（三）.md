# 47 NIO æœåŠ¡å™¨ï¼ˆä¸‰ï¼‰ä¹‹ Telnet å±‚ #
dubbo-remoting-api æ¨¡å—ï¼Œ telnet åŒ…ï¼ŒTelnet å‘½ä»¤ã€‚

Dubbo æ”¯æŒé€šè¿‡ telnet å‘½ä»¤ï¼Œç”¨æ¥æœåŠ¡æ²»ç†ã€‚å…¶ä¸­ï¼Œclear exit help log status é€šç”¨æŒ‡ä»¤ï¼Œé€šè¿‡ telnet åŒ…å®ç°ã€‚è€Œå…¶å®ƒå‡ ä¸ªæŒ‡ä»¤ï¼Œéœ€è¦ä¸åŒåè®®( Protocol )è‡ªå·±å®ç°ã€‚ç›®å‰ï¼Œä»…æœ‰ Dubbo Protocol å®ç°äº†è‡ªå®šä¹‰æŒ‡ä»¤ã€‚

ä¸»è¦åˆ†æˆä¸‰ç§ä¸é€šçš„ç±»ã€‚

- TelnetCodec ï¼šè´Ÿè´£ç¼–è§£ç  Telnet å‘½ä»¤ä¸ç»“æœã€‚
- TelnetHandlerAdapter ï¼šè´Ÿè´£æ¥æ”¶æ¥è‡ª HeaderExchangeHandler çš„ telnet å‘½ä»¤ï¼Œåˆ†å‘ç»™å¯¹åº”çš„ TelnetHandler å®ç°ç±»ï¼Œè¿›è¡Œå¤„ç†ï¼Œè¿”å›å‘½ä»¤ç»“æœã€‚
- XXXTelnetHandler ï¼šå¤„ç†å¯¹åº”çš„ telnet å‘½ä»¤ï¼Œè¿”å›ç»“æœã€‚

æµç¨‹å¦‚ä¸‹å›¾ï¼š

![](/picture/dubbo-telnet-flow.png)

## 47.1 TelnetCodec ##

com.alibaba.dubbo.remoting.telnet.codec.TelnetCodec ï¼Œå®ç° TransportCodec ç±»ï¼ŒTelnet å‘½ä»¤ç¼–è§£ç å™¨ã€‚

**è§£ç **

//  todo dubboè¿ç»´äº†è§£

----

# 48 NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ #
dubbo-remoting-api æ¨¡å—ï¼Œ exchange åŒ…ï¼Œä¿¡æ¯äº¤æ¢å±‚ã€‚

exchange ä¿¡æ¯äº¤æ¢å±‚ï¼šå°è£…è¯·æ±‚å“åº”æ¨¡å¼ï¼ŒåŒæ­¥è½¬å¼‚æ­¥ï¼Œä»¥ Request, Response ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Exchanger, ExchangeChannel, ExchangeClient, ExchangeServerã€‚

åœ¨ä¸€æ¬¡ RPC è°ƒç”¨ï¼Œæ¯ä¸ªè¯·æ±‚( Request )ï¼Œæ˜¯å…³æ³¨å¯¹åº”çš„å“åº”( Response )ã€‚é‚£ä¹ˆ transport å±‚ æä¾›çš„ç½‘ç»œä¼ è¾“ åŠŸèƒ½ï¼Œæ˜¯æ— æ³•æ»¡è¶³ RPC çš„è¯‰æ±‚çš„ã€‚å› æ­¤ï¼Œexchange å±‚ï¼Œåœ¨å…¶ Message ä¹‹ä¸Šï¼Œæ„é€ äº†Request-Response çš„æ¨¡å‹ã€‚

å®ç°ä¸Šï¼Œä¹Ÿéå¸¸ç®€å•ï¼Œå°† Message åˆ†æˆ Request å’Œ Response ä¸¤ç§ç±»å‹ï¼Œå¹¶å¢åŠ ç¼–å·å±æ€§ï¼Œå°† Request å’Œ Response èƒ½å¤Ÿä¸€ä¸€æ˜ å°„ã€‚

å®é™…ä¸Šï¼ŒRPC è°ƒç”¨ï¼Œä¼šæœ‰æ›´å¤šç‰¹æ€§çš„éœ€æ±‚ï¼š1ï¼‰å¼‚æ­¥å¤„ç†è¿”å›ç»“æœï¼›2ï¼‰å†…ç½®äº‹ä»¶ï¼›3ï¼‰ç­‰ç­‰ã€‚å› æ­¤ï¼ŒRequest å’Œ Response ä¸Šä¼šæœ‰ç±»ä¼¼ç¼–å·çš„ç³»ç»Ÿå­—æ®µã€‚

ä¸€æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬åˆ†æˆä¸¤æ®µï¼š
- åè®®å¤´( Header ) ï¼š ç³»ç»Ÿå­—æ®µï¼Œä¾‹å¦‚ç¼–å·ç­‰ã€‚
- å†…å®¹( Body ) ï¼šå…·ä½“è¯·æ±‚çš„å‚æ•°å’Œå“åº”çš„ç»“æœç­‰ã€‚

dubboå¿ƒè·³æ£€æµ‹ï¼š
dubboå¿ƒè·³æ—¶é—´heartbeaté»˜è®¤æ˜¯60sï¼Œè¶…è¿‡heartbeatæ—¶é—´æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œå°±å‘é€å¿ƒè·³æ¶ˆæ¯(providerï¼Œconsumerä¸€æ ·),å¦‚æœè¿ç€3æ¬¡(heartbeatTimeoutä¸ºheartbeat*3)æ²¡æœ‰æ”¶åˆ°å¿ƒè·³å“åº”ï¼Œproviderä¼šå…³é—­channelï¼Œè€Œconsumerä¼šè¿›è¡Œé‡è¿;ä¸è®ºæ˜¯providerè¿˜æ˜¯consumerçš„å¿ƒè·³æ£€æµ‹éƒ½æ˜¯é€šè¿‡å¯åŠ¨å®šæ—¶ä»»åŠ¡çš„æ–¹å¼å®ç°ï¼›

## 48.1 ExchangeChannel ##

com.alibaba.dubbo.remoting.exchange.ExchangeChannel ï¼Œç»§æ‰¿ Channel æ¥å£ï¼Œä¿¡æ¯äº¤æ¢é€šé“æ¥å£

### 48.1.1 HeaderExchangeChannel ###

com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeChannel ï¼Œå®ç° ExchangeChannel æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢é€šé“å®ç°ç±»ã€‚

#### 48.1.1.1 æ„é€ æ–¹æ³• ####

````
private static final String CHANNEL_KEY = HeaderExchangeChannel.class.getName() + ".CHANNEL";

/** é€šé“ã€‚HeaderExchangeChannel æ˜¯ä¼ å…¥ channel å±æ€§çš„è£…é¥°å™¨ï¼Œæ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨ channel ã€‚ */
private final Channel channel;
/** æ˜¯å¦å…³é—­ */
private volatile boolean closed = false;

HeaderExchangeChannel(Channel channel) {
    if (channel == null) {
        throw new IllegalArgumentException("channel == null");
    }
    this.channel = channel;
}
````

getOrAddChannel(Channel) é™æ€æ–¹æ³•ï¼Œåˆ›å»º HeaderExchangeChannel å¯¹è±¡ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. ä¼ å…¥çš„ ch å±æ€§ï¼Œå®é™…å°±æ˜¯ HeaderExchangeChanel.channel å±æ€§ã€‚
2. é€šè¿‡ ch.attribute çš„ CHANNEL_KEY é”®å€¼ï¼Œä¿è¯æœ‰ä¸”ä»…æœ‰ä¸º ch å±æ€§ï¼Œåˆ›å»ºå”¯ä¸€çš„ HeaderExchangeChannel å¯¹è±¡ã€‚
3. è¦æ±‚å·²è¿æ¥ã€‚

removeChannelIfDisconnected(ch) é™æ€æ–¹æ³•ï¼Œç§»é™¤ HeaderExchangeChannel å¯¹è±¡ã€‚

#### 48.1.1.2 å‘é€è¯·æ±‚ ####

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

1. è‹¥å·²ç»å…³é—­ï¼Œä¸å†å…è®¸å‘èµ·æ–°çš„è¯·æ±‚ã€‚
2. ç¬¬ 6 è‡³ 10 è¡Œï¼šåˆ›å»º Request å¯¹è±¡ã€‚å…¶ä¸­ï¼ŒtwoWay = true éœ€è¦å“åº”ï¼›data = request å…·ä½“æ•°æ®ã€‚
3. åˆ›å»º DefaultFuture å¯¹è±¡ã€‚
4. è°ƒç”¨ Channel#send(req) æ–¹æ³•ï¼Œå‘é€è¯·æ±‚ã€‚
5. å‘ç”Ÿ RemotingException å¼‚å¸¸ï¼Œè°ƒç”¨ DefaultFuture#cancel() æ–¹æ³•ï¼Œå–æ¶ˆã€‚
6. è¿”å› DefaultFuture å¯¹è±¡ã€‚ä»ä»£ç çš„å½¢å¼ä¸Šæ¥è¯´ï¼Œæœ‰ç‚¹ç±»ä¼¼çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œè¿”å› Future å¯¹è±¡ã€‚

#### 48.1.1.3 ä¼˜é›…å…³é—­ ####

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. æ ‡è®° closed = true ï¼Œé¿å…å‘èµ·æ–°çš„è¯·æ±‚ã€‚
2. è°ƒç”¨ DefaultFuture#hasFuture(channel) æ–¹æ³•ï¼Œåˆ¤æ–­å·²å‘èµ·çš„å·²ç»æ˜¯å¦å·²ç»éƒ½å“åº”äº†ã€‚è‹¥å¦ï¼Œç­‰å¾…å®Œæˆæˆ–è¶…æ—¶ã€‚
3. å…³é—­é€šé“ã€‚

## 48.2 ExchangeClient ##
com.alibaba.dubbo.remoting.exchange.ExchangeClient ï¼Œå®ç° Client ï¼ŒExchangeChannel æ¥å£ï¼Œä¿¡æ¯äº¤æ¢å®¢æˆ·ç«¯æ¥å£ã€‚

### 48.2.1 HeaderExchangeClient ###
com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeClient ï¼Œå®ç° ExchangeClient æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢å®¢æˆ·ç«¯å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

````
/** å®šæ—¶å™¨çº¿ç¨‹æ±  */
private static final ScheduledThreadPoolExecutor scheduled = new ScheduledThreadPoolExecutor(2, new NamedThreadFactory("dubbo-remoting-client-heartbeat", true));
/** å®¢æˆ·ç«¯ */
private final Client client;
/** ä¿¡æ¯äº¤æ¢é€šé“ */
private final ExchangeChannel channel;
// heartbeat timer
/** å¿ƒè·³å®šæ—¶å™¨ */
private ScheduledFuture<?> heartbeatTimer;
/** æ˜¯å¦å¿ƒè·³ */
private int heartbeat;
// heartbeat timeout (ms), default value is 0 , won't execute a heartbeat.
/** å¿ƒè·³é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ */
private int heartbeatTimeout;
public HeaderExchangeClient(Client client, boolean needHeartbeat) {
    if (client == null) {
        throw new IllegalArgumentException("client == null");
    }
    this.client = client;
    // åˆ›å»º HeaderExchangeChannel å¯¹è±¡
    this.channel = new HeaderExchangeChannel(client);
    // è¯»å–å¿ƒè·³ç›¸å…³é…ç½®
    String dubbo = client.getUrl().getParameter(Constants.DUBBO_VERSION_KEY);
    this.heartbeat = client.getUrl().getParameter(Constants.HEARTBEAT_KEY, dubbo != null && dubbo.startsWith("1.0.") ? Constants.DEFAULT_HEARTBEAT : 0);
    this.heartbeatTimeout = client.getUrl().getParameter(Constants.HEARTBEAT_TIMEOUT_KEY, heartbeat * 3);
    if (heartbeatTimeout < heartbeat * 2) { // é¿å…é—´éš”å¤ªçŸ­
        throw new IllegalStateException("heartbeatTimeout < heartbeatInterval * 2");
    }
    // å‘èµ·å¿ƒè·³å®šæ—¶å™¨
    if (needHeartbeat) {
        startHeatbeatTimer();
    }
}
````

åŸºæœ¬æµç¨‹å¦‚ä¸‹;
1. ä½¿ç”¨ä¼ å…¥çš„ client å±æ€§ï¼Œåˆ›å»º HeaderExchangeChannel å¯¹è±¡ã€‚
2. è¯»å–å¿ƒè·³ç›¸å…³é…ç½®ã€‚é»˜è®¤ï¼Œå¼€å¯å¿ƒè·³åŠŸèƒ½ã€‚
	1. å¿ƒè·³é—´éš”ï¼Œå¯¹äºé•¿è¿æ¥ï¼Œå½“ç‰©ç†å±‚æ–­å¼€æ—¶ï¼Œæ¯”å¦‚æ‹”ç½‘çº¿ï¼ŒTCPçš„FINæ¶ˆæ¯æ¥ä¸åŠå‘é€ï¼Œå¯¹æ–¹æ”¶ä¸åˆ°æ–­å¼€äº‹ä»¶ï¼Œæ­¤æ—¶éœ€è¦å¿ƒè·³æ¥å¸®åŠ©æ£€æŸ¥è¿æ¥æ˜¯å¦å·²æ–­å¼€
3.  è°ƒç”¨ #startHeatbeatTimer() æ–¹æ³•ï¼Œå‘èµ·å¿ƒè·³å®šæ—¶å™¨ã€‚

## 48.3 ExchangeServer ##

com.alibaba.dubbo.remoting.exchange.ExchangeServer ï¼Œç»§æ‰¿ Server æ¥å£ï¼Œä¿¡æ¯äº¤æ¢æœåŠ¡å™¨æ¥å£

### 48.3.1 HeaderExchangeServer ###
com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeServer ï¼Œå®ç° ExchangeServer æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢æœåŠ¡å™¨å®ç°ç±»ã€‚

- ä»£ç å®ç°ä¸Šï¼Œå’Œ HeaderExchangeChannel + HeaderExchangeClient çš„ç»¼åˆã€‚

#### 48.3.1.1 æ„é€ æ–¹æ³• ####
ä»£ç å®ç°ä¸Šï¼Œå’Œ HeaderExchangeClient çš„ç±»ä¼¼ã€‚

````
/** å®šæ—¶å™¨çº¿ç¨‹æ±  */
private final ScheduledExecutorService scheduled = Executors.newScheduledThreadPool(1, new NamedThreadFactory("dubbo-remoting-server-heartbeat", true));
/** æœåŠ¡å™¨ */
private final Server server;
// heartbeat timer
/** å¿ƒè·³å®šæ—¶å™¨ */
private ScheduledFuture<?> heatbeatTimer;
/** æ˜¯å¦å¿ƒè·³ */
// heartbeat timeout (ms), default value is 0 , won't execute a heartbeat.
private int heartbeat;
/** å¿ƒè·³é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’ */
private int heartbeatTimeout;
/** æ˜¯å¦å…³é—­ */
private AtomicBoolean closed = new AtomicBoolean(false);

public HeaderExchangeServer(Server server) {
    if (server == null) {
        throw new IllegalArgumentException("server == null");
    }
    // è¯»å–å¿ƒè·³ç›¸å…³é…ç½®
    this.server = server;
    this.heartbeat = server.getUrl().getParameter(Constants.HEARTBEAT_KEY, 0);
    this.heartbeatTimeout = server.getUrl().getParameter(Constants.HEARTBEAT_TIMEOUT_KEY, heartbeat * 3);
    if (heartbeatTimeout < heartbeat * 2) {
        throw new IllegalStateException("heartbeatTimeout < heartbeatInterval * 2");
    }
    // å‘èµ·å¿ƒè·³å®šæ—¶å™¨
    startHeatbeatTimer();
}
````

#### 48.3.1.2 ä¼˜é›…å…³é—­ ####
Server å…³é—­çš„è¿‡ç¨‹ï¼Œåˆ†æˆä¸¤ä¸ªé˜¶æ®µï¼šæ­£åœ¨å…³é—­å’Œå·²ç»å…³é—­ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ #startClose() æ–¹æ³•ï¼Œæ ‡è®°æ­£åœ¨å…³é—­ã€‚
2. å‘é€ READONLY äº‹ä»¶ç»™æ‰€æœ‰ Client ï¼Œè¡¨ç¤º Server ä¸å†æ¥æ”¶æ–°çš„æ¶ˆæ¯ï¼Œé¿å…ä¸æ–­æœ‰æ–°çš„æ¶ˆæ¯æ¥æ”¶åˆ°ã€‚
	1. å³ä½¿ client å¤„äºè¿æ¥ä¸­ï¼Œä½†æ˜¯ Server å¤„äºæ­£åœ¨å…³é—­ä¸­ï¼Œä¹Ÿç®—ä¸å¯ç”¨ï¼Œä¸è¿›è¡Œå‘é€è¯·æ±‚( æ¶ˆæ¯ )ã€‚
3. sendChannelReadOnlyEvent() æ–¹æ³•ï¼Œå¹¿æ’­å®¢æˆ·ç«¯ï¼ŒREADONLY_EVENT äº‹ä»¶
4. è°ƒç”¨ #oClose() æ–¹æ³•ï¼Œå…³é—­å¿ƒè·³å®šæ—¶å™¨ã€‚
5. çœŸæ­£å…³é—­æœåŠ¡å™¨ã€‚

### 48.3.2 ExchangeServerDelegate ###
com.alibaba.dubbo.remoting.exchange.support.ExchangeServerDelegate ï¼Œå®ç° ExchangeServer æ¥å£ï¼Œä¿¡æ¯äº¤æ¢æœåŠ¡å™¨è£…é¥°è€…ã€‚åœ¨æ¯ä¸ªå®ç°çš„æ–¹æ³•é‡Œï¼Œç›´æ¥è°ƒç”¨è¢«è£…é¥°çš„ server å±æ€§çš„æ–¹æ³•ã€‚

## 48.4 è¯·æ±‚/å“åº”æ¨¡å‹ ##
### 48.4.1 Request ###
com.alibaba.dubbo.remoting.exchange.Request ï¼Œè¯·æ±‚

å†…ç½®ä¸¤ç§äº‹ä»¶ï¼š

- HEARTBEAT_EVENT ï¼šå¿ƒè·³ã€‚å› ä¸ºå¿ƒè·³æ¯”è¾ƒå¸¸ç”¨ï¼Œæ‰€ä»¥åœ¨äº‹ä»¶ä¸Šæ—¶å€™äº† null ã€‚
- READONLY_EVENT ï¼šåªè¯»ã€‚

å±æ€§ï¼š
- mId å±æ€§ï¼šç¼–å·ã€‚ä½¿ç”¨ INVOKE_ID å±æ€§ç”Ÿæˆï¼ŒJVM è¿›ç¨‹å†…å”¯ä¸€ã€‚
- mTwoWay å±æ€§ï¼Œæ ‡è®°è¯·æ±‚æ˜¯å¦å“åº”( Response )ï¼Œé»˜è®¤éœ€è¦ã€‚
- mBroken å±æ€§ï¼Œæ˜¯å¦å¼‚å¸¸çš„è¯·æ±‚ã€‚åœ¨æ¶ˆæ¯è§£æçš„æ—¶å€™ï¼Œä¼šå‡ºç°ã€‚
- mData å±æ€§ï¼Œè¯·æ±‚å…·ä½“æ•°æ®ã€‚

### 48.4.2 Response ###
com.alibaba.dubbo.remoting.exchange.Response ï¼Œå“åº”ã€‚

- mId å±æ€§ï¼Œå“åº”ç¼–å·ï¼Œå’Œè¯·æ±‚ç¼–å·ä¸€è‡´ã€‚
- mStatus å±æ€§ï¼ŒçŠ¶æ€ã€‚æœ‰å¤šç§çŠ¶æ€ï¼š[çŠ¶æ€ç ] (dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/Response.java)ã€‚
- mEvent å±æ€§ï¼Œæ˜¯å¦äº‹ä»¶ã€‚å’Œ Request å†…ç½®äº†ä¸€æ ·çš„äº‹ä»¶ï¼Œä½†æ˜¯ READONLY_EVENT å¹¶æœªä½¿ç”¨ã€‚å› ä¸ºç›®å‰ï¼Œåªè¯»äº‹ä»¶ï¼Œæ— éœ€å“åº”ã€‚
- mErrorMsg å±æ€§ï¼Œé”™è¯¯æ¶ˆæ¯ã€‚
- mResult å±æ€§ï¼Œç»“æœã€‚

### 48.4.3 ResponseFuture ###
com.alibaba.dubbo.remoting.exchange.ResponseFuture ï¼Œå“åº” Future æ¥å£ã€‚
å’Œ java.util.concurrent.Future å¾ˆç±»ä¼¼ã€‚

#### 48.4.3.1 DefaultFuture ####
com.alibaba.dubbo.remoting.exchange.support.DefaultFuture ï¼Œå®ç° ResponseFuture æ¥å£ï¼Œé»˜è®¤å“åº” Future å®ç°ç±»ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæ˜¯æ‰€æœ‰ DefaultFuture çš„ç®¡ç†å®¹å™¨ã€‚

**æ„é€ æ–¹æ³•**

````
/**
 * é€šé“é›†åˆ
 * keyï¼šè¯·æ±‚ç¼–å·
 */
private static final Map<Long, Channel> CHANNELS = new ConcurrentHashMap<Long, Channel>();
/**
 * Future é›†åˆ
 * keyï¼šè¯·æ±‚ç¼–å·
 */
private static final Map<Long, DefaultFuture> FUTURES = new ConcurrentHashMap<Long, DefaultFuture>();

/** è¯·æ±‚ç¼–å· */
// invoke id.
private final long id;
/** é€šé“ */
private final Channel channel;
/** è¯·æ±‚ */
private final Request request;
/** è¶…æ—¶ */
private final int timeout;
/** åˆ›å»ºå¼€å§‹æ—¶é—´ */
private final long start = System.currentTimeMillis();
/** å‘é€è¯·æ±‚æ—¶é—´ */
private volatile long sent;
/** å“åº” */
private volatile Response response;
/** å›è°ƒ */
private volatile ResponseCallback callback;

public DefaultFuture(Channel channel, Request request, int timeout) {
    this.channel = channel;
    this.request = request;
    this.id = request.getId();
    this.timeout = timeout > 0 ? timeout : channel.getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);
    // put into waiting map.
    FUTURES.put(id, this);
    CHANNELS.put(id, channel);
}
````

CHANNELS é™æ€å±æ€§ï¼Œé€šé“é›†åˆã€‚é€šè¿‡ #hasFuture(channel) æ–¹æ³•ï¼Œåˆ¤æ–­é€šé“æ˜¯å¦æœ‰æœªç»“æŸçš„è¯·æ±‚ã€‚
FUTURES é™æ€å±æ€§ï¼ŒFuture é›†åˆã€‚
sent å±æ€§ï¼Œå‘é€è¯·æ±‚æ—¶é—´ã€‚å› ä¸ºåœ¨ç›®å‰ Netty Mina ç­‰é€šä¿¡æ¡†æ¶ä¸­ï¼Œå‘é€è¯·æ±‚ä¸€èˆ¬æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤åœ¨ ChannelHandler#sent(channel, message) æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ DefaultFuture#sent(channel, request) é™æ€æ–¹æ³•ï¼Œ
callback å±æ€§ï¼Œå›è°ƒï¼Œé€‚ç”¨äºå¼‚æ­¥è¯·æ±‚ã€‚é€šè¿‡ #setCallback(callback) æ–¹æ³•è®¾ç½®ã€‚

**è·å¾—å€¼**
get(timeout)å‡½æ•°ï¼š
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ #isDone() æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å®Œæˆã€‚è‹¥æœªå®Œæˆï¼ŒåŸºäº Lock + Condition çš„æ–¹å¼ï¼Œå®ç°ç­‰å¾…ã€‚è€Œç­‰å¾…çš„å”¤é†’ï¼Œé€šè¿‡ ChannelHandler#received(channel, message) æ–¹æ³•ï¼Œæ¥æ”¶åˆ°è¯·æ±‚æ—¶æ‰§è¡Œ DefaultFuture#received(channel, response) æ–¹æ³•ã€‚
	1. è·å¾—å¼€å§‹æ—¶é—´ã€‚æ³¨æ„ï¼Œæ­¤å¤„ä½¿ç”¨çš„ä¸æ˜¯ start å±æ€§ã€‚åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œ#get(...) æ–¹æ³•ä¸­ï¼Œä½¿ç”¨çš„æ˜¯é‡æ–°è·å–å¼€å§‹æ—¶é—´ï¼›åå°æ‰«æè°ƒç”¨è¶…æ—¶ä»»åŠ¡ï¼Œä½¿ç”¨çš„æ˜¯ start å±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ#get(timeout) æ–¹æ³•çš„ timeout å‚æ•°ï¼ŒæŒ‡çš„æ˜¯ä»å½“å‰æ—¶åˆ»å¼€å§‹çš„ç­‰å¾…è¶…æ—¶æ—¶é—´ã€‚å½“ç„¶ï¼Œè¿™ä¸å½±å“æœ€ç»ˆçš„ç»“æœï¼Œæœ€ç»ˆ Response æ˜¯ä»€ä¹ˆï¼Œç”±æ˜¯ ChannelHandler#received(channel, message) è¿˜æ˜¯åå°æ‰«æè°ƒç”¨è¶…æ—¶ä»»åŠ¡ï¼Œè°å…ˆè°ƒç”¨ DefaultFuture#received(channel, response) æ–¹æ³•å†³å®šã€‚
	2. è·å¾—é”ã€‚
	3. ç­‰å¾…å®Œæˆæˆ–è¶…æ—¶ã€‚
	4. é‡Šæ”¾é”ã€‚
	5. è‹¥æœªå®Œæˆï¼ŒæŠ›å‡ºè¶…æ—¶å¼‚å¸¸ TimeoutException ã€‚
		1. TimeoutException.phase çš„é˜¶æ®µï¼Œç”± sent > 0 æ¥å†³å®šï¼Œå³ Client æ˜¯å¦å‘é€ç»™ Server ã€‚
		2. getTimeoutMessage(scan) æ–¹æ³•ï¼Œè·å¾—è¶…æ—¶å¼‚å¸¸æç¤ºä¿¡æ¯ã€‚
2. è°ƒç”¨ #returnFromResponse() æ–¹æ³•ï¼Œè¿”å›å“åº”( Response )

**å“åº”ç»“æœ**

````
public static void received(Channel channel, Response response) {
    try {
        // ç§»é™¤ FUTURES
        DefaultFuture future = FUTURES.remove(response.getId());
        // æ¥æ”¶ç»“æœ
        if (future != null) {
            future.doReceived(response);
        } else {
            logger.warn("The timeout response finally returned at " + (new SimpleDateFormat("yyyy-MM-dd HH:mm:ss.SSS").format(new Date())) + ", response " + response + (channel == null ? "" : ", channel: " + channel.getLocalAddress() + " -> " + channel.getRemoteAddress()));
        }
    // ç§»é™¤ CHANNELS
    } finally {
        CHANNELS.remove(response.getId());
    }
}
````

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. ç§»é™¤ FUTURES 
2. è°ƒç”¨ DefaultFuture#doReceived(response) æ–¹æ³•ï¼Œå“åº”ç»“æœã€‚
	1. è·å¾—é”ã€‚
	2. è®¾ç½®å“åº” response ã€‚
	3. è°ƒç”¨ Condition#signal() æ–¹æ³•ï¼Œé€šçŸ¥ï¼Œå”¤é†’ DefaultFuture#get(..) æ–¹æ³•çš„ç­‰å¾…ã€‚
	4. é‡Šæ”¾é”ã€‚
	5. è°ƒç”¨ #invokeCallback(callback) æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚
3. è¶…æ—¶æƒ…å†µï¼Œæ‰“å°å‘Šè­¦æ—¥å¿—ã€‚
4. ç§»é™¤ CHANNELS ã€‚

**è®¾ç½®å›è°ƒ**
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è‹¥å·²å®Œæˆï¼Œè°ƒç”¨ #invokeCallback(callback) æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚
2. è·å¾—é”ã€‚
3. è‹¥æœªå®Œæˆï¼Œè®¾ç½®å›è°ƒ callback å±æ€§ï¼Œç­‰åœ¨ #doReceived(response) æ–¹æ³•ä¸­å†å›è°ƒã€‚
4. æ ‡è®°å·²å®Œæˆã€‚è°ƒç”¨ #invokeCallback(callback) æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚
5. é‡Šæ”¾é”ã€‚

**è°ƒç”¨å›è°ƒ**
å’Œ #returnFromResponse() æ–¹æ³•ï¼Œæƒ…å†µä¸€è‡´ã€‚

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. æ­£å¸¸è¿”å›ï¼Œè°ƒç”¨ ResponseCallback#done(result) æ–¹æ³•ï¼Œå¤„ç†ç»“æœã€‚
2. è¶…æ—¶å¼‚å¸¸ï¼Œè°ƒç”¨ ResponseCallback#caught(e) æ–¹æ³•ï¼Œå¤„ç† TimeoutException å¼‚å¸¸ã€‚
3. å…¶ä»–å¼‚å¸¸ï¼Œè°ƒç”¨ ResponseCallback#caught(e)` æ–¹æ³•ï¼Œå¤„ç† RuntimeException å¼‚å¸¸ã€‚

**åå°æ‰«æè°ƒç”¨è¶…æ—¶ä»»åŠ¡**
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. å·²å®Œæˆï¼Œè·³è¿‡
2. è¶…æ—¶
3. åˆ›å»ºè¶…æ—¶ Response
4. å“åº”ç»“æœ

#### 48.4.3.2 SimpleFuture**** ####
com.alibaba.dubbo.remoting.exchange.support.SimpleFuture ï¼Œå®ç° ResponseFuture æ¥å£ï¼Œç®€å•çš„ Future å®ç°ã€‚

### 48.4.4 MultiMessage ###
com.alibaba.dubbo.remoting.exchange.support.MultiMessage ï¼Œå®ç° Iterable æ¥å£ï¼Œå¤šæ¶ˆæ¯çš„å°è£…ã€‚

## 48.5 Handler ##
### 48.5.1 HeartbeatHandler ###
com.alibaba.dubbo.remoting.exchange.support.header.HeartbeatHandler ï¼Œå®ç° AbstractChannelHandlerDelegate æŠ½è±¡ç±»ï¼Œå¿ƒè·³å¤„ç†å™¨ï¼Œå¤„ç†å¿ƒè·³äº‹ä»¶ã€‚

#### 48.5.1.1 HeartBeatTask ####
com.alibaba.dubbo.remoting.exchange.support.header.HeartBeatTask ï¼Œå®ç° Runnable æ¥å£ï¼Œå¿ƒè·³ä»»åŠ¡ã€‚

channelProvider å±æ€§ï¼Œç”¨äºæŸ¥è¯¢è·å¾—éœ€è¦å¿ƒè·³çš„é€šé“æ•°ç»„ã€‚

**æ‰§è¡Œä»»åŠ¡**
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

1. ã€ä»»åŠ¡ä¸€ã€‘æœ€åè¯»æˆ–å†™çš„æ—¶é—´ï¼Œä»»ä¸€è¶…è¿‡å¿ƒè·³é—´éš” heartbeat ï¼Œå‘é€å¿ƒè·³ã€‚
2. ã€ä»»åŠ¡äºŒã€‘æœ€åè¯»çš„æ—¶é—´ï¼Œè¶…è¿‡å¿ƒè·³è¶…æ—¶æ—¶é—´ heartbeatTimeout ï¼Œåˆ†æˆä¸¤ç§æƒ…å†µï¼š
3. å®¢æˆ·ç«¯ä¾§ï¼Œé‡è¿è¿æ¥æœåŠ¡ç«¯ã€‚
4. æœåŠ¡ç«¯ä¾§ï¼Œå…³é—­å®¢æˆ·ç«¯è¿æ¥ã€‚

### 48.5.2 HeaderExchangeHandler ###
com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeHandlerï¼Œå®ç° ChannelHandlerDelegate æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢å¤„ç†å™¨å®ç°ç±»ã€‚

**æ¥æ”¶æ¶ˆæ¯**
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è®¾ç½®æœ€åçš„è¯»æ—¶é—´ã€‚
2. åˆ›å»º ExchangeChannel å¯¹è±¡ã€‚
3. å¤„ç†è¯·æ±‚( Request)
	1. è°ƒç”¨ #handlerEvent(channel, request) æ–¹æ³•ï¼Œå¤„ç†äº‹ä»¶è¯·æ±‚ã€‚
	2. è°ƒç”¨ #handleRequest(channel, request) æ–¹æ³•ï¼Œå¤„ç†æ™®é€šè¯·æ±‚ï¼ˆéœ€è¦å“åº”ï¼‰ï¼Œå¹¶å°†å“åº”å†™å›è¯·æ±‚æ–¹ã€‚
	3. è°ƒç”¨ ChannelHandler#received(channel, message) æ–¹æ³•ï¼Œå¤„ç†æ™®é€šè¯·æ±‚ï¼ˆæ— éœ€å“åº”ï¼‰ã€‚
4. è°ƒç”¨ #handleResponse(channel, message) æ–¹æ³•ï¼Œå¤„ç†å“åº”ã€‚
5. å¤„ç† String çš„æƒ…å†µ
	1. å®¢æˆ·ç«¯ä¾§ï¼Œä¸æ”¯æŒ String çš„æƒ…å†µã€‚
	2. æœåŠ¡ç«¯ä¾§ï¼Œç›®å‰ä»…æœ‰ telnet å‘½ä»¤çš„æƒ…å†µï¼Œè°ƒç”¨ TelnetHandler#telnet(channel, message) æ–¹æ³•ï¼Œè·å¾— telnet å‘½ä»¤çš„ç»“æœï¼Œå¹¶å“åº”ç»™ telnet å®¢æˆ·ç«¯ã€‚
6. å‰©ä½™çš„æƒ…å†µï¼Œè°ƒç”¨ ChannelHandler#received(channel, message) æ–¹æ³•ï¼Œå¤„ç†ã€‚
7. ç§»é™¤ ExchangeChannel å¯¹è±¡ï¼Œè‹¥å·²æ–­å¼€ã€‚

**å‘ç”Ÿå¼‚å¸¸**
å½“å‘ç”Ÿ ExecutionException å¼‚å¸¸ï¼Œè¿”å›å¼‚å¸¸å“åº”( Response )ã€‚ç›®å‰ä¼šå‘ç”Ÿ ExecutionException çš„æƒ…å†µï¼Œå¹¶ä¸”ç¬¦åˆæäº¤

### 48.5.3 ExchangeHandler ###
com.alibaba.dubbo.remoting.exchange.ExchangeHandler ï¼Œç»§æ‰¿ ChannelHandler å’Œ TelnetHandler æ¥å£ï¼Œä¿¡æ¯äº¤æ¢å¤„ç†å™¨æ¥å£ã€‚
- æ³¨æ„ï¼Œè¿”å›çš„æ˜¯è¯·æ±‚ç»“æœã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šæ–‡çœ‹åˆ°çš„ï¼Œå°†è¯·æ±‚ç»“æœï¼Œè®¾ç½®åˆ° Response.mResult å±æ€§ä¸­ã€‚

#### 48.5.3.1 ExchangeHandlerAdapter ####

com.alibaba.dubbo.remoting.exchange.support.ExchangeHandlerAdapter ï¼Œå®ç° ExchangeHandler æ¥å£ï¼Œç»§æ‰¿ TelnetHandlerAdapter æŠ½è±¡ç±»ï¼Œä¿¡æ¯äº¤æ¢å¤„ç†å™¨é€‚é…å™¨æŠ½è±¡ç±»ã€‚

åœ¨ DubboProtocol ã€ThirftProtocol ä¸­ï¼Œéƒ½ä¼šåŸºäº ExchangeHandlerAdapter å®ç°è‡ªå·±çš„å¤„ç†å™¨ï¼Œå¤„ç†è¯·æ±‚ï¼Œè¿”å›ç»“æœã€‚

### 48.5.4 Replier ###
//  todo ç›®å‰ä»…ç”¨äºp2p

## 48.6 Exchanger ##
com.alibaba.dubbo.remoting.exchange.Exchanger ï¼Œæ•°æ®äº¤æ¢è€…æ¥å£ã€‚
Exchanger å’Œ Transporter ç±»ä¼¼ã€‚

- SPI(HeaderExchanger.NAME) æ³¨è§£ï¼ŒDubbo SPI æ‹“å±•ç‚¹ï¼Œé»˜è®¤ä¸º "header"ï¼Œå³ HeaderExchanger ã€‚
- Adaptive({Constants.EXCHANGER_KEY}) æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Server å®ç°ï¼Œä½¿ç”¨ URL.exchanger å±æ€§ã€‚
- Adaptive({Constants.EXCHANGER_KEY}) æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Client å®ç°ï¼Œä½¿ç”¨ URL.exchanger å±æ€§ã€‚

### 48.6.1 HeaderExchanger ###
com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchanger ï¼Œå®ç° Exchanger æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„ä¿¡æ¯äº¤æ¢è€…å®ç°ç±»ã€‚

### 48.6.2 Exchangers ###
Exchangers å’Œ Transporters ç±»ä¼¼ã€‚
com.alibaba.dubbo.remoting.Transporters ï¼Œæ•°æ®äº¤æ¢è€…é—¨é¢ç±»

## 48.7 ExchangeCodec ##
com.alibaba.dubbo.remoting.exchange.codec.ExchangeCodec ï¼Œç»§æ‰¿ TelnetCodec ç±»ï¼Œä¿¡æ¯äº¤æ¢ç¼–è§£ç å™¨ã€‚

![](/picture/dubbo-nio-exchanger-codec.png)


- åŸºäºæ¶ˆæ¯é•¿åº¦çš„æ–¹å¼ï¼Œåšæ¯æ¡æ¶ˆæ¯çš„ç²˜åŒ…æ‹†åŒ…å¤„ç†ã€‚
- Header éƒ¨åˆ†ï¼Œåè®®å¤´ï¼Œé€šè¿‡ Codec ç¼–è§£ç ã€‚Bits ä½å¦‚ä¸‹ï¼š
	- [0, 15]ï¼šMagic Number
	- [16, 20]ï¼šSerialization ç¼–å·ã€‚
	- [21]ï¼ševent æ˜¯å¦ä¸ºäº‹ä»¶ã€‚
	- [22]ï¼štwoWay æ˜¯å¦éœ€è¦å“åº”ã€‚
	- [23]ï¼šæ˜¯è¯·æ±‚è¿˜æ˜¯å“åº”ã€‚
	- [24 - 31]ï¼šstatus çŠ¶æ€ã€‚
	- [32 - 95]ï¼šid ç¼–å·ï¼ŒLong å‹ã€‚
	- [96 - 127]ï¼šBody çš„é•¿åº¦ã€‚é€šè¿‡è¯¥é•¿åº¦ï¼Œè¯»å– Body ã€‚
- Body éƒ¨åˆ†ï¼Œåè®®ä½“ï¼Œé€šè¿‡ Serialization åºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚

**å±æ€§**

````
// header length.
protected static final int HEADER_LENGTH = 16;
// magic header.
protected static final short MAGIC = (short) 0xdabb;
protected static final byte MAGIC_HIGH = Bytes.short2bytes(MAGIC)[0];
protected static final byte MAGIC_LOW = Bytes.short2bytes(MAGIC)[1];
// message flag.
protected static final byte FLAG_REQUEST = (byte) 0x80; // 128
protected static final byte FLAG_TWOWAY = (byte) 0x40; // 64
protected static final byte FLAG_EVENT = (byte) 0x20; // 32
protected static final int SERIALIZATION_MASK = 0x1f; // 31
````
HEADER_LENGTH é™æ€å±æ€§ï¼ŒHeader æ€»é•¿åº¦ï¼Œ16 Bytes = 128 Bits ã€‚

**ç¼–ç **
åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è°ƒç”¨ #encodeRequest(channel, buffer, request) æ–¹æ³•ï¼Œç¼–ç è¯·æ±‚ã€‚
2. è°ƒç”¨ #encodeResponse(channel, buffer, response) æ–¹æ³•ï¼Œç¼–ç å“åº”ã€‚
3. è°ƒç”¨ TelnetCodec#encode(channel, buffer, msg) æ–¹æ³•ï¼Œç¼–ç  Telnet å‘½ä»¤çš„ç»“æœã€‚

encodeRequest(channel, buffer, request) æ–¹æ³•åŸºæœ¬æµç¨‹ï¼š
1. Header éƒ¨åˆ†ï¼Œå…ˆå†™å…¥ header æ•°ç»„ï¼Œå†å†™å…¥ Buffer ä¸­ã€‚
2. Body éƒ¨åˆ†ï¼Œä½¿ç”¨ Serialization åºåˆ—åŒ– Request.data ï¼Œå†™å…¥åˆ° Buffer ä¸­ã€‚
3. è°ƒç”¨ #checkPayload(channel, len) æ–¹æ³•ï¼Œæ ¡éªŒ Body å†…å®¹çš„é•¿åº¦

- ä¸ºä»€ä¹ˆ Buffer å…ˆå†™å…¥äº† Body ï¼Œå†å†™å…¥ Header å‘¢ï¼Ÿå› ä¸º Header ä¸­ï¼Œé‡Œé¢ [96 - 127] çš„ Body é•¿åº¦ï¼Œéœ€è¦åºåˆ—åŒ–åæ‰å¾—åˆ°ã€‚

**è§£ç **

åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š
1. è¯»å– header æ•°ç»„ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ Math.min(readable, HEADER_LENGTH) ï¼Œä¼˜å…ˆè€ƒè™‘è§£æ Dubbo åè®®ã€‚
2. è°ƒç”¨ #decode(channel, buffer, readable, header) æ–¹æ³•ï¼Œè§£ç ã€‚
3. åŸºäºæ¶ˆæ¯é•¿åº¦çš„æ–¹å¼ï¼Œæ‹†åŒ…ã€‚
4. è°ƒç”¨ #decodeBody(channel, is, header) æ–¹æ³•ï¼Œè§£æ Header + Body ï¼Œæ ¹æ®æƒ…å†µï¼Œè¿”å› Request æˆ– Reponse ã€‚ğŸ™‚ é€»è¾‘ä¸Šï¼Œæ˜¯ #encodeRequest(...) å’Œ #encodeResponse(...) æ–¹æ³•çš„åå‘ï¼Œ
5. skip æœªè¯»å®Œçš„æµ

----

# 49 NIO æœåŠ¡å™¨ï¼ˆäº”ï¼‰ä¹‹ Buffer å±‚ #

dubbo-remoting-api æ¨¡å—ï¼Œ buffer åŒ…ï¼ŒBuffer å±‚ã€‚
Buffer åœ¨ NIO æ¡†æ¶ä¸­ï¼Œæ‰®æ¼”éå¸¸é‡è¦çš„è§’è‰²ï¼ŒåŸºæœ¬æ¯ä¸ªåº“éƒ½æä¾›äº†è‡ªå·±çš„ Buffer å®ç°ï¼Œä¾‹å¦‚ï¼š
- Java NIO çš„ java.nio.ByteBuffer
- Mina çš„ org.apache.mina.core.buffer.IoBuffer
- Netty4 çš„ io.netty.buffer.ByteBuf

åœ¨ dubbo-remoting-api çš„ buffer åŒ…ä¸­ï¼Œä¸€æ–¹é¢å®šä¹‰äº† ChannelBuffer å’Œ ChannelBufferFactory çš„æ¥å£ï¼ŒåŒæ—¶æä¾›äº†å¤šç§é»˜è®¤çš„å®ç°ã€‚

## 49.1 ChannelBuffer ##
com.alibaba.dubbo.remoting.buffer.ChannelBuffer ï¼Œå®ç° Comparable æ¥å£ï¼Œé€šé“ Buffer æ¥å£ã€‚

ChannelBuffer åœ¨æ¥å£æ–¹æ³•çš„å®šä¹‰ä¸Šï¼Œä¸»è¦å‚è€ƒäº† Netty çš„ ByteBuf è¿›è¡Œè®¾è®¡ï¼Œæ‰€ä»¥æ¥å£å’Œæ³¨é‡ŠåŸºæœ¬ä¸€è‡´

ç‹¬æœ‰çš„æ¥å£æ–¹æ³• #factory() æ–¹æ³•ï¼Œç”¨äºé€»è¾‘ä¸­ï¼Œéœ€è¦åˆ›å»º ChannelBuffer çš„æƒ…å†µã€‚

### 49.1.1 AbstractChannelBuffer ###
com.alibaba.dubbo.remoting.buffer.AbstractChannelBuffer ï¼Œå®ç° ChannelBuffer æ¥å£ï¼Œé€šé“ Buffer æŠ½è±¡ç±»ã€‚

**æ„é€ æ–¹æ³•**
````
/** è¯»å–ä½ç½® */
private int readerIndex;
/** å†™å…¥ä½ç½® */
private int writerIndex;
/** æ ‡è®°çš„è¯»å–ä½ç½® */
private int markedReaderIndex;
/** æ ‡è®°çš„å†™å…¥ä½ç½® */
private int markedWriterIndex;
````

**å®ç°æ–¹æ³•**
åœ¨ AbstractChannelBuffer å®ç°çš„æ–¹æ³•ï¼Œéƒ½æ˜¯é‡è½½çš„æ–¹æ³•ï¼ŒçœŸæ­£å®è´¨çš„æ–¹æ³•ï¼Œéœ€è¦å­ç±»æ¥å®ç°ã€‚


### 49.1.2 ByteBufferBackedChannelBuffer ###
com.alibaba.dubbo.remoting.buffer.ByteBufferBackedChannelBuffer ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäº java.nio.ByteBuffer çš„ Buffer å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
````
/**
 * buffer
 * java.nio.ByteBuffer
 */
private final ByteBuffer buffer;
/** å®¹é‡ */
private final int capacity;

public ByteBufferBackedChannelBuffer(ByteBuffer buffer) {
    if (buffer == null) {
        throw new NullPointerException("buffer");
    }
    // buffer
    this.buffer = buffer.slice();
    // å®¹é‡
    capacity = buffer.remaining();
    // è®¾ç½® `writerIndex`
    writerIndex(capacity);
}

public ByteBufferBackedChannelBuffer(ByteBufferBackedChannelBuffer buffer) {
    // buffer
    this.buffer = buffer.buffer;
    // å®¹é‡
    capacity = buffer.capacity;
    // è®¾ç½® `writerIndex` `readerIndex`
    setIndex(buffer.readerIndex(), buffer.writerIndex());
}
````
**å·¥å‚**
å¯¹åº”çš„å·¥å‚æ˜¯ DirectChannelBufferFactory æˆ– HeapChannelBufferFactory ã€‚

### 49.1.3 HeapChannelBuffer ###
com.alibaba.dubbo.remoting.buffer.HeapChannelBuffer ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäºå­—èŠ‚æ•°ç»„çš„ Buffer å®ç°ç±»ã€‚

**å·¥å‚**
å¯¹åº”çš„å·¥å‚æ˜¯ HeapChannelBufferFactory ã€‚

### 49.1.4 DynamicChannelBuffer ###
com.alibaba.dubbo.remoting.buffer.DynamicChannelBuffer ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäºåŠ¨æ€çš„ Buffer å®ç°ç±»ã€‚æˆ–è€…è¯´ï¼ŒåŸºäºä¼ å…¥çš„ ChannelBufferFactory çš„ Buffer å®ç°ç±»ã€‚

## 49.2 ChannelBuffers ##
com.alibaba.dubbo.remoting.buffer.ChannelBuffers ï¼ŒBuffer å·¥å…·ç±»ï¼Œæä¾›åˆ›å»ºã€æ¯”è¾ƒ ChannelBuffer ç­‰å…¬ç”¨æ–¹æ³•ã€‚

## 49.3 ChannelBufferFactory ##
com.alibaba.dubbo.remoting.buffer.ChannelBufferFactory ï¼Œé€šé“ Buffer å·¥å‚æ¥å£ã€‚

### 49.3.1 DirectChannelBufferFactory ###
com.alibaba.dubbo.remoting.buffer.DirectChannelBufferFactory ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º DirectChannelBuffer çš„å·¥å‚ã€‚

### HeapChannelBufferFactory ###
com.alibaba.dubbo.remoting.buffer.HeapChannelBufferFactory ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º HeapChannelBufferFactory çš„å·¥å‚ã€‚

## 49.4 IO ##
å®é™… IO æ“ä½œï¼Œæ˜¯åŸºäº InputStream å’Œ OutputStream 

### 49.4.1 ChannelBufferInputStream ###
com.alibaba.dubbo.remoting.buffer.ChannelBufferInputStream ï¼Œå®ç° InputStream æ¥å£

### 49.4.2 ChannelBufferOutputStream ###
com.alibaba.dubbo.remoting.buffer.ChannelBufferOutputStream ï¼Œå®ç° OutputStream æ¥å£






-----